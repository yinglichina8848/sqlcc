# LogEntry类详细设计

## 概述

LogEntry类表示事务操作的日志条目，用于实现预写日志(WAL)机制。它记录了事务执行的每个操作的详细信息，确保在系统崩溃时能够恢复数据一致性。

## 类定义

```cpp
struct LogEntry {
    TransactionId txn_id;
    std::string table_name;
    std::string operation;
    size_t record_id;
    std::chrono::system_clock::time_point timestamp;
    std::vector<char> old_data;
    std::vector<char> new_data;
};
```

## 成员变量

### TransactionId txn_id

事务标识符：

1. 标识产生该日志条目的事务
2. 用于日志组织和事务回滚

### std::string table_name

表名：

1. 记录操作涉及的表
2. 用于恢复时定位数据

### std::string operation

操作类型：

1. 记录执行的操作类型，如"INSERT"、"UPDATE"、"DELETE"
2. 用于恢复时执行相应的逆向操作

### size_t record_id

记录ID：

1. 标识操作涉及的具体记录
2. 用于定位和恢复特定记录

### std::chrono::system_clock::time_point timestamp

时间戳：

1. 记录操作执行的时间
2. 用于日志排序和恢复顺序控制

### std::vector<char> old_data

旧数据：

1. 记录操作前的数据状态
2. 用于UPDATE和DELETE操作的回滚

### std::vector<char> new_data

新数据：

1. 记录操作后的数据状态
2. 用于INSERT操作的回滚

## WAL机制

### 预写日志

1. 在执行任何数据修改操作前，先将操作日志写入日志文件
2. 确保日志写入成功后才执行实际的数据修改
3. 在系统崩溃恢复时，通过日志重做或撤销操作来保证数据一致性

### 日志内容

1. **事务开始日志**：记录事务的开始
2. **操作日志**：记录每个数据修改操作的详细信息
3. **事务提交日志**：记录事务的提交
4. **事务回滚日志**：记录事务的回滚

### 日志格式

1. **事务ID**：标识产生日志的事务
2. **操作类型**：标识执行的操作类型
3. **表名和记录ID**：标识操作涉及的数据位置
4. **旧数据和新数据**：提供恢复所需的数据信息
5. **时间戳**：记录操作执行的时间

## 恢复机制

### 崩溃恢复

1. 分析日志文件，确定崩溃时未完成的事务
2. 对已提交但未写入磁盘的事务进行重做(REDO)
3. 对未提交的事务进行撤销(UNDO)

### 重做(REDO)

1. 找到所有已提交的事务
2. 重新执行这些事务的所有操作
3. 确保所有已提交的更改都反映在数据库中

### 撤销(UNDO)

1. 找到所有未提交的事务
2. 根据日志中的旧数据撤销这些事务的操作
3. 确保未提交的更改不会影响数据库的一致性

## 性能优化

### 批量写入

1. 将多个日志条目批量写入磁盘
2. 减少磁盘I/O操作次数
3. 提高日志写入性能

### 内存缓冲

1. 使用内存缓冲区暂存日志条目
2. 定期将缓冲区内容刷新到磁盘
3. 平衡性能和数据安全性

### 异步写入

1. 使用单独的线程处理日志写入
2. 避免日志写入阻塞主操作线程
3. 提高系统整体性能