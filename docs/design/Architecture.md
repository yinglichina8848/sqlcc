# SQLCC 数据库管理系统架构设计

## 项目概述

SQLCC (Simple Compact Course Computer) 是一个轻量级的关系型数据库管理系统，旨在通过简洁的设计实现数据库核心功能，同时为学习者和开发者提供一个清晰的数据库内部实现参考。该项目采用模块化设计，每个模块都有明确的功能边界和性能要求，便于独立开发和测试。

## 模块功能清单

| 模块 | 核心功能要求 | 自动化测试基准 | 
|------|--------------|----------------| 
| **存储引擎**  | 8KB定长页，空间管理，定/变长记录 | 10万次INSERT后，文件体积≤1.2倍理论值 | 
| **SQL解析**  | 解析指定6种SQL语句，生成正确AST | 全部测试SQL解析通过，AST打印正确 | 
| **索引**  | B+树，单字段唯一，支持=, >, <, 范围查询 | 100万主键下，点查页面访问≤4次 | 
| **CRUD**  | 插入、点查、范围扫描、更新、删除 | 1-10万行数据，单操作耗时<5ms (SSD) | 
| **事务**  | WAL(预写日志) + 两阶段锁，读已提交隔离级别 | 10线程并发转账1000次，无丢失更新 | 
| **工具**  | 交互式命令行isql，支持-f执行脚本 | 执行1000行脚本无崩溃 | 

## 模块关系与设计

### 存储引擎 (Storage Engine)

**Why**: 存储引擎是数据库系统的核心基础，负责数据的持久化存储和高效访问。它是所有上层功能的基础，决定了数据库的基本性能特征。

**What**: 实现8KB定长页面的存储管理，支持定长和变长记录的存储，提供高效的空间分配和回收机制。

**Who**: 由数据库核心开发者实现，为上层模块提供基础存储服务。

**How**: 
- 采用页面式存储架构，每页8KB
- 实现页面分配器管理空闲空间
- 支持记录的定长和变长存储格式
- 提供页面缓存接口减少磁盘I/O

**性能要求合理性**: 10万次INSERT后文件体积≤1.2倍理论值是合理的，它允许合理的碎片和元数据开销，同时避免了空间浪费。

### SQL解析 (SQL Parser)

**Why**: SQL解析器是用户与数据库交互的桥梁，将人类可读的SQL语句转换为机器可理解的内部表示，是数据库执行SQL的第一步。

**What**: 解析6种基本SQL语句(SELECT, INSERT, UPDATE, DELETE, CREATE, DROP)，生成抽象语法树(AST)。

**Who**: 由查询处理模块开发者实现，为查询优化器和执行器提供结构化查询表示。

**How**:
- 使用词法分析器和语法分析器分离设计
- 采用递归下降解析算法
- 构建AST节点表示SQL语句结构
- 提供AST打印和验证功能

**性能要求合理性**: 解析正确性是首要目标，性能要求相对宽松，因为解析开销通常远小于执行开销。

### 索引 (Index)

**Why**: 索引是提升查询性能的关键技术，通过预排序的数据结构加速数据检索，是现代数据库不可或缺的组件。

**What**: 实现B+树索引结构，支持单字段唯一索引，提供点查询和范围查询功能。

**Who**: 由存储和查询优化开发者实现，为查询执行器提供高效数据访问路径。

**How**:
- 实现B+树节点结构和分裂合并算法
- 支持键值对的插入、删除和查找
- 实现范围查询的迭代器接口
- 与存储引擎页面系统集成

**性能要求合理性**: 100万主键下点查页面访问≤4次是合理的，这对应于3-4层高的B+树，是典型数据库系统的设计目标。

### CRUD (Create, Read, Update, Delete)

**Why**: CRUD操作是数据库的基本数据操作接口，是应用程序与数据库交互的主要方式，直接决定了用户体验和系统性能。

**What**: 实现数据的插入、点查询、范围扫描、更新和删除功能。

**Who**: 由查询执行器开发者实现，为用户提供完整的数据操作接口。

**How**:
- 集成存储引擎和索引模块
- 实现查询计划和执行引擎
- 支持事务上下文下的操作
- 提供结果集管理和游标功能

**性能要求合理性**: 1-10万行数据下单操作<5ms(SSD)是合理的，这对应于现代数据库系统在SSD上的典型性能表现。

### 事务 (Transaction)

**Why**: 事务是数据库保证数据一致性和并发控制的核心机制，是关系型数据库区别于简单文件系统的关键特性。

**What**: 实现WAL(预写日志)和两阶段锁协议，提供读已提交隔离级别。

**Who**: 由并发控制开发者实现，为上层操作提供ACID保证。

**How**:
- 实现WAL日志记录和恢复机制
- 构建锁管理器和死锁检测
- 设计事务上下文和状态管理
- 集成到CRUD操作中

**性能要求合理性**: 10线程并发转账1000次无丢失更新是合理的一致性测试，验证了并发控制的正确性。

### 工具 (Utilities)

**Why**: 用户工具是数据库系统与外部世界交互的界面，提供了管理和使用数据库的便捷方式，是系统可用性的重要组成部分。

**What**: 实现交互式命令行工具isql，支持SQL交互和脚本执行。

**Who**: 由工具和接口开发者实现，为终端用户提供数据库访问接口。

**How**:
- 实现命令行解析和交互循环
- 提供SQL执行和结果格式化
- 支持脚本文件执行
- 集成数据库连接和会话管理

**性能要求合理性**: 执行1000行脚本无崩溃是基本的稳定性要求，确保工具的可靠性。

## 模块间关系

```
┌─────────────────────────────────────────────────────────────┐
│                        用户工具 (isql)                        │
└─────────────────────┬───────────────────────────────────────┘
                      │ SQL语句
┌─────────────────────▼───────────────────────────────────────┐
│                     SQL解析器                                │
└─────────────────────┬───────────────────────────────────────┘
                      │ AST
┌─────────────────────▼───────────────────────────────────────┐
│                     CRUD操作                                │
└───────┬─────────────┬─────────────┬─────────────────────────┘
        │             │             │
        │             │             │
┌───────▼──────┐ ┌────▼────┐ ┌──────▼──────┐
│   事务管理   │ │  索引   │ │  存储引擎   │
└──────┬───────┘ └─────────┘ └──────┬───────┘
       │                          │
       │                          │
       └──────────────┬───────────┘
                      │
              ┌───────▼───────┐
              │   磁盘文件     │
              └───────────────┘
```

1. **用户工具**是系统的入口，接收用户输入的SQL语句或脚本
2. **SQL解析器**将SQL语句转换为抽象语法树(AST)
3. **CRUD操作**根据AST执行具体的数据操作
4. **事务管理**提供ACID保证，通过WAL和锁机制确保数据一致性
5. **索引**加速数据访问，提供高效的数据查找路径
6. **存储引擎**负责数据的物理存储和页面管理
7. **磁盘文件**是数据的最终持久化存储

## 性能要求合理性分析

### 存储性能要求

1. **空间效率**：10万次INSERT后文件体积≤1.2倍理论值
   - 合理性：允许20%的额外空间用于元数据、索引和碎片，是实际数据库系统的常见设计目标
   - 实现思路：紧凑存储格式、延迟空间回收、批量更新元数据

2. **查询性能**：100万主键下点查页面访问≤4次
   - 合理性：对应3-4层高的B+树，是平衡查询性能和维护成本的合理选择
   - 实现思路：优化B+树节点填充率、实现缓存友好的节点布局

3. **操作延迟**：1-10万行数据，单操作耗时<5ms (SSD)
   - 合理性：现代SSD随机访问延迟约0.1ms，5ms允许50次页面访问，足够完成复杂操作
   - 实现思路：批量I/O操作、异步写入、优化锁粒度

### 并发性能要求

1. **并发正确性**：10线程并发转账1000次，无丢失更新
   - 合理性：中等并发度下的正确性验证，确保事务机制的有效性
   - 实现思路：细粒度锁、死锁检测、乐观并发控制

### 可靠性要求

1. **工具稳定性**：执行1000行脚本无崩溃
   - 合理性：基本的稳定性要求，确保工具的可用性
   - 实现思路：异常处理、资源管理、输入验证

## 初步实现思路

### 存储引擎实现

1. **页面管理**：
   - 设计页面头部结构，包含页面类型、空闲空间等信息
   - 实现页面分配器，管理空闲页面链表
   - 支持页面内记录的定长和变长存储格式

2. **记录管理**：
   - 设计记录头部，包含记录长度、标志位等信息
   - 实现记录的插入、删除和更新操作
   - 支持页面内记录的紧凑存储和碎片整理

3. **空间管理**：
   - 实现扩展和收缩机制，动态调整数据库文件大小
   - 设计空闲空间管理算法，减少空间碎片
   - 提供空间使用统计和监控功能

### SQL解析实现

1. **词法分析**：
   - 定义SQL关键字、标识符、操作符等词法单元
   - 实现有限状态机进行词法分析
   - 处理注释、字符串和特殊字符

2. **语法分析**：
   - 设计SQL语法的BNF表示
   - 实现递归下降解析器
   - 构建抽象语法树(AST)节点结构

3. **语义分析**：
   - 验证表名、字段名的存在性
   - 检查类型兼容性
   - 生成执行计划的初步表示

### 索引实现

1. **B+树结构**：
   - 设计内部节点和叶子节点的结构
   - 实现节点的分裂和合并算法
   - 优化节点大小以适应页面边界

2. **索引操作**：
   - 实现键值对的插入、删除和查找
   - 支持范围查询的迭代器接口
   - 处理重复键和唯一约束

3. **并发控制**：
   - 实现B+树的 latch-coupling 技术
   - 设计死锁避免机制
   - 支持多版本并发控制(MVCC)的扩展

### CRUD实现

1. **查询执行**：
   - 设计查询执行器的基本框架
   - 实现基于迭代器的执行模型
   - 支持查询计划的优化和执行

2. **数据操作**：
   - 实现插入、更新、删除的具体逻辑
   - 处理索引的同步更新
   - 支持批量操作和事务提交

3. **结果处理**：
   - 设计结果集的表示和管理
   - 实现游标和分页功能
   - 支持不同格式的结果输出

### 事务实现

1. **日志系统**：
   - 设计WAL日志的格式和结构
   - 实现日志的写入、检查点和恢复
   - 优化日志写入性能和可靠性

2. **并发控制**：
   - 实现两阶段锁协议
   - 设计锁管理器和死锁检测
   - 支持不同隔离级别的扩展

3. **事务管理**：
   - 设计事务上下文和状态机
   - 实现事务的提交、回滚和恢复
   - 处理嵌套事务和保存点

### 工具实现

1. **命令行界面**：
   - 设计交互式命令行循环
   - 实现命令历史和自动补全
   - 提供帮助和错误提示

2. **脚本执行**：
   - 支持SQL脚本的批量执行
   - 实现错误处理和恢复机制
   - 提供执行进度和统计信息

3. **连接管理**：
   - 设计数据库连接接口
   - 支持连接池和会话管理
   - 处理认证和权限控制

## 扩展性考虑

1. **模块化设计**：每个模块有清晰的接口和职责，便于独立开发和测试
2. **插件架构**：支持自定义存储引擎、索引类型和函数扩展
3. **配置系统**：提供丰富的配置选项，适应不同应用场景
4. **监控接口**：内置性能监控和诊断功能，便于调优和故障排除

## 总结

SQLCC数据库管理系统的架构设计遵循了模块化、可扩展和性能优先的原则。通过明确各模块的功能边界和性能要求，为项目的实现提供了清晰的指导。合理的性能基准确保了系统的实用性，而模块间清晰的依赖关系降低了开发复杂度。这个架构为数据库系统的学习和研究提供了一个良好的起点，同时保留了足够的扩展空间以适应未来的需求。