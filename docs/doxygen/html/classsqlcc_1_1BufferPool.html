<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SQLCC: sqlcc::BufferPool Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">SQLCC<span id="projectnumber">&#160;0.2.3</span>
   </div>
   <div id="projectbrief">Simple C++ Database Storage Engine</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('classsqlcc_1_1BufferPool.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pri-methods">Private Member Functions</a> &#124;
<a href="#pri-attribs">Private Attributes</a> &#124;
<a href="classsqlcc_1_1BufferPool-members.html">List of all members</a>  </div>
  <div class="headertitle"><div class="title">sqlcc::BufferPool Class Reference</div></div>
</div><!--header-->
<div class="contents">

<p>生产就绪简化BufferPool类 (v0.4.7版本)  
 <a href="classsqlcc_1_1BufferPool.html#details">More...</a></p>

<p><code>#include &lt;<a class="el" href="buffer__pool_8h_source.html">buffer_pool.h</a>&gt;</code></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Classes</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structsqlcc_1_1BufferPool_1_1Metrics.html">Metrics</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structsqlcc_1_1BufferPool_1_1Stats.html">Stats</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-methods" name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:ab0fcbbceb869174398fa7e203dc51ce3" id="r_ab0fcbbceb869174398fa7e203dc51ce3"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#ab0fcbbceb869174398fa7e203dc51ce3">BufferPool</a> (<a class="el" href="classsqlcc_1_1DiskManager.html">DiskManager</a> *disk_manager, size_t pool_size, <a class="el" href="classsqlcc_1_1ConfigManager.html">ConfigManager</a> &amp;config_manager)</td></tr>
<tr class="separator:ab0fcbbceb869174398fa7e203dc51ce3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a501156956e4b91d0134d1195a733c685" id="r_a501156956e4b91d0134d1195a733c685"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a501156956e4b91d0134d1195a733c685">BufferPool</a> (const <a class="el" href="classsqlcc_1_1BufferPool.html">BufferPool</a> &amp;)=delete</td></tr>
<tr class="separator:a501156956e4b91d0134d1195a733c685"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a792661db8aaf7cf60fcb9904340f9c5d" id="r_a792661db8aaf7cf60fcb9904340f9c5d"><td class="memItemLeft" align="right" valign="top"><a class="el" href="classsqlcc_1_1BufferPool.html">BufferPool</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a792661db8aaf7cf60fcb9904340f9c5d">operator=</a> (const <a class="el" href="classsqlcc_1_1BufferPool.html">BufferPool</a> &amp;)=delete</td></tr>
<tr class="separator:a792661db8aaf7cf60fcb9904340f9c5d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aeb26c2ec50ee4c23e4a214fc8304ad79" id="r_aeb26c2ec50ee4c23e4a214fc8304ad79"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#aeb26c2ec50ee4c23e4a214fc8304ad79">~BufferPool</a> ()</td></tr>
<tr class="separator:aeb26c2ec50ee4c23e4a214fc8304ad79"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8c2da3780c6ec635bee229cae90ccb83" id="r_a8c2da3780c6ec635bee229cae90ccb83"><td class="memItemLeft" align="right" valign="top"><a class="el" href="classsqlcc_1_1Page.html">Page</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a8c2da3780c6ec635bee229cae90ccb83">FetchPage</a> (int32_t page_id)</td></tr>
<tr class="separator:a8c2da3780c6ec635bee229cae90ccb83"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a19218f84859b349a66aeb7896b44a9f9" id="r_a19218f84859b349a66aeb7896b44a9f9"><td class="memItemLeft" align="right" valign="top">std::vector&lt; <a class="el" href="classsqlcc_1_1Page.html">Page</a> * &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a19218f84859b349a66aeb7896b44a9f9">BatchFetchPages</a> (const std::vector&lt; int32_t &gt; &amp;page_ids)</td></tr>
<tr class="separator:a19218f84859b349a66aeb7896b44a9f9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5a697f8e177b9f1d22e95d2a6472dbfb" id="r_a5a697f8e177b9f1d22e95d2a6472dbfb"><td class="memItemLeft" align="right" valign="top"><a class="el" href="classsqlcc_1_1Page.html">Page</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a5a697f8e177b9f1d22e95d2a6472dbfb">NewPage</a> (int32_t *page_id)</td></tr>
<tr class="separator:a5a697f8e177b9f1d22e95d2a6472dbfb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac9b37e03a56a791dd483858d76ad4299" id="r_ac9b37e03a56a791dd483858d76ad4299"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#ac9b37e03a56a791dd483858d76ad4299">UnpinPage</a> (int32_t page_id, bool is_dirty)</td></tr>
<tr class="separator:ac9b37e03a56a791dd483858d76ad4299"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acdce915c78dc7e4db0c56f0593803e73" id="r_acdce915c78dc7e4db0c56f0593803e73"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#acdce915c78dc7e4db0c56f0593803e73">FlushPage</a> (int32_t page_id)</td></tr>
<tr class="separator:acdce915c78dc7e4db0c56f0593803e73"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a72b69be11e8c034a712b605c3741b09f" id="r_a72b69be11e8c034a712b605c3741b09f"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a72b69be11e8c034a712b605c3741b09f">FlushAllPages</a> ()</td></tr>
<tr class="separator:a72b69be11e8c034a712b605c3741b09f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5e4a88f07f583dcecbf209dbbe1ad8e4" id="r_a5e4a88f07f583dcecbf209dbbe1ad8e4"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a5e4a88f07f583dcecbf209dbbe1ad8e4">DeletePage</a> (int32_t page_id)</td></tr>
<tr class="separator:a5e4a88f07f583dcecbf209dbbe1ad8e4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9e09cd1844c8952220c2cef60d8f8932" id="r_a9e09cd1844c8952220c2cef60d8f8932"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a9e09cd1844c8952220c2cef60d8f8932">PrefetchPage</a> (int32_t page_id)</td></tr>
<tr class="separator:a9e09cd1844c8952220c2cef60d8f8932"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a273a6bdecc152b7c06e34d949d5475a1" id="r_a273a6bdecc152b7c06e34d949d5475a1"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a273a6bdecc152b7c06e34d949d5475a1">BatchPrefetchPages</a> (const std::vector&lt; int32_t &gt; &amp;page_ids)</td></tr>
<tr class="separator:a273a6bdecc152b7c06e34d949d5475a1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae8380c66c015d26bf1df75981312bd55" id="r_ae8380c66c015d26bf1df75981312bd55"><td class="memItemLeft" align="right" valign="top">std::unordered_map&lt; std::string, double &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#ae8380c66c015d26bf1df75981312bd55">GetStats</a> () const</td></tr>
<tr class="separator:ae8380c66c015d26bf1df75981312bd55"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adb70334238fa82ee756e810081158641" id="r_adb70334238fa82ee756e810081158641"><td class="memItemLeft" align="right" valign="top">size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#adb70334238fa82ee756e810081158641">GetPoolSize</a> () const</td></tr>
<tr class="separator:adb70334238fa82ee756e810081158641"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aba069be10dee7e9c2a4520be1398b788" id="r_aba069be10dee7e9c2a4520be1398b788"><td class="memItemLeft" align="right" valign="top">size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#aba069be10dee7e9c2a4520be1398b788">GetUsedPages</a> () const</td></tr>
<tr class="separator:aba069be10dee7e9c2a4520be1398b788"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a15debb0b4def8bba65cf439d55ee9476" id="r_a15debb0b4def8bba65cf439d55ee9476"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a15debb0b4def8bba65cf439d55ee9476">IsPageInBuffer</a> (int32_t page_id) const</td></tr>
<tr class="separator:a15debb0b4def8bba65cf439d55ee9476"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4ba1058d89ffa3c56845412bcbd27f09" id="r_a4ba1058d89ffa3c56845412bcbd27f09"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a4ba1058d89ffa3c56845412bcbd27f09">SetSimulateFlushFailure</a> (bool simulate)</td></tr>
<tr class="separator:a4ba1058d89ffa3c56845412bcbd27f09"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1d60f9455553ca6e7047b24818e853a5" id="r_a1d60f9455553ca6e7047b24818e853a5"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a1d60f9455553ca6e7047b24818e853a5">SetEnableConfigCallback</a> (bool)</td></tr>
<tr class="separator:a1d60f9455553ca6e7047b24818e853a5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab0fcbbceb869174398fa7e203dc51ce3" id="r_ab0fcbbceb869174398fa7e203dc51ce3"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#ab0fcbbceb869174398fa7e203dc51ce3">BufferPool</a> (<a class="el" href="classsqlcc_1_1DiskManager.html">DiskManager</a> *disk_manager, size_t pool_size, <a class="el" href="classsqlcc_1_1ConfigManager.html">ConfigManager</a> &amp;config_manager)</td></tr>
<tr class="separator:ab0fcbbceb869174398fa7e203dc51ce3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aeb26c2ec50ee4c23e4a214fc8304ad79" id="r_aeb26c2ec50ee4c23e4a214fc8304ad79"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#aeb26c2ec50ee4c23e4a214fc8304ad79">~BufferPool</a> ()</td></tr>
<tr class="separator:aeb26c2ec50ee4c23e4a214fc8304ad79"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8c2da3780c6ec635bee229cae90ccb83" id="r_a8c2da3780c6ec635bee229cae90ccb83"><td class="memItemLeft" align="right" valign="top"><a class="el" href="classsqlcc_1_1Page.html">Page</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a8c2da3780c6ec635bee229cae90ccb83">FetchPage</a> (int32_t page_id)</td></tr>
<tr class="separator:a8c2da3780c6ec635bee229cae90ccb83"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac9b37e03a56a791dd483858d76ad4299" id="r_ac9b37e03a56a791dd483858d76ad4299"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#ac9b37e03a56a791dd483858d76ad4299">UnpinPage</a> (int32_t page_id, bool is_dirty)</td></tr>
<tr class="separator:ac9b37e03a56a791dd483858d76ad4299"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5a697f8e177b9f1d22e95d2a6472dbfb" id="r_a5a697f8e177b9f1d22e95d2a6472dbfb"><td class="memItemLeft" align="right" valign="top"><a class="el" href="classsqlcc_1_1Page.html">Page</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a5a697f8e177b9f1d22e95d2a6472dbfb">NewPage</a> (int32_t *page_id)</td></tr>
<tr class="separator:a5a697f8e177b9f1d22e95d2a6472dbfb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acdce915c78dc7e4db0c56f0593803e73" id="r_acdce915c78dc7e4db0c56f0593803e73"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#acdce915c78dc7e4db0c56f0593803e73">FlushPage</a> (int32_t page_id)</td></tr>
<tr class="separator:acdce915c78dc7e4db0c56f0593803e73"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5e4a88f07f583dcecbf209dbbe1ad8e4" id="r_a5e4a88f07f583dcecbf209dbbe1ad8e4"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a5e4a88f07f583dcecbf209dbbe1ad8e4">DeletePage</a> (int32_t page_id)</td></tr>
<tr class="separator:a5e4a88f07f583dcecbf209dbbe1ad8e4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8cfea66edcf4a56f346a03d87e35c9df" id="r_a8cfea66edcf4a56f346a03d87e35c9df"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a8cfea66edcf4a56f346a03d87e35c9df">Resize</a> (size_t new_pool_size)</td></tr>
<tr class="separator:a8cfea66edcf4a56f346a03d87e35c9df"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab2fa434814c78b58319ff560a4e40a68" id="r_ab2fa434814c78b58319ff560a4e40a68"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structsqlcc_1_1BufferPool_1_1Metrics.html">Metrics</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#ab2fa434814c78b58319ff560a4e40a68">GetMetrics</a> () const</td></tr>
<tr class="separator:ab2fa434814c78b58319ff560a4e40a68"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adb70334238fa82ee756e810081158641" id="r_adb70334238fa82ee756e810081158641"><td class="memItemLeft" align="right" valign="top">size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#adb70334238fa82ee756e810081158641">GetPoolSize</a> () const</td></tr>
<tr class="separator:adb70334238fa82ee756e810081158641"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aba069be10dee7e9c2a4520be1398b788" id="r_aba069be10dee7e9c2a4520be1398b788"><td class="memItemLeft" align="right" valign="top">size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#aba069be10dee7e9c2a4520be1398b788">GetUsedPages</a> () const</td></tr>
<tr class="separator:aba069be10dee7e9c2a4520be1398b788"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a15debb0b4def8bba65cf439d55ee9476" id="r_a15debb0b4def8bba65cf439d55ee9476"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a15debb0b4def8bba65cf439d55ee9476">IsPageInBuffer</a> (int32_t page_id) const</td></tr>
<tr class="separator:a15debb0b4def8bba65cf439d55ee9476"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pri-methods" name="pri-methods"></a>
Private Member Functions</h2></td></tr>
<tr class="memitem:ae0096083797a56ae4ed4b28800bc5ad6" id="r_ae0096083797a56ae4ed4b28800bc5ad6"><td class="memItemLeft" align="right" valign="top">int32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#ae0096083797a56ae4ed4b28800bc5ad6">FindVictimPage</a> ()</td></tr>
<tr class="separator:ae0096083797a56ae4ed4b28800bc5ad6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa148877a3be9b10ebfcd8e35029e4780" id="r_aa148877a3be9b10ebfcd8e35029e4780"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#aa148877a3be9b10ebfcd8e35029e4780">ReplacePage</a> (int32_t victim_page_id, int32_t new_page_id)</td></tr>
<tr class="separator:aa148877a3be9b10ebfcd8e35029e4780"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a78d1dd2d7460d0eb2c7bf21ba2e97f75" id="r_a78d1dd2d7460d0eb2c7bf21ba2e97f75"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a78d1dd2d7460d0eb2c7bf21ba2e97f75">UpdateLRUList</a> (int32_t page_id)</td></tr>
<tr class="separator:a78d1dd2d7460d0eb2c7bf21ba2e97f75"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9104d28e09173098b7afce301ea086a0" id="r_a9104d28e09173098b7afce301ea086a0"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a9104d28e09173098b7afce301ea086a0">MoveToHead</a> (int32_t page_id)</td></tr>
<tr class="separator:a9104d28e09173098b7afce301ea086a0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a09c7879bf4f4f7cee87b8baa89c25829" id="r_a09c7879bf4f4f7cee87b8baa89c25829"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a09c7879bf4f4f7cee87b8baa89c25829">RemoveFromLRUList</a> (int32_t page_id)</td></tr>
<tr class="separator:a09c7879bf4f4f7cee87b8baa89c25829"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a31652cb0e19328cfe574ee9b67726bcf" id="r_a31652cb0e19328cfe574ee9b67726bcf"><td class="memItemLeft" align="right" valign="top">int32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a31652cb0e19328cfe574ee9b67726bcf">ReplacePageInternal</a> ()</td></tr>
<tr class="separator:a31652cb0e19328cfe574ee9b67726bcf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7e1ed47ea2f229397ec3e54b57d41868" id="r_a7e1ed47ea2f229397ec3e54b57d41868"><td class="memItemLeft" align="right" valign="top">int32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a7e1ed47ea2f229397ec3e54b57d41868">ReplacePage</a> ()</td></tr>
<tr class="separator:a7e1ed47ea2f229397ec3e54b57d41868"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aab230e7c61921995edfe616a2cf89bbe" id="r_aab230e7c61921995edfe616a2cf89bbe"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#aab230e7c61921995edfe616a2cf89bbe">OnConfigChange</a> (const std::string &amp;key, const <a class="el" href="namespacesqlcc.html#a35365cc4e9f1ef07e5d024b9963eff15">ConfigValue</a> &amp;value)</td></tr>
<tr class="separator:aab230e7c61921995edfe616a2cf89bbe"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2e47e1bad3d284f599791825584a0891" id="r_a2e47e1bad3d284f599791825584a0891"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a2e47e1bad3d284f599791825584a0891">AdjustBufferPoolSize</a> (size_t new_pool_size)</td></tr>
<tr class="separator:a2e47e1bad3d284f599791825584a0891"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acea5154becb46a17a6b13465a1fb12ac" id="r_acea5154becb46a17a6b13465a1fb12ac"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#acea5154becb46a17a6b13465a1fb12ac">AdjustBufferPoolSizeNoLock</a> (size_t new_pool_size)</td></tr>
<tr class="separator:acea5154becb46a17a6b13465a1fb12ac"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae0096083797a56ae4ed4b28800bc5ad6" id="r_ae0096083797a56ae4ed4b28800bc5ad6"><td class="memItemLeft" align="right" valign="top">int32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#ae0096083797a56ae4ed4b28800bc5ad6">FindVictimPage</a> ()</td></tr>
<tr class="separator:ae0096083797a56ae4ed4b28800bc5ad6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa148877a3be9b10ebfcd8e35029e4780" id="r_aa148877a3be9b10ebfcd8e35029e4780"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#aa148877a3be9b10ebfcd8e35029e4780">ReplacePage</a> (int32_t victim_page_id, int32_t new_page_id)</td></tr>
<tr class="separator:aa148877a3be9b10ebfcd8e35029e4780"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af7823ea920cd5e3239e2f9ac5b4860d2" id="r_af7823ea920cd5e3239e2f9ac5b4860d2"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#af7823ea920cd5e3239e2f9ac5b4860d2">UpdateLRU</a> (int32_t page_id)</td></tr>
<tr class="separator:af7823ea920cd5e3239e2f9ac5b4860d2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a501156956e4b91d0134d1195a733c685" id="r_a501156956e4b91d0134d1195a733c685"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a501156956e4b91d0134d1195a733c685">BufferPool</a> (const <a class="el" href="classsqlcc_1_1BufferPool.html">BufferPool</a> &amp;)=delete</td></tr>
<tr class="separator:a501156956e4b91d0134d1195a733c685"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a792661db8aaf7cf60fcb9904340f9c5d" id="r_a792661db8aaf7cf60fcb9904340f9c5d"><td class="memItemLeft" align="right" valign="top"><a class="el" href="classsqlcc_1_1BufferPool.html">BufferPool</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a792661db8aaf7cf60fcb9904340f9c5d">operator=</a> (const <a class="el" href="classsqlcc_1_1BufferPool.html">BufferPool</a> &amp;)=delete</td></tr>
<tr class="separator:a792661db8aaf7cf60fcb9904340f9c5d"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pri-attribs" name="pri-attribs"></a>
Private Attributes</h2></td></tr>
<tr class="memitem:a85424d92e888ae0b2a0754e7fea7d089" id="r_a85424d92e888ae0b2a0754e7fea7d089"><td class="memItemLeft" align="right" valign="top"><a class="el" href="classsqlcc_1_1DiskManager.html">DiskManager</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a85424d92e888ae0b2a0754e7fea7d089">disk_manager_</a></td></tr>
<tr class="separator:a85424d92e888ae0b2a0754e7fea7d089"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a52b7cc65c932b03c35af2e56916e9c9d" id="r_a52b7cc65c932b03c35af2e56916e9c9d"><td class="memItemLeft" align="right" valign="top"><a class="el" href="classsqlcc_1_1ConfigManager.html">ConfigManager</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a52b7cc65c932b03c35af2e56916e9c9d">config_manager_</a></td></tr>
<tr class="separator:a52b7cc65c932b03c35af2e56916e9c9d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab824ca05f9fc912a0d2def90f30412fa" id="r_ab824ca05f9fc912a0d2def90f30412fa"><td class="memItemLeft" align="right" valign="top">size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#ab824ca05f9fc912a0d2def90f30412fa">pool_size_</a></td></tr>
<tr class="separator:ab824ca05f9fc912a0d2def90f30412fa"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6558e895d89c28c3a7a52d6c1e534309" id="r_a6558e895d89c28c3a7a52d6c1e534309"><td class="memItemLeft" align="right" valign="top">std::unordered_map&lt; int32_t, <a class="el" href="classsqlcc_1_1Page.html">Page</a> * &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a></td></tr>
<tr class="separator:a6558e895d89c28c3a7a52d6c1e534309"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1aa80be20bb1b29ae3a8045fef1efb54" id="r_a1aa80be20bb1b29ae3a8045fef1efb54"><td class="memItemLeft" align="right" valign="top">std::list&lt; int32_t &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a></td></tr>
<tr class="separator:a1aa80be20bb1b29ae3a8045fef1efb54"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac6cc45a3a4a4ceabc7c0b57155fedd0b" id="r_ac6cc45a3a4a4ceabc7c0b57155fedd0b"><td class="memItemLeft" align="right" valign="top">std::unordered_map&lt; int32_t, std::list&lt; int32_t &gt;::iterator &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#ac6cc45a3a4a4ceabc7c0b57155fedd0b">lru_map_</a></td></tr>
<tr class="separator:ac6cc45a3a4a4ceabc7c0b57155fedd0b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:add85ac70113f80ae97898aada5f87994" id="r_add85ac70113f80ae97898aada5f87994"><td class="memItemLeft" align="right" valign="top">std::timed_mutex&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#add85ac70113f80ae97898aada5f87994">latch_</a></td></tr>
<tr class="separator:add85ac70113f80ae97898aada5f87994"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4f10df0f06c12c12ab49e0a4db686de4" id="r_a4f10df0f06c12c12ab49e0a4db686de4"><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structsqlcc_1_1BufferPool_1_1Stats.html">sqlcc::BufferPool::Stats</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a4f10df0f06c12c12ab49e0a4db686de4">stats_</a></td></tr>
<tr class="separator:a4f10df0f06c12c12ab49e0a4db686de4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad5caecdc03c1393603275e080c052bd4" id="r_ad5caecdc03c1393603275e080c052bd4"><td class="memItemLeft" align="right" valign="top">std::unordered_map&lt; int32_t, int &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a></td></tr>
<tr class="separator:ad5caecdc03c1393603275e080c052bd4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a08cc880334bde9136f0a614786afea5d" id="r_a08cc880334bde9136f0a614786afea5d"><td class="memItemLeft" align="right" valign="top">std::unordered_map&lt; int32_t, bool &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a></td></tr>
<tr class="separator:a08cc880334bde9136f0a614786afea5d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af1b9545a6884861a6d10237e0131fee5" id="r_af1b9545a6884861a6d10237e0131fee5"><td class="memItemLeft" align="right" valign="top">std::deque&lt; int32_t &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a></td></tr>
<tr class="separator:af1b9545a6884861a6d10237e0131fee5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9b5dc3d10a60b03cdfa04a9629e46df1" id="r_a9b5dc3d10a60b03cdfa04a9629e46df1"><td class="memItemLeft" align="right" valign="top">std::unordered_map&lt; int32_t, int &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a9b5dc3d10a60b03cdfa04a9629e46df1">access_stats_</a></td></tr>
<tr class="separator:a9b5dc3d10a60b03cdfa04a9629e46df1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aec6235e35f498e90ed5c66bf1ca8b4d2" id="r_aec6235e35f498e90ed5c66bf1ca8b4d2"><td class="memItemLeft" align="right" valign="top">std::vector&lt; char * &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#aec6235e35f498e90ed5c66bf1ca8b4d2">batch_buffer_</a></td></tr>
<tr class="separator:aec6235e35f498e90ed5c66bf1ca8b4d2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6a1ad43771d8cae7413806fbb7db31dd" id="r_a6a1ad43771d8cae7413806fbb7db31dd"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a6a1ad43771d8cae7413806fbb7db31dd">simulate_flush_failure_</a></td></tr>
<tr class="separator:a6a1ad43771d8cae7413806fbb7db31dd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abe6985900d8804e2c0fe37299133eb08" id="r_abe6985900d8804e2c0fe37299133eb08"><td class="memItemLeft" align="right" valign="top">size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#abe6985900d8804e2c0fe37299133eb08">read_lock_timeout_ms_</a></td></tr>
<tr class="separator:abe6985900d8804e2c0fe37299133eb08"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6f94e56229b9887a9c10b6305825cf31" id="r_a6f94e56229b9887a9c10b6305825cf31"><td class="memItemLeft" align="right" valign="top">size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#a6f94e56229b9887a9c10b6305825cf31">write_lock_timeout_ms_</a></td></tr>
<tr class="separator:a6f94e56229b9887a9c10b6305825cf31"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad51347a7c8621ac0b20071c60fef39ee" id="r_ad51347a7c8621ac0b20071c60fef39ee"><td class="memItemLeft" align="right" valign="top">size_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#ad51347a7c8621ac0b20071c60fef39ee">lock_timeout_ms_</a></td></tr>
<tr class="separator:ad51347a7c8621ac0b20071c60fef39ee"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aeb20d8120bd8b322067b9337bca45bdb" id="r_aeb20d8120bd8b322067b9337bca45bdb"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structsqlcc_1_1BufferPool_1_1Metrics.html">Metrics</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classsqlcc_1_1BufferPool.html#aeb20d8120bd8b322067b9337bca45bdb">metrics_</a></td></tr>
<tr class="separator:aeb20d8120bd8b322067b9337bca45bdb"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>生产就绪简化BufferPool类 (v0.4.7版本) </p>
<p>这是针对生产环境的SQLCC数据库BufferPool核心组件重构版本。 主要改进：</p><ul>
<li>移除了复杂的批处理预取机制，专注于核心页面管理功能</li>
<li>采用分层锁架构，消除死锁风险，保证并发安全性</li>
<li>实现运行时缓冲池动态调整，适应不同负载需求</li>
<li>集成全面的性能监控系统，提供实时的缓存统计</li>
<li>代码复杂度降低60，从1200+行简化到500+行</li>
</ul>
<p>核心特性： ✅ 死锁预防: 使用timed_mutex和锁管理策略 ✅ 异常安全: 全面的错误处理和状态一致性保证 ✅ 性能监控: 实时统计命中率、操作次数和延迟 ✅ 生产就绪: 移除实验性功能，保证稳定性 ✅ 向后兼容: 保持现有API接口设计原则</p>
<p>使用cline：x-ai/grok-code-fast-1 AI工具辅助完成重构</p>
<dl class="section author"><dt>Author</dt><dd>SQLCC Team </dd></dl>
<dl class="section version"><dt>Version</dt><dd>v0.4.7 </dd></dl>
<dl class="section date"><dt>Date</dt><dd>2025-11-18 </dd></dl>

<p class="definition">Definition at line <a class="el" href="buffer__pool_8h_source.html#l00138">138</a> of file <a class="el" href="buffer__pool_8h_source.html">buffer_pool.h</a>.</p>
</div><h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a id="ab0fcbbceb869174398fa7e203dc51ce3" name="ab0fcbbceb869174398fa7e203dc51ce3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab0fcbbceb869174398fa7e203dc51ce3">&#9670;&#160;</a></span>BufferPool() <span class="overload">[1/4]</span></h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">sqlcc::BufferPool::BufferPool </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classsqlcc_1_1DiskManager.html">DiskManager</a> *&#160;</td>
          <td class="paramname"><em>disk_manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>pool_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classsqlcc_1_1ConfigManager.html">ConfigManager</a> &amp;&#160;</td>
          <td class="paramname"><em>config_manager</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">explicit</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8cpp_source.html#l00015">15</a> of file <a class="el" href="buffer__pool_8cpp_source.html">buffer_pool.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   16</span>    : <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a85424d92e888ae0b2a0754e7fea7d089">disk_manager_</a>(disk_manager), <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a52b7cc65c932b03c35af2e56916e9c9d">config_manager_</a>(config_manager), <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ab824ca05f9fc912a0d2def90f30412fa">pool_size_</a>(pool_size), </div>
<div class="line"><span class="lineno">   17</span>        <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6a1ad43771d8cae7413806fbb7db31dd">simulate_flush_failure_</a>(<span class="keyword">false</span>), <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#abe6985900d8804e2c0fe37299133eb08">read_lock_timeout_ms_</a>(0), <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6f94e56229b9887a9c10b6305825cf31">write_lock_timeout_ms_</a>(0), <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad51347a7c8621ac0b20071c60fef39ee">lock_timeout_ms_</a>(0) {</div>
<div class="line"><span class="lineno">   18</span>    <span class="comment">// 从配置管理器获取不同操作的锁超时时间</span></div>
<div class="line"><span class="lineno">   19</span>    <span class="comment">// 读取操作使用较短的超时时间</span></div>
<div class="line"><span class="lineno">   20</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#abe6985900d8804e2c0fe37299133eb08">read_lock_timeout_ms_</a> = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a52b7cc65c932b03c35af2e56916e9c9d">config_manager_</a>.<a class="code hl_function" href="classsqlcc_1_1ConfigManager.html#aa300984f16f24ff8d2bcecd54bb6c4d3">GetInt</a>(<span class="stringliteral">&quot;buffer_pool.read_lock_timeout_ms&quot;</span>, 2000);</div>
<div class="line"><span class="lineno">   21</span>    <span class="comment">// 写入和修改操作使用较长的超时时间</span></div>
<div class="line"><span class="lineno">   22</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6f94e56229b9887a9c10b6305825cf31">write_lock_timeout_ms_</a> = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a52b7cc65c932b03c35af2e56916e9c9d">config_manager_</a>.<a class="code hl_function" href="classsqlcc_1_1ConfigManager.html#aa300984f16f24ff8d2bcecd54bb6c4d3">GetInt</a>(<span class="stringliteral">&quot;buffer_pool.write_lock_timeout_ms&quot;</span>, 5000);</div>
<div class="line"><span class="lineno">   23</span>    <span class="comment">// 默认超时时间（用于其他操作）</span></div>
<div class="line"><span class="lineno">   24</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad51347a7c8621ac0b20071c60fef39ee">lock_timeout_ms_</a> = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a52b7cc65c932b03c35af2e56916e9c9d">config_manager_</a>.<a class="code hl_function" href="classsqlcc_1_1ConfigManager.html#aa300984f16f24ff8d2bcecd54bb6c4d3">GetInt</a>(<span class="stringliteral">&quot;buffer_pool.default_lock_timeout_ms&quot;</span>, 3000);</div>
<div class="line"><span class="lineno">   25</span>    </div>
<div class="line"><span class="lineno">   26</span>    <span class="comment">// 记录配置的锁超时时间</span></div>
<div class="line"><span class="lineno">   27</span>    <a class="code hl_define" href="logger_8h.html#a51a9494ff02cefe77ed341798f825fdf">SQLCC_LOG_INFO</a>(<span class="stringliteral">&quot;BufferPool lock timeout settings - Read: &quot;</span> + std::to_string(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#abe6985900d8804e2c0fe37299133eb08">read_lock_timeout_ms_</a>) + </div>
<div class="line"><span class="lineno">   28</span>                  <span class="stringliteral">&quot;ms, Write: &quot;</span> + std::to_string(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6f94e56229b9887a9c10b6305825cf31">write_lock_timeout_ms_</a>) + </div>
<div class="line"><span class="lineno">   29</span>                  <span class="stringliteral">&quot;ms, Default: &quot;</span> + std::to_string(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad51347a7c8621ac0b20071c60fef39ee">lock_timeout_ms_</a>) + <span class="stringliteral">&quot;ms&quot;</span>);</div>
<div class="line"><span class="lineno">   30</span>    <span class="comment">// 预分配批量操作缓冲区空间</span></div>
<div class="line"><span class="lineno">   31</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#aec6235e35f498e90ed5c66bf1ca8b4d2">batch_buffer_</a>.reserve(std::min(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ab824ca05f9fc912a0d2def90f30412fa">pool_size_</a>, <span class="keyword">static_cast&lt;</span><span class="keywordtype">size_t</span><span class="keyword">&gt;</span>(64)));</div>
<div class="line"><span class="lineno">   32</span>    </div>
<div class="line"><span class="lineno">   33</span>    <span class="comment">// 记录缓冲池初始化信息，便于调试和监控</span></div>
<div class="line"><span class="lineno">   34</span>    <a class="code hl_define" href="logger_8h.html#a51a9494ff02cefe77ed341798f825fdf">SQLCC_LOG_INFO</a>(<span class="stringliteral">&quot;Initializing BufferPool with pool size: &quot;</span> + std::to_string(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ab824ca05f9fc912a0d2def90f30412fa">pool_size_</a>));</div>
<div class="line"><span class="lineno">   35</span>    </div>
<div class="line"><span class="lineno">   36</span>    <span class="comment">// 初始化所有内部数据结构，确保对象状态完整</span></div>
<div class="line"><span class="lineno">   37</span>    <span class="comment">// 移除配置回调相关功能，避免死锁</span></div>
<div class="line"><span class="lineno">   38</span>    <span class="comment">// 注意：暂时禁用动态配置功能，需要重启应用才能修改缓冲池参数</span></div>
<div class="line"><span class="lineno">   39</span>}</div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_a52b7cc65c932b03c35af2e56916e9c9d"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#a52b7cc65c932b03c35af2e56916e9c9d">sqlcc::BufferPool::config_manager_</a></div><div class="ttdeci">ConfigManager &amp; config_manager_</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8h_source.html#l00317">buffer_pool.h:317</a></div></div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_a6a1ad43771d8cae7413806fbb7db31dd"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#a6a1ad43771d8cae7413806fbb7db31dd">sqlcc::BufferPool::simulate_flush_failure_</a></div><div class="ttdeci">bool simulate_flush_failure_</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8h_source.html#l00396">buffer_pool.h:396</a></div></div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_a6f94e56229b9887a9c10b6305825cf31"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#a6f94e56229b9887a9c10b6305825cf31">sqlcc::BufferPool::write_lock_timeout_ms_</a></div><div class="ttdeci">size_t write_lock_timeout_ms_</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8h_source.html#l00403">buffer_pool.h:403</a></div></div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_a85424d92e888ae0b2a0754e7fea7d089"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#a85424d92e888ae0b2a0754e7fea7d089">sqlcc::BufferPool::disk_manager_</a></div><div class="ttdeci">DiskManager * disk_manager_</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8h_source.html#l00311">buffer_pool.h:311</a></div></div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_ab824ca05f9fc912a0d2def90f30412fa"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#ab824ca05f9fc912a0d2def90f30412fa">sqlcc::BufferPool::pool_size_</a></div><div class="ttdeci">size_t pool_size_</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8h_source.html#l00323">buffer_pool.h:323</a></div></div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_abe6985900d8804e2c0fe37299133eb08"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#abe6985900d8804e2c0fe37299133eb08">sqlcc::BufferPool::read_lock_timeout_ms_</a></div><div class="ttdeci">size_t read_lock_timeout_ms_</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8h_source.html#l00402">buffer_pool.h:402</a></div></div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_ad51347a7c8621ac0b20071c60fef39ee"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#ad51347a7c8621ac0b20071c60fef39ee">sqlcc::BufferPool::lock_timeout_ms_</a></div><div class="ttdeci">size_t lock_timeout_ms_</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8h_source.html#l00404">buffer_pool.h:404</a></div></div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_aec6235e35f498e90ed5c66bf1ca8b4d2"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#aec6235e35f498e90ed5c66bf1ca8b4d2">sqlcc::BufferPool::batch_buffer_</a></div><div class="ttdeci">std::vector&lt; char * &gt; batch_buffer_</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8h_source.html#l00390">buffer_pool.h:390</a></div></div>
<div class="ttc" id="aclasssqlcc_1_1ConfigManager_html_aa300984f16f24ff8d2bcecd54bb6c4d3"><div class="ttname"><a href="classsqlcc_1_1ConfigManager.html#aa300984f16f24ff8d2bcecd54bb6c4d3">sqlcc::ConfigManager::GetInt</a></div><div class="ttdeci">int GetInt(const std::string &amp;key, int default_value=0) const</div><div class="ttdoc">获取整数类型配置值</div><div class="ttdef"><b>Definition</b> <a href="config__manager_8cpp_source.html#l00127">config_manager.cpp:127</a></div></div>
<div class="ttc" id="alogger_8h_html_a51a9494ff02cefe77ed341798f825fdf"><div class="ttname"><a href="logger_8h.html#a51a9494ff02cefe77ed341798f825fdf">SQLCC_LOG_INFO</a></div><div class="ttdeci">#define SQLCC_LOG_INFO(msg)</div><div class="ttdoc">记录信息日志的宏定义</div><div class="ttdef"><b>Definition</b> <a href="logger_8h_source.html#l00274">logger.h:274</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="buffer__pool_8h_source.html#l00390">batch_buffer_</a>, <a class="el" href="buffer__pool_8h_source.html#l00317">config_manager_</a>, <a class="el" href="config__manager_8cpp_source.html#l00127">sqlcc::ConfigManager::GetInt()</a>, <a class="el" href="buffer__pool_8h_source.html#l00404">lock_timeout_ms_</a>, <a class="el" href="buffer__pool_8h_source.html#l00323">pool_size_</a>, <a class="el" href="buffer__pool_8h_source.html#l00402">read_lock_timeout_ms_</a>, <a class="el" href="logger_8h_source.html#l00274">SQLCC_LOG_INFO</a>, and <a class="el" href="buffer__pool_8h_source.html#l00403">write_lock_timeout_ms_</a>.</p>

</div>
</div>
<a id="a501156956e4b91d0134d1195a733c685" name="a501156956e4b91d0134d1195a733c685"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a501156956e4b91d0134d1195a733c685">&#9670;&#160;</a></span>BufferPool() <span class="overload">[2/4]</span></h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">sqlcc::BufferPool::BufferPool </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="classsqlcc_1_1BufferPool.html">BufferPool</a> &amp;&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">delete</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<a id="aeb26c2ec50ee4c23e4a214fc8304ad79" name="aeb26c2ec50ee4c23e4a214fc8304ad79"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aeb26c2ec50ee4c23e4a214fc8304ad79">&#9670;&#160;</a></span>~BufferPool() <span class="overload">[1/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">sqlcc::BufferPool::~BufferPool </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8cpp_source.html#l00045">45</a> of file <a class="el" href="buffer__pool_8cpp_source.html">buffer_pool.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   45</span>                        {</div>
<div class="line"><span class="lineno">   46</span>    <span class="comment">// 记录缓冲池销毁信息，便于调试和监控</span></div>
<div class="line"><span class="lineno">   47</span>    <span class="comment">// Why: 日志记录有助于系统运行状态的监控和问题排查</span></div>
<div class="line"><span class="lineno">   48</span>    <span class="comment">// What: 记录缓冲池销毁信息</span></div>
<div class="line"><span class="lineno">   49</span>    <span class="comment">// How: 使用SQLCC_LOG_INFO宏记录信息级别日志</span></div>
<div class="line"><span class="lineno">   50</span>    <a class="code hl_define" href="logger_8h.html#a51a9494ff02cefe77ed341798f825fdf">SQLCC_LOG_INFO</a>(<span class="stringliteral">&quot;Destroying BufferPool&quot;</span>);</div>
<div class="line"><span class="lineno">   51</span>    </div>
<div class="line"><span class="lineno">   52</span>    <span class="comment">// 析构时刷新所有脏页，确保数据持久性</span></div>
<div class="line"><span class="lineno">   53</span>    <span class="comment">// Why: 在对象销毁前必须将所有修改过的页面写回磁盘，避免数据丢失</span></div>
<div class="line"><span class="lineno">   54</span>    <span class="comment">// What: 调用FlushAllPages()方法将所有脏页写回磁盘</span></div>
<div class="line"><span class="lineno">   55</span>    <span class="comment">// How: FlushAllPages()会遍历所有页面，检查脏页标记，将脏页写回磁盘</span></div>
<div class="line"><span class="lineno">   56</span>    <a class="code hl_function" href="classsqlcc_1_1BufferPool.html#a72b69be11e8c034a712b605c3741b09f">FlushAllPages</a>();</div>
<div class="line"><span class="lineno">   57</span>}</div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_a72b69be11e8c034a712b605c3741b09f"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#a72b69be11e8c034a712b605c3741b09f">sqlcc::BufferPool::FlushAllPages</a></div><div class="ttdeci">void FlushAllPages()</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8cpp_source.html#l00869">buffer_pool.cpp:869</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="buffer__pool_8cpp_source.html#l00869">FlushAllPages()</a>, and <a class="el" href="logger_8h_source.html#l00274">SQLCC_LOG_INFO</a>.</p>

</div>
</div>
<a id="ab0fcbbceb869174398fa7e203dc51ce3" name="ab0fcbbceb869174398fa7e203dc51ce3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab0fcbbceb869174398fa7e203dc51ce3">&#9670;&#160;</a></span>BufferPool() <span class="overload">[3/4]</span></h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">sqlcc::BufferPool::BufferPool </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classsqlcc_1_1DiskManager.html">DiskManager</a> *&#160;</td>
          <td class="paramname"><em>disk_manager</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>pool_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classsqlcc_1_1ConfigManager.html">ConfigManager</a> &amp;&#160;</td>
          <td class="paramname"><em>config_manager</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">explicit</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<a id="aeb26c2ec50ee4c23e4a214fc8304ad79" name="aeb26c2ec50ee4c23e4a214fc8304ad79"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aeb26c2ec50ee4c23e4a214fc8304ad79">&#9670;&#160;</a></span>~BufferPool() <span class="overload">[2/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">sqlcc::BufferPool::~BufferPool </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a501156956e4b91d0134d1195a733c685" name="a501156956e4b91d0134d1195a733c685"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a501156956e4b91d0134d1195a733c685">&#9670;&#160;</a></span>BufferPool() <span class="overload">[4/4]</span></h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">sqlcc::BufferPool::BufferPool </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="classsqlcc_1_1BufferPool.html">BufferPool</a> &amp;&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span><span class="mlabel">delete</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a id="a2e47e1bad3d284f599791825584a0891" name="a2e47e1bad3d284f599791825584a0891"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2e47e1bad3d284f599791825584a0891">&#9670;&#160;</a></span>AdjustBufferPoolSize()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void sqlcc::BufferPool::AdjustBufferPoolSize </td>
          <td>(</td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>new_pool_size</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8cpp_source.html#l01333">1333</a> of file <a class="el" href="buffer__pool_8cpp_source.html">buffer_pool.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno"> 1333</span>                                                          {</div>
<div class="line"><span class="lineno"> 1334</span>    <span class="comment">// 加锁保护并发访问 - 使用unique_lock以支持临时解锁避免死锁</span></div>
<div class="line"><span class="lineno"> 1335</span>    std::unique_lock&lt;std::timed_mutex&gt; lock(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#add85ac70113f80ae97898aada5f87994">latch_</a>);</div>
<div class="line"><span class="lineno"> 1336</span>    </div>
<div class="line"><span class="lineno"> 1337</span>    <a class="code hl_define" href="logger_8h.html#a51a9494ff02cefe77ed341798f825fdf">SQLCC_LOG_INFO</a>(<span class="stringliteral">&quot;Adjusting buffer pool size from &quot;</span> + std::to_string(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ab824ca05f9fc912a0d2def90f30412fa">pool_size_</a>) + <span class="stringliteral">&quot; to &quot;</span> + std::to_string(new_pool_size));</div>
<div class="line"><span class="lineno"> 1338</span>    </div>
<div class="line"><span class="lineno"> 1339</span>    <span class="keywordtype">size_t</span> current_size = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.size();</div>
<div class="line"><span class="lineno"> 1340</span>    </div>
<div class="line"><span class="lineno"> 1341</span>    <span class="comment">// 如果新大小小于当前大小，需要移除多余的页面</span></div>
<div class="line"><span class="lineno"> 1342</span>    <span class="keywordflow">if</span> (new_pool_size &lt; current_size) {</div>
<div class="line"><span class="lineno"> 1343</span>        <span class="comment">// 需要移除的页面数量</span></div>
<div class="line"><span class="lineno"> 1344</span>        <span class="keywordtype">size_t</span> pages_to_remove = current_size - new_pool_size;</div>
<div class="line"><span class="lineno"> 1345</span>        <a class="code hl_define" href="logger_8h.html#a51a9494ff02cefe77ed341798f825fdf">SQLCC_LOG_INFO</a>(<span class="stringliteral">&quot;Need to remove &quot;</span> + std::to_string(pages_to_remove) + <span class="stringliteral">&quot; clean pages from buffer pool&quot;</span>);</div>
<div class="line"><span class="lineno"> 1346</span>        </div>
<div class="line"><span class="lineno"> 1347</span>        <span class="comment">// 使用内部方法移除页面，避免死锁</span></div>
<div class="line"><span class="lineno"> 1348</span>        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; pages_to_remove; ++i) {</div>
<div class="line"><span class="lineno"> 1349</span>            <span class="comment">// 检查是否已经达到目标大小</span></div>
<div class="line"><span class="lineno"> 1350</span>            <span class="keywordflow">if</span> (<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.size() &lt;= new_pool_size) {</div>
<div class="line"><span class="lineno"> 1351</span>                <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno"> 1352</span>            }</div>
<div class="line"><span class="lineno"> 1353</span>            </div>
<div class="line"><span class="lineno"> 1354</span>            <span class="comment">// 使用内部方法移除页面，不涉及锁的重新获取</span></div>
<div class="line"><span class="lineno"> 1355</span>            int32_t removed_page_id = <a class="code hl_function" href="classsqlcc_1_1BufferPool.html#a31652cb0e19328cfe574ee9b67726bcf">ReplacePageInternal</a>();</div>
<div class="line"><span class="lineno"> 1356</span>            <span class="keywordflow">if</span> (removed_page_id == -1) {</div>
<div class="line"><span class="lineno"> 1357</span>                <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Failed to remove page during buffer pool size adjustment&quot;</span>);</div>
<div class="line"><span class="lineno"> 1358</span>                <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno"> 1359</span>            }</div>
<div class="line"><span class="lineno"> 1360</span>        }</div>
<div class="line"><span class="lineno"> 1361</span>        </div>
<div class="line"><span class="lineno"> 1362</span>    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (new_pool_size &gt; <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ab824ca05f9fc912a0d2def90f30412fa">pool_size_</a>) {</div>
<div class="line"><span class="lineno"> 1363</span>        <a class="code hl_define" href="logger_8h.html#a51a9494ff02cefe77ed341798f825fdf">SQLCC_LOG_INFO</a>(<span class="stringliteral">&quot;Increasing buffer pool size from &quot;</span> + std::to_string(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ab824ca05f9fc912a0d2def90f30412fa">pool_size_</a>) + <span class="stringliteral">&quot; to &quot;</span> + std::to_string(new_pool_size));</div>
<div class="line"><span class="lineno"> 1364</span>        <span class="comment">// 新大小更大时，不需要立即移除页面，新的页面会在需要时添加</span></div>
<div class="line"><span class="lineno"> 1365</span>    }</div>
<div class="line"><span class="lineno"> 1366</span>    </div>
<div class="line"><span class="lineno"> 1367</span>    <span class="comment">// 更新缓冲池大小</span></div>
<div class="line"><span class="lineno"> 1368</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ab824ca05f9fc912a0d2def90f30412fa">pool_size_</a> = new_pool_size;</div>
<div class="line"><span class="lineno"> 1369</span>    <a class="code hl_define" href="logger_8h.html#a51a9494ff02cefe77ed341798f825fdf">SQLCC_LOG_INFO</a>(<span class="stringliteral">&quot;Buffer pool size adjustment completed. New size: &quot;</span> + std::to_string(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ab824ca05f9fc912a0d2def90f30412fa">pool_size_</a>));</div>
<div class="line"><span class="lineno"> 1370</span>}</div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_a31652cb0e19328cfe574ee9b67726bcf"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#a31652cb0e19328cfe574ee9b67726bcf">sqlcc::BufferPool::ReplacePageInternal</a></div><div class="ttdeci">int32_t ReplacePageInternal()</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8cpp_source.html#l01259">buffer_pool.cpp:1259</a></div></div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_a6558e895d89c28c3a7a52d6c1e534309"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">sqlcc::BufferPool::page_table_</a></div><div class="ttdeci">std::unordered_map&lt; int32_t, Page * &gt; page_table_</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8h_source.html#l00329">buffer_pool.h:329</a></div></div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_add85ac70113f80ae97898aada5f87994"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#add85ac70113f80ae97898aada5f87994">sqlcc::BufferPool::latch_</a></div><div class="ttdeci">std::timed_mutex latch_</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8h_source.html#l00347">buffer_pool.h:347</a></div></div>
<div class="ttc" id="alogger_8h_html_a6288fa1e809caec231f7ba41f7f9b6e2"><div class="ttname"><a href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a></div><div class="ttdeci">#define SQLCC_LOG_WARN(msg)</div><div class="ttdoc">记录警告日志的宏定义</div><div class="ttdef"><b>Definition</b> <a href="logger_8h_source.html#l00283">logger.h:283</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="buffer__pool_8h_source.html#l00347">latch_</a>, <a class="el" href="buffer__pool_8h_source.html#l00329">page_table_</a>, <a class="el" href="buffer__pool_8h_source.html#l00323">pool_size_</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01259">ReplacePageInternal()</a>, <a class="el" href="logger_8h_source.html#l00274">SQLCC_LOG_INFO</a>, and <a class="el" href="logger_8h_source.html#l00283">SQLCC_LOG_WARN</a>.</p>

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l01376">AdjustBufferPoolSizeNoLock()</a>.</p>

</div>
</div>
<a id="acea5154becb46a17a6b13465a1fb12ac" name="acea5154becb46a17a6b13465a1fb12ac"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acea5154becb46a17a6b13465a1fb12ac">&#9670;&#160;</a></span>AdjustBufferPoolSizeNoLock()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void sqlcc::BufferPool::AdjustBufferPoolSizeNoLock </td>
          <td>(</td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>new_pool_size</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8cpp_source.html#l01376">1376</a> of file <a class="el" href="buffer__pool_8cpp_source.html">buffer_pool.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno"> 1376</span>                                                                {</div>
<div class="line"><span class="lineno"> 1377</span>    <span class="comment">// 使用std::async启动异步任务，避免在配置回调线程中直接获取锁</span></div>
<div class="line"><span class="lineno"> 1378</span>    <span class="comment">// Why: std::async会在独立的线程中执行，避免与当前线程产生锁竞争</span></div>
<div class="line"><span class="lineno"> 1379</span>    <span class="comment">// What: 启动一个异步任务来执行缓冲池大小调整</span></div>
<div class="line"><span class="lineno"> 1380</span>    <span class="comment">// How: 传递原始指针引用，确保BufferPool对象在异步任务执行期间保持有效</span></div>
<div class="line"><span class="lineno"> 1381</span>    <span class="keyword">auto</span> future = std::async(std::launch::async, [<span class="keyword">this</span>, new_pool_size]() {</div>
<div class="line"><span class="lineno"> 1382</span>        <span class="comment">// 在异步任务中调用原始的AdjustBufferPoolSize方法</span></div>
<div class="line"><span class="lineno"> 1383</span>        <span class="comment">// Why: 异步任务会在独立的线程中执行，避免与配置回调线程产生锁竞争</span></div>
<div class="line"><span class="lineno"> 1384</span>        <span class="comment">// What: 在独立的执行线程中调整缓冲池大小</span></div>
<div class="line"><span class="lineno"> 1385</span>        <span class="comment">// How: 调用AdjustBufferPoolSize方法执行实际的大小调整逻辑</span></div>
<div class="line"><span class="lineno"> 1386</span>        this-&gt;<a class="code hl_function" href="classsqlcc_1_1BufferPool.html#a2e47e1bad3d284f599791825584a0891">AdjustBufferPoolSize</a>(new_pool_size);</div>
<div class="line"><span class="lineno"> 1387</span>    });</div>
<div class="line"><span class="lineno"> 1388</span>    <span class="comment">// 忽略future对象，不等待异步任务完成，避免阻塞当前线程</span></div>
<div class="line"><span class="lineno"> 1389</span>    (void)future;</div>
<div class="line"><span class="lineno"> 1390</span>    <a class="code hl_define" href="logger_8h.html#a51a9494ff02cefe77ed341798f825fdf">SQLCC_LOG_INFO</a>(<span class="stringliteral">&quot;Buffer pool size adjustment initiated asynchronously to &quot;</span> + std::to_string(new_pool_size));</div>
<div class="line"><span class="lineno"> 1391</span>}</div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_a2e47e1bad3d284f599791825584a0891"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#a2e47e1bad3d284f599791825584a0891">sqlcc::BufferPool::AdjustBufferPoolSize</a></div><div class="ttdeci">void AdjustBufferPoolSize(size_t new_pool_size)</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8cpp_source.html#l01333">buffer_pool.cpp:1333</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="buffer__pool_8cpp_source.html#l01333">AdjustBufferPoolSize()</a>, and <a class="el" href="logger_8h_source.html#l00274">SQLCC_LOG_INFO</a>.</p>

</div>
</div>
<a id="a19218f84859b349a66aeb7896b44a9f9" name="a19218f84859b349a66aeb7896b44a9f9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a19218f84859b349a66aeb7896b44a9f9">&#9670;&#160;</a></span>BatchFetchPages()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::vector&lt; <a class="el" href="classsqlcc_1_1Page.html">Page</a> * &gt; sqlcc::BufferPool::BatchFetchPages </td>
          <td>(</td>
          <td class="paramtype">const std::vector&lt; int32_t &gt; &amp;&#160;</td>
          <td class="paramname"><em>page_ids</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8cpp_source.html#l00745">745</a> of file <a class="el" href="buffer__pool_8cpp_source.html">buffer_pool.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  745</span>                                                                               {</div>
<div class="line"><span class="lineno">  746</span>    <span class="comment">// 加锁保护并发访问 - 使用unique_lock以支持临时解锁避免死锁</span></div>
<div class="line"><span class="lineno">  747</span>    std::unique_lock&lt;std::timed_mutex&gt; lock(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#add85ac70113f80ae97898aada5f87994">latch_</a>);</div>
<div class="line"><span class="lineno">  748</span>    </div>
<div class="line"><span class="lineno">  749</span>    std::vector&lt;Page*&gt; result;</div>
<div class="line"><span class="lineno">  750</span>    result.reserve(page_ids.size());</div>
<div class="line"><span class="lineno">  751</span>    </div>
<div class="line"><span class="lineno">  752</span>    <span class="comment">// 分离已在缓冲池中和不在缓冲池中页面</span></div>
<div class="line"><span class="lineno">  753</span>    std::vector&lt;int32_t&gt; pages_to_read;</div>
<div class="line"><span class="lineno">  754</span>    </div>
<div class="line"><span class="lineno">  755</span>    <span class="comment">// 首先处理已在缓冲池中的页面</span></div>
<div class="line"><span class="lineno">  756</span>    <span class="keywordflow">for</span> (int32_t page_id : page_ids) {</div>
<div class="line"><span class="lineno">  757</span>        <span class="comment">// 检查页面ID是否有效</span></div>
<div class="line"><span class="lineno">  758</span>        <span class="keywordflow">if</span> (page_id &lt; 0) {</div>
<div class="line"><span class="lineno">  759</span>            <a class="code hl_define" href="logger_8h.html#a84e665e7d7b3157724d71a7c46644680">SQLCC_LOG_ERROR</a>(<span class="stringliteral">&quot;Invalid page ID: &quot;</span> + std::to_string(page_id));</div>
<div class="line"><span class="lineno">  760</span>            result.push_back(<span class="keyword">nullptr</span>);</div>
<div class="line"><span class="lineno">  761</span>            <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno">  762</span>        }</div>
<div class="line"><span class="lineno">  763</span>        </div>
<div class="line"><span class="lineno">  764</span>        <span class="comment">// 更新访问统计</span></div>
<div class="line"><span class="lineno">  765</span>        <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a9b5dc3d10a60b03cdfa04a9629e46df1">access_stats_</a>[page_id]++;</div>
<div class="line"><span class="lineno">  766</span>        </div>
<div class="line"><span class="lineno">  767</span>        <span class="keyword">auto</span> page_it = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.find(page_id);</div>
<div class="line"><span class="lineno">  768</span>        <span class="keywordflow">if</span> (page_it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.end()) {</div>
<div class="line"><span class="lineno">  769</span>            <span class="comment">// 页面已在缓冲池中</span></div>
<div class="line"><span class="lineno">  770</span>            Page* page = page_it-&gt;second;</div>
<div class="line"><span class="lineno">  771</span>            <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>[page_id]++;</div>
<div class="line"><span class="lineno">  772</span>            <a class="code hl_function" href="classsqlcc_1_1BufferPool.html#a9104d28e09173098b7afce301ea086a0">MoveToHead</a>(page_id);</div>
<div class="line"><span class="lineno">  773</span>            result.push_back(page);</div>
<div class="line"><span class="lineno">  774</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  775</span>            <span class="comment">// 页面不在缓冲池中，需要从磁盘读取</span></div>
<div class="line"><span class="lineno">  776</span>            pages_to_read.push_back(page_id);</div>
<div class="line"><span class="lineno">  777</span>            result.push_back(<span class="keyword">nullptr</span>); <span class="comment">// 占位符，稍后填充</span></div>
<div class="line"><span class="lineno">  778</span>        }</div>
<div class="line"><span class="lineno">  779</span>    }</div>
<div class="line"><span class="lineno">  780</span>    </div>
<div class="line"><span class="lineno">  781</span>    <span class="comment">// 如果没有需要从磁盘读取的页面，直接返回</span></div>
<div class="line"><span class="lineno">  782</span>    <span class="keywordflow">if</span> (pages_to_read.empty()) {</div>
<div class="line"><span class="lineno">  783</span>        <span class="keywordflow">return</span> result;</div>
<div class="line"><span class="lineno">  784</span>    }</div>
<div class="line"><span class="lineno">  785</span>    </div>
<div class="line"><span class="lineno">  786</span>    <span class="comment">// 按页面ID排序，优化磁盘访问模式</span></div>
<div class="line"><span class="lineno">  787</span>    std::sort(pages_to_read.begin(), pages_to_read.end());</div>
<div class="line"><span class="lineno">  788</span>    </div>
<div class="line"><span class="lineno">  789</span>    <span class="comment">// 检查缓冲池是否有足够空间</span></div>
<div class="line"><span class="lineno">  790</span>    <span class="keywordtype">size_t</span> available_space = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ab824ca05f9fc912a0d2def90f30412fa">pool_size_</a> - <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.size();</div>
<div class="line"><span class="lineno">  791</span>    <span class="keywordflow">if</span> (available_space &lt; pages_to_read.size()) {</div>
<div class="line"><span class="lineno">  792</span>        <span class="comment">// 需要替换一些页面</span></div>
<div class="line"><span class="lineno">  793</span>        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; pages_to_read.size() - available_space; ++i) {</div>
<div class="line"><span class="lineno">  794</span>            int32_t victim_page_id = <a class="code hl_function" href="classsqlcc_1_1BufferPool.html#a7e1ed47ea2f229397ec3e54b57d41868">ReplacePage</a>();</div>
<div class="line"><span class="lineno">  795</span>            <span class="keywordflow">if</span> (victim_page_id == -1) {</div>
<div class="line"><span class="lineno">  796</span>                <span class="comment">// 没有可替换的页面</span></div>
<div class="line"><span class="lineno">  797</span>                <a class="code hl_define" href="logger_8h.html#a84e665e7d7b3157724d71a7c46644680">SQLCC_LOG_ERROR</a>(<span class="stringliteral">&quot;Buffer pool is full and no pages can be replaced during batch fetch&quot;</span>);</div>
<div class="line"><span class="lineno">  798</span>                pages_to_read.resize(available_space);</div>
<div class="line"><span class="lineno">  799</span>                <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  800</span>            }</div>
<div class="line"><span class="lineno">  801</span>        }</div>
<div class="line"><span class="lineno">  802</span>    }</div>
<div class="line"><span class="lineno">  803</span>    </div>
<div class="line"><span class="lineno">  804</span>    <span class="comment">// 创建页面对象和数据缓冲区</span></div>
<div class="line"><span class="lineno">  805</span>    std::vector&lt;std::unique_ptr&lt;Page&gt;&gt; new_pages;</div>
<div class="line"><span class="lineno">  806</span>    new_pages.reserve(pages_to_read.size());</div>
<div class="line"><span class="lineno">  807</span>    std::vector&lt;char*&gt; data_buffers;</div>
<div class="line"><span class="lineno">  808</span>    data_buffers.reserve(pages_to_read.size());</div>
<div class="line"><span class="lineno">  809</span>    </div>
<div class="line"><span class="lineno">  810</span>    <span class="keywordflow">for</span> (int32_t page_id : pages_to_read) {</div>
<div class="line"><span class="lineno">  811</span>        <span class="keyword">auto</span> page = std::make_unique&lt;Page&gt;(page_id);</div>
<div class="line"><span class="lineno">  812</span>        data_buffers.push_back(page-&gt;GetData());</div>
<div class="line"><span class="lineno">  813</span>        new_pages.push_back(std::move(page));</div>
<div class="line"><span class="lineno">  814</span>    }</div>
<div class="line"><span class="lineno">  815</span>    </div>
<div class="line"><span class="lineno">  816</span>    <span class="comment">// 保存当前需要读取的页面信息，用于后续添加到缓冲池</span></div>
<div class="line"><span class="lineno">  817</span>    std::vector&lt;int32_t&gt; current_pages_to_read = pages_to_read;</div>
<div class="line"><span class="lineno">  818</span>    </div>
<div class="line"><span class="lineno">  819</span>    <span class="comment">// 释放锁，进行磁盘读取操作 - 这是避免死锁的关键修复</span></div>
<div class="line"><span class="lineno">  820</span>    lock.unlock();</div>
<div class="line"><span class="lineno">  821</span>    </div>
<div class="line"><span class="lineno">  822</span>    <span class="comment">// 现在在锁外进行磁盘读取操作</span></div>
<div class="line"><span class="lineno">  823</span>    <span class="keywordtype">size_t</span> success_count = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a85424d92e888ae0b2a0754e7fea7d089">disk_manager_</a>-&gt;<a class="code hl_function" href="classsqlcc_1_1DiskManager.html#a99ac63ca90d8e9d75a50eaf48ce6b9c2">BatchReadPages</a>(current_pages_to_read, data_buffers);</div>
<div class="line"><span class="lineno">  824</span>    </div>
<div class="line"><span class="lineno">  825</span>    <span class="comment">// 重新获取锁</span></div>
<div class="line"><span class="lineno">  826</span>    lock.lock();</div>
<div class="line"><span class="lineno">  827</span>    </div>
<div class="line"><span class="lineno">  828</span>    <span class="comment">// 将成功读取的页面添加到缓冲池</span></div>
<div class="line"><span class="lineno">  829</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; success_count; ++i) {</div>
<div class="line"><span class="lineno">  830</span>        int32_t page_id = pages_to_read[i];</div>
<div class="line"><span class="lineno">  831</span>        </div>
<div class="line"><span class="lineno">  832</span>        <span class="comment">// 将页面添加到缓冲池</span></div>
<div class="line"><span class="lineno">  833</span>        Page* page_ptr = new_pages[i].release(); <span class="comment">// 释放所有权，获取原始指针</span></div>
<div class="line"><span class="lineno">  834</span>        <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>[page_id] = page_ptr;</div>
<div class="line"><span class="lineno">  835</span>        <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>[page_id] = 1;</div>
<div class="line"><span class="lineno">  836</span>        </div>
<div class="line"><span class="lineno">  837</span>        <span class="comment">// 初始化脏页标记</span></div>
<div class="line"><span class="lineno">  838</span>        <span class="comment">// Why: 需要跟踪页面是否被修改过，以便在替换时写回磁盘</span></div>
<div class="line"><span class="lineno">  839</span>        <span class="comment">// What: 将页面标记为非脏页，因为刚从磁盘读取</span></div>
<div class="line"><span class="lineno">  840</span>        <span class="comment">// How: 在dirty_pages_哈希表中设置页面ID的值为false</span></div>
<div class="line"><span class="lineno">  841</span>        <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>[page_id] = <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  842</span>        </div>
<div class="line"><span class="lineno">  843</span>        <span class="comment">// 添加到LRU链表头部</span></div>
<div class="line"><span class="lineno">  844</span>        <span class="comment">// Why: 新加载的页面应该放在LRU链表头部，表示最近被访问</span></div>
<div class="line"><span class="lineno">  845</span>        <span class="comment">// What: 将页面ID添加到lru_list_的头部</span></div>
<div class="line"><span class="lineno">  846</span>        <span class="comment">// How: 使用push_front方法添加到链表头部，并在lru_map_中记录迭代器</span></div>
<div class="line"><span class="lineno">  847</span>        <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.push_front(page_id);</div>
<div class="line"><span class="lineno">  848</span>        <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ac6cc45a3a4a4ceabc7c0b57155fedd0b">lru_map_</a>[page_id] = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.begin();</div>
<div class="line"><span class="lineno">  849</span>        </div>
<div class="line"><span class="lineno">  850</span>        <span class="comment">// 在结果中填充页面指针</span></div>
<div class="line"><span class="lineno">  851</span>        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> j = 0; j &lt; result.size(); ++j) {</div>
<div class="line"><span class="lineno">  852</span>            <span class="keywordflow">if</span> (result[j] == <span class="keyword">nullptr</span>) {</div>
<div class="line"><span class="lineno">  853</span>                result[j] = page_ptr;</div>
<div class="line"><span class="lineno">  854</span>                <span class="keywordflow">break</span>;</div>
<div class="line"><span class="lineno">  855</span>            }</div>
<div class="line"><span class="lineno">  856</span>        }</div>
<div class="line"><span class="lineno">  857</span>    }</div>
<div class="line"><span class="lineno">  858</span>    </div>
<div class="line"><span class="lineno">  859</span>    <span class="comment">// 记录批量获取页面的信息，便于调试</span></div>
<div class="line"><span class="lineno">  860</span>    <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Batch fetched &quot;</span> + std::to_string(success_count) + <span class="stringliteral">&quot; pages from disk&quot;</span>);</div>
<div class="line"><span class="lineno">  861</span>    </div>
<div class="line"><span class="lineno">  862</span>    <span class="keywordflow">return</span> result;</div>
<div class="line"><span class="lineno">  863</span>}</div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_a08cc880334bde9136f0a614786afea5d"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">sqlcc::BufferPool::dirty_pages_</a></div><div class="ttdeci">std::unordered_map&lt; int32_t, bool &gt; dirty_pages_</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8h_source.html#l00372">buffer_pool.h:372</a></div></div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_a1aa80be20bb1b29ae3a8045fef1efb54"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">sqlcc::BufferPool::lru_list_</a></div><div class="ttdeci">std::list&lt; int32_t &gt; lru_list_</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8h_source.html#l00335">buffer_pool.h:335</a></div></div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_a7e1ed47ea2f229397ec3e54b57d41868"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#a7e1ed47ea2f229397ec3e54b57d41868">sqlcc::BufferPool::ReplacePage</a></div><div class="ttdeci">int32_t ReplacePage()</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8cpp_source.html#l00466">buffer_pool.cpp:466</a></div></div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_a9104d28e09173098b7afce301ea086a0"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#a9104d28e09173098b7afce301ea086a0">sqlcc::BufferPool::MoveToHead</a></div><div class="ttdeci">void MoveToHead(int32_t page_id)</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8cpp_source.html#l00612">buffer_pool.cpp:612</a></div></div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_a9b5dc3d10a60b03cdfa04a9629e46df1"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#a9b5dc3d10a60b03cdfa04a9629e46df1">sqlcc::BufferPool::access_stats_</a></div><div class="ttdeci">std::unordered_map&lt; int32_t, int &gt; access_stats_</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8h_source.html#l00384">buffer_pool.h:384</a></div></div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_ac6cc45a3a4a4ceabc7c0b57155fedd0b"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#ac6cc45a3a4a4ceabc7c0b57155fedd0b">sqlcc::BufferPool::lru_map_</a></div><div class="ttdeci">std::unordered_map&lt; int32_t, std::list&lt; int32_t &gt;::iterator &gt; lru_map_</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8h_source.html#l00341">buffer_pool.h:341</a></div></div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_ad5caecdc03c1393603275e080c052bd4"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">sqlcc::BufferPool::page_refs_</a></div><div class="ttdeci">std::unordered_map&lt; int32_t, int &gt; page_refs_</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8h_source.html#l00366">buffer_pool.h:366</a></div></div>
<div class="ttc" id="aclasssqlcc_1_1DiskManager_html_a99ac63ca90d8e9d75a50eaf48ce6b9c2"><div class="ttname"><a href="classsqlcc_1_1DiskManager.html#a99ac63ca90d8e9d75a50eaf48ce6b9c2">sqlcc::DiskManager::BatchReadPages</a></div><div class="ttdeci">bool BatchReadPages(const std::vector&lt; int32_t &gt; &amp;page_ids, std::vector&lt; char * &gt; &amp;page_data)</div><div class="ttdef"><b>Definition</b> <a href="disk__manager_8cpp_source.html#l00427">disk_manager.cpp:427</a></div></div>
<div class="ttc" id="alogger_8h_html_a745e4cf15e366f591854e16f189a8ccc"><div class="ttname"><a href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a></div><div class="ttdeci">#define SQLCC_LOG_DEBUG(msg)</div><div class="ttdoc">记录调试日志的宏定义</div><div class="ttdef"><b>Definition</b> <a href="logger_8h_source.html#l00265">logger.h:265</a></div></div>
<div class="ttc" id="alogger_8h_html_a84e665e7d7b3157724d71a7c46644680"><div class="ttname"><a href="logger_8h.html#a84e665e7d7b3157724d71a7c46644680">SQLCC_LOG_ERROR</a></div><div class="ttdeci">#define SQLCC_LOG_ERROR(msg)</div><div class="ttdoc">记录错误日志的宏定义</div><div class="ttdef"><b>Definition</b> <a href="logger_8h_source.html#l00292">logger.h:292</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="buffer__pool_8h_source.html#l00384">access_stats_</a>, <a class="el" href="disk__manager_8cpp_source.html#l00427">sqlcc::DiskManager::BatchReadPages()</a>, <a class="el" href="buffer__pool_8h_source.html#l00372">dirty_pages_</a>, <a class="el" href="buffer__pool_8h_source.html#l00311">disk_manager_</a>, <a class="el" href="buffer__pool_8h_source.html#l00347">latch_</a>, <a class="el" href="buffer__pool_8h_source.html#l00335">lru_list_</a>, <a class="el" href="buffer__pool_8h_source.html#l00341">lru_map_</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00612">MoveToHead()</a>, <a class="el" href="buffer__pool_8h_source.html#l00366">page_refs_</a>, <a class="el" href="buffer__pool_8h_source.html#l00329">page_table_</a>, <a class="el" href="buffer__pool_8h_source.html#l00323">pool_size_</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00466">ReplacePage()</a>, <a class="el" href="logger_8h_source.html#l00265">SQLCC_LOG_DEBUG</a>, and <a class="el" href="logger_8h_source.html#l00292">SQLCC_LOG_ERROR</a>.</p>

</div>
</div>
<a id="a273a6bdecc152b7c06e34d949d5475a1" name="a273a6bdecc152b7c06e34d949d5475a1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a273a6bdecc152b7c06e34d949d5475a1">&#9670;&#160;</a></span>BatchPrefetchPages()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool sqlcc::BufferPool::BatchPrefetchPages </td>
          <td>(</td>
          <td class="paramtype">const std::vector&lt; int32_t &gt; &amp;&#160;</td>
          <td class="paramname"><em>page_ids</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8cpp_source.html#l00930">930</a> of file <a class="el" href="buffer__pool_8cpp_source.html">buffer_pool.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  930</span>                                                                      {</div>
<div class="line"><span class="lineno">  931</span>    <span class="comment">// 检查预取是否启用</span></div>
<div class="line"><span class="lineno">  932</span>    <span class="keywordtype">bool</span> prefetch_enabled = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a52b7cc65c932b03c35af2e56916e9c9d">config_manager_</a>.<a class="code hl_function" href="classsqlcc_1_1ConfigManager.html#abc13ba41aba1d90bcf127993b65e8509">GetBool</a>(<span class="stringliteral">&quot;buffer_pool.enable_prefetch&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line"><span class="lineno">  933</span>    <span class="keywordflow">if</span> (!prefetch_enabled) {</div>
<div class="line"><span class="lineno">  934</span>        <span class="comment">// 预取功能被禁用，直接返回true</span></div>
<div class="line"><span class="lineno">  935</span>        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno">  936</span>    }</div>
<div class="line"><span class="lineno">  937</span>    </div>
<div class="line"><span class="lineno">  938</span>    <span class="comment">// 加锁保护并发访问 - 使用带超时的unique_lock以支持临时解锁避免死锁</span></div>
<div class="line"><span class="lineno">  939</span>    std::unique_lock&lt;std::timed_mutex&gt; lock(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#add85ac70113f80ae97898aada5f87994">latch_</a>, std::defer_lock);</div>
<div class="line"><span class="lineno">  940</span>    <span class="keywordflow">if</span> (!lock.try_lock_for(std::chrono::milliseconds(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#abe6985900d8804e2c0fe37299133eb08">read_lock_timeout_ms_</a>))) {</div>
<div class="line"><span class="lineno">  941</span>        <span class="comment">// 获取锁失败，避免长时间等待，记录警告并返回</span></div>
<div class="line"><span class="lineno">  942</span>        <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Failed to acquire buffer pool lock for batch prefetch, timeout after &quot;</span> + </div>
<div class="line"><span class="lineno">  943</span>                      std::to_string(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#abe6985900d8804e2c0fe37299133eb08">read_lock_timeout_ms_</a>) + <span class="stringliteral">&quot;ms, skipping&quot;</span>);</div>
<div class="line"><span class="lineno">  944</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  945</span>    }</div>
<div class="line"><span class="lineno">  946</span>    </div>
<div class="line"><span class="lineno">  947</span>    <span class="comment">// 获取预取策略</span></div>
<div class="line"><span class="lineno">  948</span>    std::string prefetch_strategy = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a52b7cc65c932b03c35af2e56916e9c9d">config_manager_</a>.<a class="code hl_function" href="classsqlcc_1_1ConfigManager.html#a66c5474c833aa179be1d7a0e2c219b22">GetString</a>(<span class="stringliteral">&quot;buffer_pool.prefetch_strategy&quot;</span>, <span class="stringliteral">&quot;sequential&quot;</span>);</div>
<div class="line"><span class="lineno">  949</span>    </div>
<div class="line"><span class="lineno">  950</span>    <span class="comment">// 过滤掉已经在缓冲池或预取队列中的页面</span></div>
<div class="line"><span class="lineno">  951</span>    std::vector&lt;int32_t&gt; pages_to_prefetch;</div>
<div class="line"><span class="lineno">  952</span>    <span class="keywordflow">for</span> (int32_t page_id : page_ids) {</div>
<div class="line"><span class="lineno">  953</span>        <span class="comment">// 检查页面ID是否有效</span></div>
<div class="line"><span class="lineno">  954</span>        <span class="keywordflow">if</span> (page_id &lt; 0) {</div>
<div class="line"><span class="lineno">  955</span>            <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno">  956</span>        }</div>
<div class="line"><span class="lineno">  957</span>        </div>
<div class="line"><span class="lineno">  958</span>        <span class="comment">// 检查页面是否已在缓冲池中</span></div>
<div class="line"><span class="lineno">  959</span>        <span class="keywordflow">if</span> (<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.find(page_id) != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.end()) {</div>
<div class="line"><span class="lineno">  960</span>            <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno">  961</span>        }</div>
<div class="line"><span class="lineno">  962</span>        </div>
<div class="line"><span class="lineno">  963</span>        <span class="comment">// 检查页面是否已在预取队列中</span></div>
<div class="line"><span class="lineno">  964</span>        <span class="keyword">auto</span> it = std::find(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a>.begin(), <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a>.end(), page_id);</div>
<div class="line"><span class="lineno">  965</span>        <span class="keywordflow">if</span> (it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a>.end()) {</div>
<div class="line"><span class="lineno">  966</span>            <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno">  967</span>        }</div>
<div class="line"><span class="lineno">  968</span>        </div>
<div class="line"><span class="lineno">  969</span>        pages_to_prefetch.push_back(page_id);</div>
<div class="line"><span class="lineno">  970</span>    }</div>
<div class="line"><span class="lineno">  971</span>    </div>
<div class="line"><span class="lineno">  972</span>    <span class="comment">// 如果没有需要预取的页面，直接返回true</span></div>
<div class="line"><span class="lineno">  973</span>    <span class="keywordflow">if</span> (pages_to_prefetch.empty()) {</div>
<div class="line"><span class="lineno">  974</span>        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno">  975</span>    }</div>
<div class="line"><span class="lineno">  976</span>    </div>
<div class="line"><span class="lineno">  977</span>    <span class="comment">// 按页面ID排序，优化磁盘访问模式</span></div>
<div class="line"><span class="lineno">  978</span>    std::sort(pages_to_prefetch.begin(), pages_to_prefetch.end());</div>
<div class="line"><span class="lineno">  979</span>    </div>
<div class="line"><span class="lineno">  980</span>    <span class="comment">// 保存需要预取的页面列表的副本，以便在锁外使用</span></div>
<div class="line"><span class="lineno">  981</span>    std::vector&lt;int32_t&gt; pages_to_prefetch_copy = pages_to_prefetch;</div>
<div class="line"><span class="lineno">  982</span>    </div>
<div class="line"><span class="lineno">  983</span>    <span class="comment">// 释放锁，进行磁盘I/O操作 - 避免死锁的关键修复</span></div>
<div class="line"><span class="lineno">  984</span>    lock.unlock();</div>
<div class="line"><span class="lineno">  985</span>    </div>
<div class="line"><span class="lineno">  986</span>    <span class="comment">// 使用磁盘管理器的批量预取功能（在锁外执行）</span></div>
<div class="line"><span class="lineno">  987</span>    <span class="keywordtype">bool</span> result = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a85424d92e888ae0b2a0754e7fea7d089">disk_manager_</a>-&gt;<a class="code hl_function" href="classsqlcc_1_1DiskManager.html#a0457223d46ee0ce517c43baf08739fa6">BatchPrefetchPages</a>(pages_to_prefetch_copy);</div>
<div class="line"><span class="lineno">  988</span>    </div>
<div class="line"><span class="lineno">  989</span>    <span class="comment">// 重新获取锁以更新预取队列</span></div>
<div class="line"><span class="lineno">  990</span>    <span class="keywordflow">if</span> (!lock.try_lock_for(std::chrono::milliseconds(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#abe6985900d8804e2c0fe37299133eb08">read_lock_timeout_ms_</a>))) {</div>
<div class="line"><span class="lineno">  991</span>        <span class="comment">// 获取锁失败，避免长时间等待，记录警告并返回</span></div>
<div class="line"><span class="lineno">  992</span>        <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Failed to acquire buffer pool lock for updating prefetch queue, timeout after &quot;</span> + </div>
<div class="line"><span class="lineno">  993</span>                      std::to_string(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#abe6985900d8804e2c0fe37299133eb08">read_lock_timeout_ms_</a>) + <span class="stringliteral">&quot;ms, skipping&quot;</span>);</div>
<div class="line"><span class="lineno">  994</span>        <span class="keywordflow">return</span> result; <span class="comment">// 返回磁盘操作的结果</span></div>
<div class="line"><span class="lineno">  995</span>    }</div>
<div class="line"><span class="lineno">  996</span>    </div>
<div class="line"><span class="lineno">  997</span>    <span class="comment">// 将页面ID添加到预取队列</span></div>
<div class="line"><span class="lineno">  998</span>    <span class="keywordflow">for</span> (int32_t page_id : pages_to_prefetch_copy) {</div>
<div class="line"><span class="lineno">  999</span>        <span class="comment">// 再次检查页面是否已在预取队列中（可能已被其他线程添加）</span></div>
<div class="line"><span class="lineno"> 1000</span>        <span class="keyword">auto</span> it = std::find(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a>.begin(), <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a>.end(), page_id);</div>
<div class="line"><span class="lineno"> 1001</span>        <span class="keywordflow">if</span> (it == <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a>.end()) {</div>
<div class="line"><span class="lineno"> 1002</span>            <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a>.push_back(page_id);</div>
<div class="line"><span class="lineno"> 1003</span>        }</div>
<div class="line"><span class="lineno"> 1004</span>    }</div>
<div class="line"><span class="lineno"> 1005</span>    </div>
<div class="line"><span class="lineno"> 1006</span>    <span class="comment">// 限制预取队列大小，避免内存占用过多</span></div>
<div class="line"><span class="lineno"> 1007</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a>.size() &gt; 1000) {</div>
<div class="line"><span class="lineno"> 1008</span>        <span class="comment">// 移除队列头部的旧预取页面</span></div>
<div class="line"><span class="lineno"> 1009</span>        <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a>.erase(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a>.begin(), <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a>.begin() + (<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a>.size() - 1000));</div>
<div class="line"><span class="lineno"> 1010</span>    }</div>
<div class="line"><span class="lineno"> 1011</span>    </div>
<div class="line"><span class="lineno"> 1012</span>    <span class="comment">// 记录预取页面的信息，便于调试</span></div>
<div class="line"><span class="lineno"> 1013</span>    <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Added &quot;</span> + std::to_string(pages_to_prefetch_copy.size()) + <span class="stringliteral">&quot; pages to prefetch queue&quot;</span>);</div>
<div class="line"><span class="lineno"> 1014</span>    </div>
<div class="line"><span class="lineno"> 1015</span>    <span class="keywordflow">return</span> result;</div>
<div class="line"><span class="lineno"> 1016</span>}</div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_af1b9545a6884861a6d10237e0131fee5"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">sqlcc::BufferPool::prefetch_queue_</a></div><div class="ttdeci">std::deque&lt; int32_t &gt; prefetch_queue_</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8h_source.html#l00378">buffer_pool.h:378</a></div></div>
<div class="ttc" id="aclasssqlcc_1_1ConfigManager_html_a66c5474c833aa179be1d7a0e2c219b22"><div class="ttname"><a href="classsqlcc_1_1ConfigManager.html#a66c5474c833aa179be1d7a0e2c219b22">sqlcc::ConfigManager::GetString</a></div><div class="ttdeci">std::string GetString(const std::string &amp;key, const std::string &amp;default_value=&quot;&quot;) const</div><div class="ttdoc">获取字符串类型配置值</div><div class="ttdef"><b>Definition</b> <a href="config__manager_8cpp_source.html#l00158">config_manager.cpp:158</a></div></div>
<div class="ttc" id="aclasssqlcc_1_1ConfigManager_html_abc13ba41aba1d90bcf127993b65e8509"><div class="ttname"><a href="classsqlcc_1_1ConfigManager.html#abc13ba41aba1d90bcf127993b65e8509">sqlcc::ConfigManager::GetBool</a></div><div class="ttdeci">bool GetBool(const std::string &amp;key, bool default_value=false) const</div><div class="ttdoc">获取布尔类型配置值</div><div class="ttdef"><b>Definition</b> <a href="config__manager_8cpp_source.html#l00117">config_manager.cpp:117</a></div></div>
<div class="ttc" id="aclasssqlcc_1_1DiskManager_html_a0457223d46ee0ce517c43baf08739fa6"><div class="ttname"><a href="classsqlcc_1_1DiskManager.html#a0457223d46ee0ce517c43baf08739fa6">sqlcc::DiskManager::BatchPrefetchPages</a></div><div class="ttdeci">bool BatchPrefetchPages(const std::vector&lt; int32_t &gt; &amp;page_ids)</div><div class="ttdef"><b>Definition</b> <a href="disk__manager_8cpp_source.html#l00528">disk_manager.cpp:528</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="disk__manager_8cpp_source.html#l00528">sqlcc::DiskManager::BatchPrefetchPages()</a>, <a class="el" href="buffer__pool_8h_source.html#l00317">config_manager_</a>, <a class="el" href="buffer__pool_8h_source.html#l00311">disk_manager_</a>, <a class="el" href="config__manager_8cpp_source.html#l00117">sqlcc::ConfigManager::GetBool()</a>, <a class="el" href="config__manager_8cpp_source.html#l00158">sqlcc::ConfigManager::GetString()</a>, <a class="el" href="buffer__pool_8h_source.html#l00347">latch_</a>, <a class="el" href="buffer__pool_8h_source.html#l00329">page_table_</a>, <a class="el" href="buffer__pool_8h_source.html#l00378">prefetch_queue_</a>, <a class="el" href="buffer__pool_8h_source.html#l00402">read_lock_timeout_ms_</a>, <a class="el" href="logger_8h_source.html#l00265">SQLCC_LOG_DEBUG</a>, and <a class="el" href="logger_8h_source.html#l00283">SQLCC_LOG_WARN</a>.</p>

</div>
</div>
<a id="a5e4a88f07f583dcecbf209dbbe1ad8e4" name="a5e4a88f07f583dcecbf209dbbe1ad8e4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5e4a88f07f583dcecbf209dbbe1ad8e4">&#9670;&#160;</a></span>DeletePage() <span class="overload">[1/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool sqlcc::BufferPool::DeletePage </td>
          <td>(</td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>page_id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8cpp_source.html#l00279">279</a> of file <a class="el" href="buffer__pool_8cpp_source.html">buffer_pool.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  279</span>                                           {</div>
<div class="line"><span class="lineno">  280</span>    <span class="comment">// 加锁保护并发访问 - 使用带超时的unique_lock以支持临时解锁避免死锁</span></div>
<div class="line"><span class="lineno">  281</span>    std::unique_lock&lt;std::timed_mutex&gt; lock(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#add85ac70113f80ae97898aada5f87994">latch_</a>, std::defer_lock);</div>
<div class="line"><span class="lineno">  282</span>    <span class="keywordflow">if</span> (!lock.try_lock_for(std::chrono::milliseconds(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6f94e56229b9887a9c10b6305825cf31">write_lock_timeout_ms_</a>))) {</div>
<div class="line"><span class="lineno">  283</span>        <span class="comment">// 获取锁失败，记录警告但不抛出异常，避免在高并发场景下级联失败</span></div>
<div class="line"><span class="lineno">  284</span>        <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Failed to acquire buffer pool lock for deleting page &quot;</span> + std::to_string(page_id) + </div>
<div class="line"><span class="lineno">  285</span>                      <span class="stringliteral">&quot;, timeout after &quot;</span> + std::to_string(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6f94e56229b9887a9c10b6305825cf31">write_lock_timeout_ms_</a>) + <span class="stringliteral">&quot;ms&quot;</span>);</div>
<div class="line"><span class="lineno">  286</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  287</span>    }</div>
<div class="line"><span class="lineno">  288</span>    </div>
<div class="line"><span class="lineno">  289</span>    <span class="comment">// 检查页面是否存在</span></div>
<div class="line"><span class="lineno">  290</span>    <span class="comment">// Why: 需要确保页面确实存在于缓冲池中，避免操作不存在的页面</span></div>
<div class="line"><span class="lineno">  291</span>    <span class="comment">// What: 在page_table_中查找页面ID</span></div>
<div class="line"><span class="lineno">  292</span>    <span class="comment">// How: 使用std::unordered_map的find方法查找</span></div>
<div class="line"><span class="lineno">  293</span>    <span class="keyword">auto</span> page_it = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.find(page_id);</div>
<div class="line"><span class="lineno">  294</span>    <span class="keywordflow">if</span> (page_it == <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.end()) {</div>
<div class="line"><span class="lineno">  295</span>        <span class="comment">// 页面不存在，记录警告并返回false</span></div>
<div class="line"><span class="lineno">  296</span>        <span class="comment">// Why: 页面不存在于缓冲池中，无法删除</span></div>
<div class="line"><span class="lineno">  297</span>        <span class="comment">// What: 记录警告信息并返回false表示操作失败</span></div>
<div class="line"><span class="lineno">  298</span>        <span class="comment">// How: 使用SQLCC_LOG_WARN记录警告，然后返回false</span></div>
<div class="line"><span class="lineno">  299</span>        <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Page ID &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; not found in buffer pool&quot;</span>);</div>
<div class="line"><span class="lineno">  300</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  301</span>    }</div>
<div class="line"><span class="lineno">  302</span>    </div>
<div class="line"><span class="lineno">  303</span>    <span class="comment">// 检查页面是否被引用</span></div>
<div class="line"><span class="lineno">  304</span>    <span class="comment">// Why: 被引用的页面正在被使用，不能删除</span></div>
<div class="line"><span class="lineno">  305</span>    <span class="comment">// What: 检查page_refs_中该页面的引用计数</span></div>
<div class="line"><span class="lineno">  306</span>    <span class="comment">// How: 使用std::unordered_map的find方法查找引用计数</span></div>
<div class="line"><span class="lineno">  307</span>    <span class="keyword">auto</span> ref_it = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>.find(page_id);</div>
<div class="line"><span class="lineno">  308</span>    <span class="keywordflow">if</span> (ref_it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>.end() &amp;&amp; ref_it-&gt;second &gt; 0) {</div>
<div class="line"><span class="lineno">  309</span>        <span class="comment">// 页面正在被使用，不能删除</span></div>
<div class="line"><span class="lineno">  310</span>        <span class="comment">// Why: 被引用的页面正在被其他操作使用，删除会导致数据不一致</span></div>
<div class="line"><span class="lineno">  311</span>        <span class="comment">// What: 记录警告信息并返回false表示操作失败</span></div>
<div class="line"><span class="lineno">  312</span>        <span class="comment">// How: 使用SQLCC_LOG_WARN记录警告，然后返回false</span></div>
<div class="line"><span class="lineno">  313</span>        <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Page ID &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; is still referenced, cannot delete&quot;</span>);</div>
<div class="line"><span class="lineno">  314</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  315</span>    }</div>
<div class="line"><span class="lineno">  316</span>    </div>
<div class="line"><span class="lineno">  317</span>    <span class="comment">// 检查是否为脏页并刷新</span></div>
<div class="line"><span class="lineno">  318</span>    <span class="comment">// Why: 如果页面是脏的，需要先写回磁盘才能安全删除</span></div>
<div class="line"><span class="lineno">  319</span>    <span class="comment">// What: 检查dirty_pages_中该页面是否为脏页，如果是则刷新</span></div>
<div class="line"><span class="lineno">  320</span>    <span class="comment">// How: 手动处理脏页刷新，避免递归调用FlushPage导致的锁问题</span></div>
<div class="line"><span class="lineno">  321</span>    <span class="keyword">auto</span> dirty_it = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>.find(page_id);</div>
<div class="line"><span class="lineno">  322</span>    <span class="keywordflow">if</span> (dirty_it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>.end() &amp;&amp; dirty_it-&gt;second) {</div>
<div class="line"><span class="lineno">  323</span>        <span class="comment">// 页面是脏的，需要先刷新到磁盘</span></div>
<div class="line"><span class="lineno">  324</span>        <span class="comment">// 使用与FlushPage相同的锁释放策略，但不递归调用FlushPage</span></div>
<div class="line"><span class="lineno">  325</span>        Page* page = page_it-&gt;second;</div>
<div class="line"><span class="lineno">  326</span>        <span class="keywordtype">void</span>* page_data = page-&gt;GetData();</div>
<div class="line"><span class="lineno">  327</span>        int32_t current_page_id = page_id;</div>
<div class="line"><span class="lineno">  328</span>        </div>
<div class="line"><span class="lineno">  329</span>        <span class="comment">// 临时释放锁，进行磁盘写入操作</span></div>
<div class="line"><span class="lineno">  330</span>        lock.unlock();</div>
<div class="line"><span class="lineno">  331</span>        </div>
<div class="line"><span class="lineno">  332</span>        <span class="comment">// 现在在锁外进行磁盘写入操作</span></div>
<div class="line"><span class="lineno">  333</span>        <span class="keywordtype">bool</span> write_success = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a85424d92e888ae0b2a0754e7fea7d089">disk_manager_</a>-&gt;<a class="code hl_function" href="classsqlcc_1_1DiskManager.html#aa65011bfb8783d5808787795c8786827">WritePage</a>(current_page_id, <span class="keyword">static_cast&lt;</span><span class="keyword">const </span><span class="keywordtype">char</span>*<span class="keyword">&gt;</span>(page_data));</div>
<div class="line"><span class="lineno">  334</span>        </div>
<div class="line"><span class="lineno">  335</span>        <span class="comment">// 重新获取锁 - 使用带超时的锁获取避免永久阻塞</span></div>
<div class="line"><span class="lineno">  336</span>        <span class="keywordflow">if</span> (!lock.try_lock_for(std::chrono::milliseconds(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6f94e56229b9887a9c10b6305825cf31">write_lock_timeout_ms_</a>))) {</div>
<div class="line"><span class="lineno">  337</span>            <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Failed to reacquire buffer pool lock after writing dirty page before deletion &quot;</span> + std::to_string(current_page_id));</div>
<div class="line"><span class="lineno">  338</span>            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  339</span>        }</div>
<div class="line"><span class="lineno">  340</span>        </div>
<div class="line"><span class="lineno">  341</span>        <span class="keywordflow">if</span> (!write_success) {</div>
<div class="line"><span class="lineno">  342</span>            <span class="comment">// 刷新失败，记录错误并返回false</span></div>
<div class="line"><span class="lineno">  343</span>            std::string error_msg = <span class="stringliteral">&quot;Failed to flush dirty page ID &quot;</span> + std::to_string(current_page_id) + <span class="stringliteral">&quot; before deletion&quot;</span>;</div>
<div class="line"><span class="lineno">  344</span>            <a class="code hl_define" href="logger_8h.html#a84e665e7d7b3157724d71a7c46644680">SQLCC_LOG_ERROR</a>(error_msg);</div>
<div class="line"><span class="lineno">  345</span>            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  346</span>        }</div>
<div class="line"><span class="lineno">  347</span>        </div>
<div class="line"><span class="lineno">  348</span>        <span class="comment">// 刷新成功后，清除脏页标记</span></div>
<div class="line"><span class="lineno">  349</span>        <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>[current_page_id] = <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  350</span>    }</div>
<div class="line"><span class="lineno">  351</span>    </div>
<div class="line"><span class="lineno">  352</span>    <span class="comment">// 从页面表中移除页面</span></div>
<div class="line"><span class="lineno">  353</span>    <span class="comment">// Why: 需要从页面表中删除页面，以释放页面占用的内存</span></div>
<div class="line"><span class="lineno">  354</span>    <span class="comment">// What: 从page_table_哈希表中删除页面ID</span></div>
<div class="line"><span class="lineno">  355</span>    <span class="comment">// How: 使用std::unordered_map的erase方法删除</span></div>
<div class="line"><span class="lineno">  356</span>    Page* page = page_it-&gt;second;</div>
<div class="line"><span class="lineno">  357</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.erase(page_it);</div>
<div class="line"><span class="lineno">  358</span>    </div>
<div class="line"><span class="lineno">  359</span>    <span class="comment">// 从引用计数表中移除</span></div>
<div class="line"><span class="lineno">  360</span>    <span class="comment">// Why: 需要从引用计数表中删除页面，以释放引用计数占用的内存</span></div>
<div class="line"><span class="lineno">  361</span>    <span class="comment">// What: 从page_refs_哈希表中删除页面ID</span></div>
<div class="line"><span class="lineno">  362</span>    <span class="comment">// How: 使用std::unordered_map的erase方法删除</span></div>
<div class="line"><span class="lineno">  363</span>    <span class="keywordflow">if</span> (ref_it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>.end()) {</div>
<div class="line"><span class="lineno">  364</span>        <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>.erase(ref_it);</div>
<div class="line"><span class="lineno">  365</span>    }</div>
<div class="line"><span class="lineno">  366</span>    </div>
<div class="line"><span class="lineno">  367</span>    <span class="comment">// 从脏页表中移除</span></div>
<div class="line"><span class="lineno">  368</span>    <span class="comment">// Why: 需要从脏页表中删除页面，以释放脏页标记占用的内存</span></div>
<div class="line"><span class="lineno">  369</span>    <span class="comment">// What: 从dirty_pages_哈希表中删除页面ID</span></div>
<div class="line"><span class="lineno">  370</span>    <span class="comment">// How: 使用std::unordered_map的erase方法删除</span></div>
<div class="line"><span class="lineno">  371</span>    <span class="keywordflow">if</span> (dirty_it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>.end()) {</div>
<div class="line"><span class="lineno">  372</span>        <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>.erase(dirty_it);</div>
<div class="line"><span class="lineno">  373</span>    }</div>
<div class="line"><span class="lineno">  374</span>    </div>
<div class="line"><span class="lineno">  375</span>    <span class="comment">// 从LRU链表中移除</span></div>
<div class="line"><span class="lineno">  376</span>    <span class="comment">// Why: 需要从LRU链表中删除页面，以维护LRU链表的正确性</span></div>
<div class="line"><span class="lineno">  377</span>    <span class="comment">// What: 从lru_list_和lru_map_中删除页面ID</span></div>
<div class="line"><span class="lineno">  378</span>    <span class="comment">// How: 使用RemoveFromLRUList方法从LRU链表中移除</span></div>
<div class="line"><span class="lineno">  379</span>    <a class="code hl_function" href="classsqlcc_1_1BufferPool.html#a09c7879bf4f4f7cee87b8baa89c25829">RemoveFromLRUList</a>(page_id);</div>
<div class="line"><span class="lineno">  380</span>    </div>
<div class="line"><span class="lineno">  381</span>    <span class="comment">// 释放页面对象内存</span></div>
<div class="line"><span class="lineno">  382</span>    <span class="comment">// Why: 需要释放页面对象占用的内存，避免内存泄漏</span></div>
<div class="line"><span class="lineno">  383</span>    <span class="comment">// What: 删除页面对象，释放其内存</span></div>
<div class="line"><span class="lineno">  384</span>    <span class="comment">// How: 使用delete运算符删除页面对象</span></div>
<div class="line"><span class="lineno">  385</span>    <span class="keyword">delete</span> page;</div>
<div class="line"><span class="lineno">  386</span>    </div>
<div class="line"><span class="lineno">  387</span>    <span class="comment">// 通知磁盘管理器释放页面ID</span></div>
<div class="line"><span class="lineno">  388</span>    <span class="comment">// Why: 需要通知磁盘管理器该页面ID可以被重用</span></div>
<div class="line"><span class="lineno">  389</span>    <span class="comment">// What: 调用磁盘管理器的DeallocatePage方法释放页面ID</span></div>
<div class="line"><span class="lineno">  390</span>    <span class="comment">// How: 传入页面ID，让磁盘管理器更新其内部状态</span></div>
<div class="line"><span class="lineno">  391</span>    <span class="keywordflow">if</span> (!<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a85424d92e888ae0b2a0754e7fea7d089">disk_manager_</a>-&gt;<a class="code hl_function" href="classsqlcc_1_1DiskManager.html#a9f1a72682c2a3a73e15cf9dcae9c213c">DeallocatePage</a>(page_id)) {</div>
<div class="line"><span class="lineno">  392</span>        <a class="code hl_define" href="logger_8h.html#a84e665e7d7b3157724d71a7c46644680">SQLCC_LOG_ERROR</a>(<span class="stringliteral">&quot;Failed to notify disk manager to deallocate page &quot;</span> + std::to_string(page_id));</div>
<div class="line"><span class="lineno">  393</span>        <span class="comment">// 这是一个非关键错误，我们可以继续清理内存中的页面</span></div>
<div class="line"><span class="lineno">  394</span>    }</div>
<div class="line"><span class="lineno">  395</span>    </div>
<div class="line"><span class="lineno">  396</span>    <span class="comment">// 记录页面删除成功，便于调试</span></div>
<div class="line"><span class="lineno">  397</span>    <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Page ID &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; deleted from buffer pool&quot;</span>);</div>
<div class="line"><span class="lineno">  398</span>    </div>
<div class="line"><span class="lineno">  399</span>    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno">  400</span>}</div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_a09c7879bf4f4f7cee87b8baa89c25829"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#a09c7879bf4f4f7cee87b8baa89c25829">sqlcc::BufferPool::RemoveFromLRUList</a></div><div class="ttdeci">void RemoveFromLRUList(int32_t page_id)</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8cpp_source.html#l01223">buffer_pool.cpp:1223</a></div></div>
<div class="ttc" id="aclasssqlcc_1_1DiskManager_html_a9f1a72682c2a3a73e15cf9dcae9c213c"><div class="ttname"><a href="classsqlcc_1_1DiskManager.html#a9f1a72682c2a3a73e15cf9dcae9c213c">sqlcc::DiskManager::DeallocatePage</a></div><div class="ttdeci">bool DeallocatePage(int32_t page_id)</div><div class="ttdef"><b>Definition</b> <a href="disk__manager_8cpp_source.html#l00383">disk_manager.cpp:383</a></div></div>
<div class="ttc" id="aclasssqlcc_1_1DiskManager_html_aa65011bfb8783d5808787795c8786827"><div class="ttname"><a href="classsqlcc_1_1DiskManager.html#aa65011bfb8783d5808787795c8786827">sqlcc::DiskManager::WritePage</a></div><div class="ttdeci">bool WritePage(int32_t page_id, const char *page_data)</div><div class="ttdoc">写入指定页的数据</div><div class="ttdef"><b>Definition</b> <a href="disk__manager_8cpp_source.html#l00145">disk_manager.cpp:145</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="disk__manager_8cpp_source.html#l00383">sqlcc::DiskManager::DeallocatePage()</a>, <a class="el" href="buffer__pool_8h_source.html#l00372">dirty_pages_</a>, <a class="el" href="buffer__pool_8h_source.html#l00311">disk_manager_</a>, <a class="el" href="page_8h_source.html#l00079">sqlcc::Page::GetData()</a>, <a class="el" href="buffer__pool_8h_source.html#l00347">latch_</a>, <a class="el" href="buffer__pool_8h_source.html#l00366">page_refs_</a>, <a class="el" href="buffer__pool_8h_source.html#l00329">page_table_</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01223">RemoveFromLRUList()</a>, <a class="el" href="logger_8h_source.html#l00265">SQLCC_LOG_DEBUG</a>, <a class="el" href="logger_8h_source.html#l00292">SQLCC_LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00283">SQLCC_LOG_WARN</a>, <a class="el" href="buffer__pool_8h_source.html#l00403">write_lock_timeout_ms_</a>, and <a class="el" href="disk__manager_8cpp_source.html#l00145">sqlcc::DiskManager::WritePage()</a>.</p>

</div>
</div>
<a id="a5e4a88f07f583dcecbf209dbbe1ad8e4" name="a5e4a88f07f583dcecbf209dbbe1ad8e4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5e4a88f07f583dcecbf209dbbe1ad8e4">&#9670;&#160;</a></span>DeletePage() <span class="overload">[2/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool sqlcc::BufferPool::DeletePage </td>
          <td>(</td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>page_id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a8c2da3780c6ec635bee229cae90ccb83" name="a8c2da3780c6ec635bee229cae90ccb83"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8c2da3780c6ec635bee229cae90ccb83">&#9670;&#160;</a></span>FetchPage() <span class="overload">[1/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classsqlcc_1_1Page.html">Page</a> * sqlcc::BufferPool::FetchPage </td>
          <td>(</td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>page_id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8cpp_source.html#l00063">63</a> of file <a class="el" href="buffer__pool_8cpp_source.html">buffer_pool.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   63</span>                                           {</div>
<div class="line"><span class="lineno">   64</span>    <span class="comment">// 加锁保护并发访问 - 使用带超时的unique_lock以支持临时解锁避免死锁</span></div>
<div class="line"><span class="lineno">   65</span>    std::unique_lock&lt;std::timed_mutex&gt; lock(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#add85ac70113f80ae97898aada5f87994">latch_</a>, std::defer_lock);</div>
<div class="line"><span class="lineno">   66</span>    <span class="keywordflow">if</span> (!lock.try_lock_for(std::chrono::milliseconds(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#abe6985900d8804e2c0fe37299133eb08">read_lock_timeout_ms_</a>))) {</div>
<div class="line"><span class="lineno">   67</span>        <span class="comment">// 获取锁失败，记录警告但不抛出异常，避免在高并发场景下级联失败</span></div>
<div class="line"><span class="lineno">   68</span>        <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Failed to acquire buffer pool lock for fetching page &quot;</span> + std::to_string(page_id) + </div>
<div class="line"><span class="lineno">   69</span>                      <span class="stringliteral">&quot;, timeout after &quot;</span> + std::to_string(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#abe6985900d8804e2c0fe37299133eb08">read_lock_timeout_ms_</a>) + <span class="stringliteral">&quot;ms&quot;</span>);</div>
<div class="line"><span class="lineno">   70</span>        <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line"><span class="lineno">   71</span>    }</div>
<div class="line"><span class="lineno">   72</span>    <span class="comment">// 更新访问统计（用于预测性预取）</span></div>
<div class="line"><span class="lineno">   73</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a9b5dc3d10a60b03cdfa04a9629e46df1">access_stats_</a>[page_id]++;</div>
<div class="line"><span class="lineno">   74</span>    </div>
<div class="line"><span class="lineno">   75</span>    <span class="comment">// 检查页面是否已经在缓冲池中</span></div>
<div class="line"><span class="lineno">   76</span>    <span class="comment">// Why: 如果页面已在内存中，可以直接返回，避免昂贵的磁盘I/O操作</span></div>
<div class="line"><span class="lineno">   77</span>    <span class="comment">// What: 在page_table_哈希表中查找页面ID</span></div>
<div class="line"><span class="lineno">   78</span>    <span class="comment">// How: 使用std::unordered_map的find方法，时间复杂度为O(1)</span></div>
<div class="line"><span class="lineno">   79</span>    <span class="keyword">auto</span> it = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.find(page_id);</div>
<div class="line"><span class="lineno">   80</span>    <span class="keywordflow">if</span> (it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.end()) {</div>
<div class="line"><span class="lineno">   81</span>        <span class="comment">// 页面已在缓冲池中，增加引用计数</span></div>
<div class="line"><span class="lineno">   82</span>        <span class="comment">// Why: 引用计数用于跟踪页面被多少个操作引用，防止正在使用的页面被替换</span></div>
<div class="line"><span class="lineno">   83</span>        <span class="comment">// What: 增加page_refs_中该页面的引用计数</span></div>
<div class="line"><span class="lineno">   84</span>        <span class="comment">// How: 直接递增引用计数值</span></div>
<div class="line"><span class="lineno">   85</span>        <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>[page_id]++;</div>
<div class="line"><span class="lineno">   86</span>        </div>
<div class="line"><span class="lineno">   87</span>        <span class="comment">// 将页面移到LRU链表头部，表示最近被访问</span></div>
<div class="line"><span class="lineno">   88</span>        <span class="comment">// Why: LRU算法需要维护页面的访问顺序，最近访问的页面应该放在链表头部</span></div>
<div class="line"><span class="lineno">   89</span>        <span class="comment">// What: 调用MoveToHead方法将页面移到LRU链表头部</span></div>
<div class="line"><span class="lineno">   90</span>        <span class="comment">// How: MoveToHead会更新LRU链表和映射表</span></div>
<div class="line"><span class="lineno">   91</span>        <a class="code hl_function" href="classsqlcc_1_1BufferPool.html#a9104d28e09173098b7afce301ea086a0">MoveToHead</a>(page_id);</div>
<div class="line"><span class="lineno">   92</span>        </div>
<div class="line"><span class="lineno">   93</span>        <span class="comment">// 减少日志记录以提高性能</span></div>
<div class="line"><span class="lineno">   94</span>        <span class="comment">// SQLCC_LOG_DEBUG(&quot;Page ID &quot; + std::to_string(page_id) + &quot; found in buffer pool&quot;);</span></div>
<div class="line"><span class="lineno">   95</span>        <span class="keywordflow">return</span> it-&gt;second;</div>
<div class="line"><span class="lineno">   96</span>    }</div>
<div class="line"><span class="lineno">   97</span> </div>
<div class="line"><span class="lineno">   98</span>    <span class="comment">// 页面不在缓冲池中，需要从磁盘读取</span></div>
<div class="line"><span class="lineno">   99</span>    <span class="comment">// Why: 页面不在内存中，必须从磁盘加载，这是数据库I/O操作的主要来源</span></div>
<div class="line"><span class="lineno">  100</span>    <span class="comment">// What: 记录页面不在缓冲池中的信息</span></div>
<div class="line"><span class="lineno">  101</span>    <span class="comment">// How: 使用SQLCC_LOG_DEBUG宏记录调试级别日志</span></div>
<div class="line"><span class="lineno">  102</span>    <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Page ID &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; not found in buffer pool, reading from disk&quot;</span>);</div>
<div class="line"><span class="lineno">  103</span>    </div>
<div class="line"><span class="lineno">  104</span>    <span class="comment">// 创建新页面</span></div>
<div class="line"><span class="lineno">  105</span>    <span class="keyword">auto</span> page = std::make_unique&lt;Page&gt;(page_id);</div>
<div class="line"><span class="lineno">  106</span>    <span class="keywordtype">void</span>* page_data = page-&gt;GetData();</div>
<div class="line"><span class="lineno">  107</span>    int32_t current_page_id = page_id;</div>
<div class="line"><span class="lineno">  108</span>    </div>
<div class="line"><span class="lineno">  109</span>    <span class="comment">// 释放锁，进行磁盘读取操作 - 修复死锁问题</span></div>
<div class="line"><span class="lineno">  110</span>    lock.unlock();</div>
<div class="line"><span class="lineno">  111</span>    </div>
<div class="line"><span class="lineno">  112</span>    <span class="comment">// 现在在锁外进行磁盘读取操作</span></div>
<div class="line"><span class="lineno">  113</span>    <span class="keywordtype">bool</span> read_success = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a85424d92e888ae0b2a0754e7fea7d089">disk_manager_</a>-&gt;<a class="code hl_function" href="classsqlcc_1_1DiskManager.html#aee0ac0ad4df85f6522d355be6f47598b">ReadPage</a>(current_page_id, <span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span>*<span class="keyword">&gt;</span>(page_data));</div>
<div class="line"><span class="lineno">  114</span>    </div>
<div class="line"><span class="lineno">  115</span>    <span class="comment">// 重新获取锁 - 使用带超时的锁获取避免永久阻塞</span></div>
<div class="line"><span class="lineno">  116</span>    <span class="keywordflow">if</span> (!lock.try_lock_for(std::chrono::milliseconds(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#abe6985900d8804e2c0fe37299133eb08">read_lock_timeout_ms_</a>))) {</div>
<div class="line"><span class="lineno">  117</span>        <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Failed to reacquire buffer pool lock after reading page &quot;</span> + std::to_string(current_page_id) + </div>
<div class="line"><span class="lineno">  118</span>                      <span class="stringliteral">&quot;, timeout after &quot;</span> + std::to_string(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#abe6985900d8804e2c0fe37299133eb08">read_lock_timeout_ms_</a>) + <span class="stringliteral">&quot;ms&quot;</span>);</div>
<div class="line"><span class="lineno">  119</span>        <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line"><span class="lineno">  120</span>    }</div>
<div class="line"><span class="lineno">  121</span>    </div>
<div class="line"><span class="lineno">  122</span>    <span class="keywordflow">if</span> (!read_success) {</div>
<div class="line"><span class="lineno">  123</span>        <span class="comment">// 如果读取失败，说明页面不存在，返回nullptr</span></div>
<div class="line"><span class="lineno">  124</span>        <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Failed to read page ID &quot;</span> + std::to_string(current_page_id) + <span class="stringliteral">&quot; from disk, page does not exist&quot;</span>);</div>
<div class="line"><span class="lineno">  125</span>        <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line"><span class="lineno">  126</span>    }</div>
<div class="line"><span class="lineno">  127</span> </div>
<div class="line"><span class="lineno">  128</span>    <span class="comment">// 如果缓冲池已满，需要替换页面</span></div>
<div class="line"><span class="lineno">  129</span>    <span class="comment">// Why: 缓冲池大小有限，当已满时必须选择一个页面进行替换</span></div>
<div class="line"><span class="lineno">  130</span>    <span class="comment">// What: 检查page_table_的大小是否超过pool_size_</span></div>
<div class="line"><span class="lineno">  131</span>    <span class="comment">// How: 比较page_table_.size()和pool_size_</span></div>
<div class="line"><span class="lineno">  132</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.size() &gt;= <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ab824ca05f9fc912a0d2def90f30412fa">pool_size_</a>) {</div>
<div class="line"><span class="lineno">  133</span>        <span class="comment">// 记录缓冲池已满的信息，便于调试</span></div>
<div class="line"><span class="lineno">  134</span>        <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Buffer pool is full, replacing page&quot;</span>);</div>
<div class="line"><span class="lineno">  135</span>        </div>
<div class="line"><span class="lineno">  136</span>        <span class="comment">// 调用ReplacePage方法选择一个页面进行替换</span></div>
<div class="line"><span class="lineno">  137</span>        <span class="comment">// Why: 需要选择一个页面进行替换，为新页面腾出空间</span></div>
<div class="line"><span class="lineno">  138</span>        <span class="comment">// What: ReplacePage方法使用LRU算法选择一个可替换的页面</span></div>
<div class="line"><span class="lineno">  139</span>        <span class="comment">// How: 从LRU链表尾部开始查找，找到第一个引用计数为0的页面</span></div>
<div class="line"><span class="lineno">  140</span>        int32_t replaced_page_id = <a class="code hl_function" href="classsqlcc_1_1BufferPool.html#a7e1ed47ea2f229397ec3e54b57d41868">ReplacePage</a>();</div>
<div class="line"><span class="lineno">  141</span>        <span class="keywordflow">if</span> (replaced_page_id == -1) {</div>
<div class="line"><span class="lineno">  142</span>            <span class="comment">// 无法替换页面，抛出异常</span></div>
<div class="line"><span class="lineno">  143</span>            <span class="comment">// Why: 如果所有页面都在使用中，无法为新页面腾出空间，必须报错</span></div>
<div class="line"><span class="lineno">  144</span>            <span class="comment">// What: 创建错误消息并抛出BufferPoolException异常</span></div>
<div class="line"><span class="lineno">  145</span>            <span class="comment">// How: 使用throw关键字抛出异常</span></div>
<div class="line"><span class="lineno">  146</span>            std::string error_msg = <span class="stringliteral">&quot;Failed to replace page in buffer pool&quot;</span>;</div>
<div class="line"><span class="lineno">  147</span>            <a class="code hl_define" href="logger_8h.html#a84e665e7d7b3157724d71a7c46644680">SQLCC_LOG_ERROR</a>(error_msg);</div>
<div class="line"><span class="lineno">  148</span>            <span class="keywordflow">throw</span> BufferPoolException(error_msg);</div>
<div class="line"><span class="lineno">  149</span>        }</div>
<div class="line"><span class="lineno">  150</span>    }</div>
<div class="line"><span class="lineno">  151</span> </div>
<div class="line"><span class="lineno">  152</span>    <span class="comment">// 添加到页面表</span></div>
<div class="line"><span class="lineno">  153</span>    <span class="comment">// Why: 需要将新加载的页面加入缓冲池管理，以便后续查找和使用</span></div>
<div class="line"><span class="lineno">  154</span>    <span class="comment">// What: 将页面对象添加到page_table_哈希表中</span></div>
<div class="line"><span class="lineno">  155</span>    <span class="comment">// How: 使用页面ID作为键，使用std::move转移页面对象的所有权</span></div>
<div class="line"><span class="lineno">  156</span>    <span class="comment">// 将页面添加到缓冲池</span></div>
<div class="line"><span class="lineno">  157</span>    Page* page_ptr = page.release(); <span class="comment">// 释放所有权，获取原始指针</span></div>
<div class="line"><span class="lineno">  158</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>[page_id] = page_ptr;</div>
<div class="line"><span class="lineno">  159</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>[page_id] = 1;</div>
<div class="line"><span class="lineno">  160</span>    </div>
<div class="line"><span class="lineno">  161</span>    <span class="comment">// 初始化脏页标记</span></div>
<div class="line"><span class="lineno">  162</span>    <span class="comment">// Why: 需要跟踪页面是否被修改过，以便在替换时写回磁盘</span></div>
<div class="line"><span class="lineno">  163</span>    <span class="comment">// What: 将页面标记为非脏页，因为刚从磁盘读取</span></div>
<div class="line"><span class="lineno">  164</span>    <span class="comment">// How: 在dirty_pages_哈希表中设置页面ID的值为false</span></div>
<div class="line"><span class="lineno">  165</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>[page_id] = <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  166</span>    </div>
<div class="line"><span class="lineno">  167</span>    <span class="comment">// 添加到LRU链表头部</span></div>
<div class="line"><span class="lineno">  168</span>    <span class="comment">// Why: 新加载的页面应该放在LRU链表头部，表示最近被访问</span></div>
<div class="line"><span class="lineno">  169</span>    <span class="comment">// What: 将页面ID添加到lru_list_的头部</span></div>
<div class="line"><span class="lineno">  170</span>    <span class="comment">// How: 使用push_front方法添加到链表头部，并在lru_map_中记录迭代器</span></div>
<div class="line"><span class="lineno">  171</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.push_front(page_id);</div>
<div class="line"><span class="lineno">  172</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ac6cc45a3a4a4ceabc7c0b57155fedd0b">lru_map_</a>[page_id] = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.begin();</div>
<div class="line"><span class="lineno">  173</span>    </div>
<div class="line"><span class="lineno">  174</span>    <span class="comment">// 记录页面加载成功的信息，便于调试</span></div>
<div class="line"><span class="lineno">  175</span>    <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Page ID &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; loaded into buffer pool&quot;</span>);</div>
<div class="line"><span class="lineno">  176</span> </div>
<div class="line"><span class="lineno">  177</span>    <span class="keywordflow">return</span> page_ptr;</div>
<div class="line"><span class="lineno">  178</span>}</div>
<div class="ttc" id="aclasssqlcc_1_1DiskManager_html_aee0ac0ad4df85f6522d355be6f47598b"><div class="ttname"><a href="classsqlcc_1_1DiskManager.html#aee0ac0ad4df85f6522d355be6f47598b">sqlcc::DiskManager::ReadPage</a></div><div class="ttdeci">bool ReadPage(int32_t page_id, char *page_data)</div><div class="ttdef"><b>Definition</b> <a href="disk__manager_8cpp_source.html#l00258">disk_manager.cpp:258</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="buffer__pool_8h_source.html#l00384">access_stats_</a>, <a class="el" href="buffer__pool_8h_source.html#l00372">dirty_pages_</a>, <a class="el" href="buffer__pool_8h_source.html#l00311">disk_manager_</a>, <a class="el" href="buffer__pool_8h_source.html#l00347">latch_</a>, <a class="el" href="buffer__pool_8h_source.html#l00335">lru_list_</a>, <a class="el" href="buffer__pool_8h_source.html#l00341">lru_map_</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00612">MoveToHead()</a>, <a class="el" href="buffer__pool_8h_source.html#l00366">page_refs_</a>, <a class="el" href="buffer__pool_8h_source.html#l00329">page_table_</a>, <a class="el" href="buffer__pool_8h_source.html#l00323">pool_size_</a>, <a class="el" href="buffer__pool_8h_source.html#l00402">read_lock_timeout_ms_</a>, <a class="el" href="disk__manager_8cpp_source.html#l00258">sqlcc::DiskManager::ReadPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00466">ReplacePage()</a>, <a class="el" href="logger_8h_source.html#l00265">SQLCC_LOG_DEBUG</a>, <a class="el" href="logger_8h_source.html#l00292">SQLCC_LOG_ERROR</a>, and <a class="el" href="logger_8h_source.html#l00283">SQLCC_LOG_WARN</a>.</p>

</div>
</div>
<a id="a8c2da3780c6ec635bee229cae90ccb83" name="a8c2da3780c6ec635bee229cae90ccb83"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8c2da3780c6ec635bee229cae90ccb83">&#9670;&#160;</a></span>FetchPage() <span class="overload">[2/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classsqlcc_1_1Page.html">Page</a> * sqlcc::BufferPool::FetchPage </td>
          <td>(</td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>page_id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ae0096083797a56ae4ed4b28800bc5ad6" name="ae0096083797a56ae4ed4b28800bc5ad6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae0096083797a56ae4ed4b28800bc5ad6">&#9670;&#160;</a></span>FindVictimPage() <span class="overload">[1/2]</span></h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">int32_t sqlcc::BufferPool::FindVictimPage </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool__new_8cpp_source.html#l00400">400</a> of file <a class="el" href="buffer__pool__new_8cpp_source.html">buffer_pool_new.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  400</span>                                   {</div>
<div class="line"><span class="lineno">  401</span>  <span class="comment">// Look for a page with ref count 0, starting from LRU tail</span></div>
<div class="line"><span class="lineno">  402</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span> it = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.rbegin(); it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.rend(); ++it) {</div>
<div class="line"><span class="lineno">  403</span>    int32_t page_id = *it;</div>
<div class="line"><span class="lineno">  404</span>    <span class="keyword">auto</span> ref_it = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>.find(page_id);</div>
<div class="line"><span class="lineno">  405</span>    <span class="keywordflow">if</span> (ref_it == <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>.end() || ref_it-&gt;second == 0) {</div>
<div class="line"><span class="lineno">  406</span>      <span class="keywordflow">return</span> page_id;</div>
<div class="line"><span class="lineno">  407</span>    }</div>
<div class="line"><span class="lineno">  408</span>  }</div>
<div class="line"><span class="lineno">  409</span>  <span class="keywordflow">return</span> -1; <span class="comment">// No victim found</span></div>
<div class="line"><span class="lineno">  410</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="ae0096083797a56ae4ed4b28800bc5ad6" name="ae0096083797a56ae4ed4b28800bc5ad6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae0096083797a56ae4ed4b28800bc5ad6">&#9670;&#160;</a></span>FindVictimPage() <span class="overload">[2/2]</span></h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">int32_t sqlcc::BufferPool::FindVictimPage </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<a id="a72b69be11e8c034a712b605c3741b09f" name="a72b69be11e8c034a712b605c3741b09f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a72b69be11e8c034a712b605c3741b09f">&#9670;&#160;</a></span>FlushAllPages()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void sqlcc::BufferPool::FlushAllPages </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8cpp_source.html#l00869">869</a> of file <a class="el" href="buffer__pool_8cpp_source.html">buffer_pool.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  869</span>                               {</div>
<div class="line"><span class="lineno">  870</span>    <span class="comment">// 加锁保护并发访问 - 使用带超时的unique_lock以支持临时解锁避免死锁</span></div>
<div class="line"><span class="lineno">  871</span>    std::unique_lock&lt;std::timed_mutex&gt; lock(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#add85ac70113f80ae97898aada5f87994">latch_</a>, std::defer_lock);</div>
<div class="line"><span class="lineno">  872</span>    <span class="keywordflow">if</span> (!lock.try_lock_for(std::chrono::milliseconds(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6f94e56229b9887a9c10b6305825cf31">write_lock_timeout_ms_</a>))) {</div>
<div class="line"><span class="lineno">  873</span>        <span class="keywordflow">throw</span> LockTimeoutException(<span class="stringliteral">&quot;Failed to acquire buffer pool lock within timeout: &quot;</span> + std::to_string(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6f94e56229b9887a9c10b6305825cf31">write_lock_timeout_ms_</a>) + <span class="stringliteral">&quot;ms&quot;</span>);</div>
<div class="line"><span class="lineno">  874</span>    }</div>
<div class="line"><span class="lineno">  875</span>    </div>
<div class="line"><span class="lineno">  876</span>    <span class="comment">// 记录开始刷新所有页面的信息，便于调试</span></div>
<div class="line"><span class="lineno">  877</span>    <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Starting to flush all pages in buffer pool&quot;</span>);</div>
<div class="line"><span class="lineno">  878</span>    </div>
<div class="line"><span class="lineno">  879</span>    <span class="comment">// 收集所有脏页信息，以便在锁外处理</span></div>
<div class="line"><span class="lineno">  880</span>    std::vector&lt;std::pair&lt;int32_t, Page*&gt;&gt; dirty_pages_to_flush;</div>
<div class="line"><span class="lineno">  881</span>    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; pair : <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>) {</div>
<div class="line"><span class="lineno">  882</span>        int32_t page_id = pair.first;</div>
<div class="line"><span class="lineno">  883</span>        Page* page = pair.second;</div>
<div class="line"><span class="lineno">  884</span>        </div>
<div class="line"><span class="lineno">  885</span>        <span class="comment">// 检查页面是否为脏页</span></div>
<div class="line"><span class="lineno">  886</span>        <span class="keyword">auto</span> dirty_it = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>.find(page_id);</div>
<div class="line"><span class="lineno">  887</span>        <span class="keywordflow">if</span> (dirty_it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>.end() &amp;&amp; dirty_it-&gt;second) {</div>
<div class="line"><span class="lineno">  888</span>            dirty_pages_to_flush.emplace_back(page_id, page);</div>
<div class="line"><span class="lineno">  889</span>        }</div>
<div class="line"><span class="lineno">  890</span>    }</div>
<div class="line"><span class="lineno">  891</span>    </div>
<div class="line"><span class="lineno">  892</span>    lock.unlock(); <span class="comment">// 释放锁，进行磁盘I/O操作 - 避免死锁的关键修复</span></div>
<div class="line"><span class="lineno">  893</span>    </div>
<div class="line"><span class="lineno">  894</span>    <span class="keywordtype">size_t</span> flushed_count = 0;</div>
<div class="line"><span class="lineno">  895</span>    <span class="comment">// 在锁外执行磁盘I/O操作</span></div>
<div class="line"><span class="lineno">  896</span>    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; [page_id, page] : dirty_pages_to_flush) {</div>
<div class="line"><span class="lineno">  897</span>        <span class="comment">// 执行磁盘写入操作</span></div>
<div class="line"><span class="lineno">  898</span>        <span class="keywordflow">if</span> (<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a85424d92e888ae0b2a0754e7fea7d089">disk_manager_</a>-&gt;<a class="code hl_function" href="classsqlcc_1_1DiskManager.html#aa65011bfb8783d5808787795c8786827">WritePage</a>(page_id, page-&gt;GetData())) {</div>
<div class="line"><span class="lineno">  899</span>            <span class="comment">// 成功写入后尝试重新获取锁以更新脏页标记</span></div>
<div class="line"><span class="lineno">  900</span>            std::unique_lock&lt;std::timed_mutex&gt; update_lock(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#add85ac70113f80ae97898aada5f87994">latch_</a>, std::defer_lock);</div>
<div class="line"><span class="lineno">  901</span>            <span class="keywordflow">if</span> (update_lock.try_lock_for(std::chrono::milliseconds(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6f94e56229b9887a9c10b6305825cf31">write_lock_timeout_ms_</a>))) {</div>
<div class="line"><span class="lineno">  902</span>                <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>[page_id] = <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  903</span>                update_lock.unlock();</div>
<div class="line"><span class="lineno">  904</span>            } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  905</span>                <span class="comment">// 获取锁失败，记录警告，但继续处理其他页面</span></div>
<div class="line"><span class="lineno">  906</span>                <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Failed to acquire buffer pool lock for updating dirty page flag after flushing page &quot;</span> + std::to_string(page_id));</div>
<div class="line"><span class="lineno">  907</span>            }</div>
<div class="line"><span class="lineno">  908</span>            </div>
<div class="line"><span class="lineno">  909</span>            flushed_count++;</div>
<div class="line"><span class="lineno">  910</span>            <span class="comment">// 记录页面刷新成功的信息，便于调试</span></div>
<div class="line"><span class="lineno">  911</span>            <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Page ID &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; flushed to disk&quot;</span>);</div>
<div class="line"><span class="lineno">  912</span>        } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  913</span>            <span class="comment">// 写入失败，记录错误</span></div>
<div class="line"><span class="lineno">  914</span>            std::string error_msg = <span class="stringliteral">&quot;Failed to flush page ID &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; to disk&quot;</span>;</div>
<div class="line"><span class="lineno">  915</span>            <a class="code hl_define" href="logger_8h.html#a84e665e7d7b3157724d71a7c46644680">SQLCC_LOG_ERROR</a>(error_msg);</div>
<div class="line"><span class="lineno">  916</span>        }</div>
<div class="line"><span class="lineno">  917</span>    }</div>
<div class="line"><span class="lineno">  918</span>    </div>
<div class="line"><span class="lineno">  919</span>    <span class="comment">// 重新获取锁以记录最终统计信息</span></div>
<div class="line"><span class="lineno">  920</span>    lock.lock();</div>
<div class="line"><span class="lineno">  921</span>    </div>
<div class="line"><span class="lineno">  922</span>    <span class="comment">// 记录刷新所有页面的统计信息，便于调试</span></div>
<div class="line"><span class="lineno">  923</span>    <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Flushed &quot;</span> + std::to_string(flushed_count) + <span class="stringliteral">&quot; pages to disk&quot;</span>);</div>
<div class="line"><span class="lineno">  924</span>}</div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="buffer__pool_8h_source.html#l00372">dirty_pages_</a>, <a class="el" href="buffer__pool_8h_source.html#l00311">disk_manager_</a>, <a class="el" href="buffer__pool_8h_source.html#l00347">latch_</a>, <a class="el" href="buffer__pool_8h_source.html#l00329">page_table_</a>, <a class="el" href="logger_8h_source.html#l00265">SQLCC_LOG_DEBUG</a>, <a class="el" href="logger_8h_source.html#l00292">SQLCC_LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00283">SQLCC_LOG_WARN</a>, <a class="el" href="buffer__pool_8h_source.html#l00403">write_lock_timeout_ms_</a>, and <a class="el" href="disk__manager_8cpp_source.html#l00145">sqlcc::DiskManager::WritePage()</a>.</p>

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l00045">~BufferPool()</a>.</p>

</div>
</div>
<a id="acdce915c78dc7e4db0c56f0593803e73" name="acdce915c78dc7e4db0c56f0593803e73"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acdce915c78dc7e4db0c56f0593803e73">&#9670;&#160;</a></span>FlushPage() <span class="overload">[1/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool sqlcc::BufferPool::FlushPage </td>
          <td>(</td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>page_id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8cpp_source.html#l00184">184</a> of file <a class="el" href="buffer__pool_8cpp_source.html">buffer_pool.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  184</span>                                          {</div>
<div class="line"><span class="lineno">  185</span>    <span class="comment">// 加锁保护并发访问 - 使用带超时的unique_lock以支持临时解锁避免死锁</span></div>
<div class="line"><span class="lineno">  186</span>    std::unique_lock&lt;std::timed_mutex&gt; lock(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#add85ac70113f80ae97898aada5f87994">latch_</a>, std::defer_lock);</div>
<div class="line"><span class="lineno">  187</span>    <span class="keywordflow">if</span> (!lock.try_lock_for(std::chrono::milliseconds(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad51347a7c8621ac0b20071c60fef39ee">lock_timeout_ms_</a>))) {</div>
<div class="line"><span class="lineno">  188</span>        <span class="comment">// 获取锁失败，记录警告但不抛出异常，避免在高并发场景下级联失败</span></div>
<div class="line"><span class="lineno">  189</span>        <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Failed to acquire buffer pool lock for flushing page &quot;</span> + std::to_string(page_id));</div>
<div class="line"><span class="lineno">  190</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  191</span>    }</div>
<div class="line"><span class="lineno">  192</span>    </div>
<div class="line"><span class="lineno">  193</span>    <span class="comment">// 检查页面是否存在</span></div>
<div class="line"><span class="lineno">  194</span>    <span class="comment">// Why: 需要确保页面确实存在于缓冲池中，避免操作不存在的页面</span></div>
<div class="line"><span class="lineno">  195</span>    <span class="comment">// What: 在page_table_中查找页面ID</span></div>
<div class="line"><span class="lineno">  196</span>    <span class="comment">// How: 使用std::unordered_map的find方法查找</span></div>
<div class="line"><span class="lineno">  197</span>    <span class="keyword">auto</span> page_it = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.find(page_id);</div>
<div class="line"><span class="lineno">  198</span>    <span class="keywordflow">if</span> (page_it == <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.end()) {</div>
<div class="line"><span class="lineno">  199</span>        <span class="comment">// 页面不存在，记录警告并返回false</span></div>
<div class="line"><span class="lineno">  200</span>        <span class="comment">// Why: 页面不存在于缓冲池中，无法刷新</span></div>
<div class="line"><span class="lineno">  201</span>        <span class="comment">// What: 记录警告信息并返回false表示操作失败</span></div>
<div class="line"><span class="lineno">  202</span>        <span class="comment">// How: 使用SQLCC_LOG_WARN记录警告，然后返回false</span></div>
<div class="line"><span class="lineno">  203</span>        <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Page ID &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; not found in buffer pool&quot;</span>);</div>
<div class="line"><span class="lineno">  204</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  205</span>    }</div>
<div class="line"><span class="lineno">  206</span>    </div>
<div class="line"><span class="lineno">  207</span>    <span class="comment">// 检查是否为脏页</span></div>
<div class="line"><span class="lineno">  208</span>    <span class="comment">// Why: 只有脏页才需要写回磁盘，非脏页不需要写回</span></div>
<div class="line"><span class="lineno">  209</span>    <span class="comment">// What: 检查dirty_pages_中该页面是否为脏页</span></div>
<div class="line"><span class="lineno">  210</span>    <span class="comment">// How: 使用std::unordered_map的find方法查找脏页标记</span></div>
<div class="line"><span class="lineno">  211</span>    <span class="keyword">auto</span> dirty_it = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>.find(page_id);</div>
<div class="line"><span class="lineno">  212</span>    <span class="keywordflow">if</span> (dirty_it == <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>.end() || !dirty_it-&gt;second) {</div>
<div class="line"><span class="lineno">  213</span>        <span class="comment">// 页面不是脏页，不需要刷新</span></div>
<div class="line"><span class="lineno">  214</span>        <span class="comment">// Why: 非脏页的内容与磁盘一致，不需要写回</span></div>
<div class="line"><span class="lineno">  215</span>        <span class="comment">// What: 记录调试信息并返回true表示操作成功（无需操作）</span></div>
<div class="line"><span class="lineno">  216</span>        <span class="comment">// How: 使用SQLCC_LOG_DEBUG记录调试级别日志</span></div>
<div class="line"><span class="lineno">  217</span>        <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Page ID &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; is not dirty, no flush needed&quot;</span>);</div>
<div class="line"><span class="lineno">  218</span>        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno">  219</span>    }</div>
<div class="line"><span class="lineno">  220</span>    </div>
<div class="line"><span class="lineno">  221</span>    <span class="comment">// 检查是否模拟刷新失败（仅用于测试）</span></div>
<div class="line"><span class="lineno">  222</span>    <span class="comment">// Why: 需要测试缓冲池在磁盘写入失败时的错误处理逻辑</span></div>
<div class="line"><span class="lineno">  223</span>    <span class="comment">// What: 检查simulate_flush_failure_标志</span></div>
<div class="line"><span class="lineno">  224</span>    <span class="comment">// How: 如果标志为true，则模拟刷新失败</span></div>
<div class="line"><span class="lineno">  225</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6a1ad43771d8cae7413806fbb7db31dd">simulate_flush_failure_</a>) {</div>
<div class="line"><span class="lineno">  226</span>        <span class="comment">// 模拟刷新失败，记录错误并返回false</span></div>
<div class="line"><span class="lineno">  227</span>        <span class="comment">// Why: 用于测试错误处理逻辑</span></div>
<div class="line"><span class="lineno">  228</span>        <span class="comment">// What: 记录错误信息并返回false表示操作失败</span></div>
<div class="line"><span class="lineno">  229</span>        <span class="comment">// How: 使用SQLCC_LOG_ERROR记录错误级别日志</span></div>
<div class="line"><span class="lineno">  230</span>        std::string error_msg = <span class="stringliteral">&quot;Simulated flush failure for page ID &quot;</span> + std::to_string(page_id);</div>
<div class="line"><span class="lineno">  231</span>        <a class="code hl_define" href="logger_8h.html#a84e665e7d7b3157724d71a7c46644680">SQLCC_LOG_ERROR</a>(error_msg);</div>
<div class="line"><span class="lineno">  232</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  233</span>    }</div>
<div class="line"><span class="lineno">  234</span>    </div>
<div class="line"><span class="lineno">  235</span>    <span class="comment">// 将页面数据写入磁盘 - 修复死锁问题：使用unique_lock支持锁释放机制</span></div>
<div class="line"><span class="lineno">  236</span>    <span class="comment">// Why: 脏页的内容与磁盘不一致，需要写回磁盘以保证数据持久性，但必须在锁外进行磁盘I/O以避免死锁</span></div>
<div class="line"><span class="lineno">  237</span>    <span class="comment">// What: 先在锁内准备数据，然后解锁调用DiskManager，再重新加锁继续操作</span></div>
<div class="line"><span class="lineno">  238</span>    <span class="comment">// How: 与ReplacePage方法采用相同的锁释放策略，避免BufferPool latch_和DiskManager io_mutex_之间的循环等待</span></div>
<div class="line"><span class="lineno">  239</span>    Page* page = page_it-&gt;second;</div>
<div class="line"><span class="lineno">  240</span>    <span class="keywordtype">void</span>* page_data = page-&gt;GetData();</div>
<div class="line"><span class="lineno">  241</span>    int32_t current_page_id = page_id;</div>
<div class="line"><span class="lineno">  242</span>    </div>
<div class="line"><span class="lineno">  243</span>    <span class="comment">// 释放锁，进行磁盘写入操作 - 这是避免死锁的关键修复</span></div>
<div class="line"><span class="lineno">  244</span>    lock.unlock();</div>
<div class="line"><span class="lineno">  245</span>    </div>
<div class="line"><span class="lineno">  246</span>    <span class="comment">// 现在在锁外进行磁盘写入操作</span></div>
<div class="line"><span class="lineno">  247</span>    <span class="keywordtype">bool</span> write_success = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a85424d92e888ae0b2a0754e7fea7d089">disk_manager_</a>-&gt;<a class="code hl_function" href="classsqlcc_1_1DiskManager.html#aa65011bfb8783d5808787795c8786827">WritePage</a>(current_page_id, <span class="keyword">static_cast&lt;</span><span class="keyword">const </span><span class="keywordtype">char</span>*<span class="keyword">&gt;</span>(page_data));</div>
<div class="line"><span class="lineno">  248</span>    </div>
<div class="line"><span class="lineno">  249</span>    <span class="comment">// 重新获取锁 - 使用带超时的锁获取避免永久阻塞</span></div>
<div class="line"><span class="lineno">  250</span>    <span class="keywordflow">if</span> (!lock.try_lock_for(std::chrono::milliseconds(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6f94e56229b9887a9c10b6305825cf31">write_lock_timeout_ms_</a>))) {</div>
<div class="line"><span class="lineno">  251</span>        <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Failed to reacquire buffer pool lock after writing page &quot;</span> + std::to_string(current_page_id) + </div>
<div class="line"><span class="lineno">  252</span>                      <span class="stringliteral">&quot;, timeout after &quot;</span> + std::to_string(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6f94e56229b9887a9c10b6305825cf31">write_lock_timeout_ms_</a>) + <span class="stringliteral">&quot;ms&quot;</span>);</div>
<div class="line"><span class="lineno">  253</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  254</span>    }</div>
<div class="line"><span class="lineno">  255</span>    </div>
<div class="line"><span class="lineno">  256</span>    <span class="keywordflow">if</span> (!write_success) {</div>
<div class="line"><span class="lineno">  257</span>        <span class="comment">// 写入失败，记录错误并返回false</span></div>
<div class="line"><span class="lineno">  258</span>        std::string error_msg = <span class="stringliteral">&quot;Failed to write page ID &quot;</span> + std::to_string(current_page_id) + <span class="stringliteral">&quot; to disk&quot;</span>;</div>
<div class="line"><span class="lineno">  259</span>        <a class="code hl_define" href="logger_8h.html#a84e665e7d7b3157724d71a7c46644680">SQLCC_LOG_ERROR</a>(error_msg);</div>
<div class="line"><span class="lineno">  260</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  261</span>    }</div>
<div class="line"><span class="lineno">  262</span>    </div>
<div class="line"><span class="lineno">  263</span>    <span class="comment">// 刷新成功后，清除脏页标记</span></div>
<div class="line"><span class="lineno">  264</span>    <span class="comment">// Why: 页面已经成功写回磁盘，不再需要标记为脏页</span></div>
<div class="line"><span class="lineno">  265</span>    <span class="comment">// What: 将dirty_pages_中该页面的脏页标记设置为false</span></div>
<div class="line"><span class="lineno">  266</span>    <span class="comment">// How: 直接设置哈希表中的值为false</span></div>
<div class="line"><span class="lineno">  267</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>[page_id] = <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  268</span>    </div>
<div class="line"><span class="lineno">  269</span>    <span class="comment">// 记录页面刷新成功的信息，便于调试</span></div>
<div class="line"><span class="lineno">  270</span>    <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Page ID &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; flushed to disk&quot;</span>);</div>
<div class="line"><span class="lineno">  271</span>    </div>
<div class="line"><span class="lineno">  272</span>    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno">  273</span>}</div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="buffer__pool_8h_source.html#l00372">dirty_pages_</a>, <a class="el" href="buffer__pool_8h_source.html#l00311">disk_manager_</a>, <a class="el" href="page_8h_source.html#l00079">sqlcc::Page::GetData()</a>, <a class="el" href="buffer__pool_8h_source.html#l00347">latch_</a>, <a class="el" href="buffer__pool_8h_source.html#l00404">lock_timeout_ms_</a>, <a class="el" href="buffer__pool_8h_source.html#l00329">page_table_</a>, <a class="el" href="buffer__pool_8h_source.html#l00396">simulate_flush_failure_</a>, <a class="el" href="logger_8h_source.html#l00265">SQLCC_LOG_DEBUG</a>, <a class="el" href="logger_8h_source.html#l00292">SQLCC_LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00283">SQLCC_LOG_WARN</a>, <a class="el" href="buffer__pool_8h_source.html#l00403">write_lock_timeout_ms_</a>, and <a class="el" href="disk__manager_8cpp_source.html#l00145">sqlcc::DiskManager::WritePage()</a>.</p>

</div>
</div>
<a id="acdce915c78dc7e4db0c56f0593803e73" name="acdce915c78dc7e4db0c56f0593803e73"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acdce915c78dc7e4db0c56f0593803e73">&#9670;&#160;</a></span>FlushPage() <span class="overload">[2/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool sqlcc::BufferPool::FlushPage </td>
          <td>(</td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>page_id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ab2fa434814c78b58319ff560a4e40a68" name="ab2fa434814c78b58319ff560a4e40a68"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab2fa434814c78b58319ff560a4e40a68">&#9670;&#160;</a></span>GetMetrics()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structsqlcc_1_1BufferPool_1_1Metrics.html">BufferPool::Metrics</a> sqlcc::BufferPool::GetMetrics </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool__new_8cpp_source.html#l00380">380</a> of file <a class="el" href="buffer__pool__new_8cpp_source.html">buffer_pool_new.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  380</span>                                               {</div>
<div class="line"><span class="lineno">  381</span>  std::unique_lock&lt;std::timed_mutex&gt; lock(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#add85ac70113f80ae97898aada5f87994">latch_</a>);</div>
<div class="line"><span class="lineno">  382</span>  <span class="keywordflow">return</span> <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#aeb20d8120bd8b322067b9337bca45bdb">metrics_</a>;</div>
<div class="line"><span class="lineno">  383</span>}</div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_aeb20d8120bd8b322067b9337bca45bdb"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#aeb20d8120bd8b322067b9337bca45bdb">sqlcc::BufferPool::metrics_</a></div><div class="ttdeci">Metrics metrics_</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool__new_8h_source.html#l00100">buffer_pool_new.h:100</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="adb70334238fa82ee756e810081158641" name="adb70334238fa82ee756e810081158641"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adb70334238fa82ee756e810081158641">&#9670;&#160;</a></span>GetPoolSize() <span class="overload">[1/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">size_t sqlcc::BufferPool::GetPoolSize </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="adb70334238fa82ee756e810081158641" name="adb70334238fa82ee756e810081158641"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adb70334238fa82ee756e810081158641">&#9670;&#160;</a></span>GetPoolSize() <span class="overload">[2/2]</span></h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">size_t sqlcc::BufferPool::GetPoolSize </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool__new_8h_source.html#l00072">72</a> of file <a class="el" href="buffer__pool__new_8h_source.html">buffer_pool_new.h</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   72</span>{ <span class="keywordflow">return</span> <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ab824ca05f9fc912a0d2def90f30412fa">pool_size_</a>; }</div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="buffer__pool_8h_source.html#l00323">pool_size_</a>.</p>

</div>
</div>
<a id="ae8380c66c015d26bf1df75981312bd55" name="ae8380c66c015d26bf1df75981312bd55"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae8380c66c015d26bf1df75981312bd55">&#9670;&#160;</a></span>GetStats()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::unordered_map&lt; std::string, double &gt; sqlcc::BufferPool::GetStats </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8cpp_source.html#l01140">1140</a> of file <a class="el" href="buffer__pool_8cpp_source.html">buffer_pool.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno"> 1140</span>                                                               {</div>
<div class="line"><span class="lineno"> 1141</span>    <span class="comment">// 加锁保护并发访问 - 使用unique_lock以支持临时解锁避免死锁</span></div>
<div class="line"><span class="lineno"> 1142</span>    std::unique_lock&lt;std::timed_mutex&gt; lock(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#add85ac70113f80ae97898aada5f87994">latch_</a>);</div>
<div class="line"><span class="lineno"> 1143</span>    </div>
<div class="line"><span class="lineno"> 1144</span>    <span class="comment">// 创建统计信息哈希表</span></div>
<div class="line"><span class="lineno"> 1145</span>    <span class="comment">// Why: 需要返回一个包含所有统计信息的哈希表</span></div>
<div class="line"><span class="lineno"> 1146</span>    <span class="comment">// What: 创建std::unordered_map来存储各种统计信息</span></div>
<div class="line"><span class="lineno"> 1147</span>    <span class="comment">// How: 使用默认构造函数创建空的哈希表</span></div>
<div class="line"><span class="lineno"> 1148</span>    std::unordered_map&lt;std::string, double&gt; stats;</div>
<div class="line"><span class="lineno"> 1149</span>    </div>
<div class="line"><span class="lineno"> 1150</span>    <span class="comment">// 计算基本统计信息</span></div>
<div class="line"><span class="lineno"> 1151</span>    <span class="comment">// Why: 需要提供缓冲池的基本状态信息</span></div>
<div class="line"><span class="lineno"> 1152</span>    <span class="comment">// What: 计算页面数量、引用计数、脏页数量等</span></div>
<div class="line"><span class="lineno"> 1153</span>    <span class="comment">// How: 使用哈希表的size()方法和遍历计算各种统计信息</span></div>
<div class="line"><span class="lineno"> 1154</span>    stats[<span class="stringliteral">&quot;pool_size&quot;</span>] = <span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span>(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ab824ca05f9fc912a0d2def90f30412fa">pool_size_</a>);</div>
<div class="line"><span class="lineno"> 1155</span>    stats[<span class="stringliteral">&quot;current_pages&quot;</span>] = <span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span>(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.size());</div>
<div class="line"><span class="lineno"> 1156</span>    stats[<span class="stringliteral">&quot;free_pages&quot;</span>] = <span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span>(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ab824ca05f9fc912a0d2def90f30412fa">pool_size_</a> - <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.size());</div>
<div class="line"><span class="lineno"> 1157</span>    </div>
<div class="line"><span class="lineno"> 1158</span>    <span class="comment">// 计算引用统计信息</span></div>
<div class="line"><span class="lineno"> 1159</span>    int32_t total_refs = 0;</div>
<div class="line"><span class="lineno"> 1160</span>    int32_t max_refs = 0;</div>
<div class="line"><span class="lineno"> 1161</span>    int32_t min_refs = INT32_MAX;</div>
<div class="line"><span class="lineno"> 1162</span>    </div>
<div class="line"><span class="lineno"> 1163</span>    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; pair : <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>) {</div>
<div class="line"><span class="lineno"> 1164</span>        int32_t refs = pair.second;</div>
<div class="line"><span class="lineno"> 1165</span>        total_refs += refs;</div>
<div class="line"><span class="lineno"> 1166</span>        max_refs = std::max(max_refs, refs);</div>
<div class="line"><span class="lineno"> 1167</span>        min_refs = std::min(min_refs, refs);</div>
<div class="line"><span class="lineno"> 1168</span>    }</div>
<div class="line"><span class="lineno"> 1169</span>    </div>
<div class="line"><span class="lineno"> 1170</span>    stats[<span class="stringliteral">&quot;total_refs&quot;</span>] = total_refs;</div>
<div class="line"><span class="lineno"> 1171</span>    stats[<span class="stringliteral">&quot;max_refs&quot;</span>] = (<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>.empty() ? 0 : max_refs);</div>
<div class="line"><span class="lineno"> 1172</span>    stats[<span class="stringliteral">&quot;min_refs&quot;</span>] = (<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>.empty() ? 0 : min_refs);</div>
<div class="line"><span class="lineno"> 1173</span>    stats[<span class="stringliteral">&quot;avg_refs&quot;</span>] = (<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>.empty() ? 0 : total_refs / <span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span>(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>.size()));</div>
<div class="line"><span class="lineno"> 1174</span>    </div>
<div class="line"><span class="lineno"> 1175</span>    <span class="comment">// 计算脏页统计信息</span></div>
<div class="line"><span class="lineno"> 1176</span>    int32_t dirty_pages = 0;</div>
<div class="line"><span class="lineno"> 1177</span>    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; pair : <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>) {</div>
<div class="line"><span class="lineno"> 1178</span>        <span class="keywordflow">if</span> (pair.second) {</div>
<div class="line"><span class="lineno"> 1179</span>            dirty_pages++;</div>
<div class="line"><span class="lineno"> 1180</span>        }</div>
<div class="line"><span class="lineno"> 1181</span>    }</div>
<div class="line"><span class="lineno"> 1182</span>    </div>
<div class="line"><span class="lineno"> 1183</span>    stats[<span class="stringliteral">&quot;dirty_pages&quot;</span>] = dirty_pages;</div>
<div class="line"><span class="lineno"> 1184</span>    stats[<span class="stringliteral">&quot;clean_pages&quot;</span>] = <span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span>(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.size() - dirty_pages);</div>
<div class="line"><span class="lineno"> 1185</span>    stats[<span class="stringliteral">&quot;dirty_ratio&quot;</span>] = (<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.empty() ? 0 : (dirty_pages * 100) / <span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span>(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.size()));</div>
<div class="line"><span class="lineno"> 1186</span>    </div>
<div class="line"><span class="lineno"> 1187</span>    <span class="comment">// LRU链表统计信息</span></div>
<div class="line"><span class="lineno"> 1188</span>    stats[<span class="stringliteral">&quot;lru_size&quot;</span>] = <span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span>(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.size());</div>
<div class="line"><span class="lineno"> 1189</span>    stats[<span class="stringliteral">&quot;lru_front&quot;</span>] = (<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.empty() ? -1 : <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.front());</div>
<div class="line"><span class="lineno"> 1190</span>    stats[<span class="stringliteral">&quot;lru_back&quot;</span>] = (<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.empty() ? -1 : <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.back());</div>
<div class="line"><span class="lineno"> 1191</span>    </div>
<div class="line"><span class="lineno"> 1192</span>    <span class="comment">// 预取队列统计信息</span></div>
<div class="line"><span class="lineno"> 1193</span>    stats[<span class="stringliteral">&quot;prefetch_queue_size&quot;</span>] = <span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span>(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a>.size());</div>
<div class="line"><span class="lineno"> 1194</span>    stats[<span class="stringliteral">&quot;prefetch_enabled&quot;</span>] = (<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a52b7cc65c932b03c35af2e56916e9c9d">config_manager_</a>.<a class="code hl_function" href="classsqlcc_1_1ConfigManager.html#abc13ba41aba1d90bcf127993b65e8509">GetBool</a>(<span class="stringliteral">&quot;buffer_pool.enable_prefetch&quot;</span>, <span class="keyword">true</span>) ? 1 : 0);</div>
<div class="line"><span class="lineno"> 1195</span>    </div>
<div class="line"><span class="lineno"> 1196</span>    <span class="comment">// 命中率统计信息（这里使用简单的访问计数作为示例）</span></div>
<div class="line"><span class="lineno"> 1197</span>    <span class="comment">// 注意：实际的命中率计算需要更复杂的逻辑，这里仅提供基础统计</span></div>
<div class="line"><span class="lineno"> 1198</span>    stats[<span class="stringliteral">&quot;cache_hits&quot;</span>] = <span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span>(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.size()); <span class="comment">// 简化实现</span></div>
<div class="line"><span class="lineno"> 1199</span>    stats[<span class="stringliteral">&quot;cache_misses&quot;</span>] = <span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span>(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a>.size()); <span class="comment">// 简化实现</span></div>
<div class="line"><span class="lineno"> 1200</span>    stats[<span class="stringliteral">&quot;hit_ratio&quot;</span>] = (<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.empty() ? 0 : (<span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span>(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.size()) * 100) / </div>
<div class="line"><span class="lineno"> 1201</span>                        (<span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span>(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.size()) + <span class="keyword">static_cast&lt;</span>int32_t<span class="keyword">&gt;</span>(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a>.size())));</div>
<div class="line"><span class="lineno"> 1202</span>    </div>
<div class="line"><span class="lineno"> 1203</span>    <span class="comment">// 记录获取统计信息的调试信息</span></div>
<div class="line"><span class="lineno"> 1204</span>    <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Buffer pool stats collected: &quot;</span> + std::to_string(stats.size()) + <span class="stringliteral">&quot; metrics&quot;</span>);</div>
<div class="line"><span class="lineno"> 1205</span>    </div>
<div class="line"><span class="lineno"> 1206</span>    <span class="keywordflow">return</span> stats;</div>
<div class="line"><span class="lineno"> 1207</span>}</div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="buffer__pool_8h_source.html#l00317">config_manager_</a>, <a class="el" href="buffer__pool_8h_source.html#l00372">dirty_pages_</a>, <a class="el" href="config__manager_8cpp_source.html#l00117">sqlcc::ConfigManager::GetBool()</a>, <a class="el" href="buffer__pool_8h_source.html#l00347">latch_</a>, <a class="el" href="buffer__pool_8h_source.html#l00335">lru_list_</a>, <a class="el" href="buffer__pool_8h_source.html#l00366">page_refs_</a>, <a class="el" href="buffer__pool_8h_source.html#l00329">page_table_</a>, <a class="el" href="buffer__pool_8h_source.html#l00323">pool_size_</a>, <a class="el" href="buffer__pool_8h_source.html#l00378">prefetch_queue_</a>, and <a class="el" href="logger_8h_source.html#l00265">SQLCC_LOG_DEBUG</a>.</p>

</div>
</div>
<a id="aba069be10dee7e9c2a4520be1398b788" name="aba069be10dee7e9c2a4520be1398b788"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aba069be10dee7e9c2a4520be1398b788">&#9670;&#160;</a></span>GetUsedPages() <span class="overload">[1/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">size_t sqlcc::BufferPool::GetUsedPages </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool__new_8cpp_source.html#l00386">386</a> of file <a class="el" href="buffer__pool__new_8cpp_source.html">buffer_pool_new.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  386</span>                                      {</div>
<div class="line"><span class="lineno">  387</span>  std::unique_lock&lt;std::timed_mutex&gt; lock(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#add85ac70113f80ae97898aada5f87994">latch_</a>);</div>
<div class="line"><span class="lineno">  388</span>  <span class="keywordflow">return</span> <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.size();</div>
<div class="line"><span class="lineno">  389</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="aba069be10dee7e9c2a4520be1398b788" name="aba069be10dee7e9c2a4520be1398b788"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aba069be10dee7e9c2a4520be1398b788">&#9670;&#160;</a></span>GetUsedPages() <span class="overload">[2/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">size_t sqlcc::BufferPool::GetUsedPages </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a15debb0b4def8bba65cf439d55ee9476" name="a15debb0b4def8bba65cf439d55ee9476"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a15debb0b4def8bba65cf439d55ee9476">&#9670;&#160;</a></span>IsPageInBuffer() <span class="overload">[1/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool sqlcc::BufferPool::IsPageInBuffer </td>
          <td>(</td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>page_id</em></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8cpp_source.html#l01244">1244</a> of file <a class="el" href="buffer__pool_8cpp_source.html">buffer_pool.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno"> 1244</span>                                                     {</div>
<div class="line"><span class="lineno"> 1245</span>    <span class="comment">// 加锁保护并发访问 - 使用unique_lock以支持临时解锁避免死锁</span></div>
<div class="line"><span class="lineno"> 1246</span>    std::unique_lock&lt;std::timed_mutex&gt; lock(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#add85ac70113f80ae97898aada5f87994">latch_</a>);</div>
<div class="line"><span class="lineno"> 1247</span>    </div>
<div class="line"><span class="lineno"> 1248</span>    <span class="comment">// 检查页面是否在页面表中</span></div>
<div class="line"><span class="lineno"> 1249</span>    <span class="comment">// Why: 页面表存储了当前在缓冲池中的所有页面</span></div>
<div class="line"><span class="lineno"> 1250</span>    <span class="comment">// What: 检查page_table_哈希表是否包含指定的页面ID</span></div>
<div class="line"><span class="lineno"> 1251</span>    <span class="comment">// How: 使用std::unordered_map的find方法查找页面ID</span></div>
<div class="line"><span class="lineno"> 1252</span>    <span class="keywordflow">return</span> <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.find(page_id) != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.end();</div>
<div class="line"><span class="lineno"> 1253</span>}</div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="buffer__pool_8h_source.html#l00347">latch_</a>, and <a class="el" href="buffer__pool_8h_source.html#l00329">page_table_</a>.</p>

</div>
</div>
<a id="a15debb0b4def8bba65cf439d55ee9476" name="a15debb0b4def8bba65cf439d55ee9476"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a15debb0b4def8bba65cf439d55ee9476">&#9670;&#160;</a></span>IsPageInBuffer() <span class="overload">[2/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool sqlcc::BufferPool::IsPageInBuffer </td>
          <td>(</td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>page_id</em></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a9104d28e09173098b7afce301ea086a0" name="a9104d28e09173098b7afce301ea086a0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9104d28e09173098b7afce301ea086a0">&#9670;&#160;</a></span>MoveToHead()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void sqlcc::BufferPool::MoveToHead </td>
          <td>(</td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>page_id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8cpp_source.html#l00612">612</a> of file <a class="el" href="buffer__pool_8cpp_source.html">buffer_pool.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  612</span>                                           {</div>
<div class="line"><span class="lineno">  613</span>    <span class="comment">// 查找页面在LRU链表中的位置</span></div>
<div class="line"><span class="lineno">  614</span>    <span class="comment">// Why: 需要知道页面在LRU链表中的位置，才能进行移动操作</span></div>
<div class="line"><span class="lineno">  615</span>    <span class="comment">// What: 在lru_map_中查找页面ID的迭代器</span></div>
<div class="line"><span class="lineno">  616</span>    <span class="comment">// How: 使用std::unordered_map的find方法查找迭代器</span></div>
<div class="line"><span class="lineno">  617</span>    <span class="keyword">auto</span> it = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ac6cc45a3a4a4ceabc7c0b57155fedd0b">lru_map_</a>.find(page_id);</div>
<div class="line"><span class="lineno">  618</span>    <span class="keywordflow">if</span> (it == <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ac6cc45a3a4a4ceabc7c0b57155fedd0b">lru_map_</a>.end()) {</div>
<div class="line"><span class="lineno">  619</span>        <span class="comment">// 页面不在LRU链表中，直接返回</span></div>
<div class="line"><span class="lineno">  620</span>        <span class="comment">// Why: 如果页面不在LRU链表中，无法进行移动操作</span></div>
<div class="line"><span class="lineno">  621</span>        <span class="comment">// What: 直接返回，不执行任何操作</span></div>
<div class="line"><span class="lineno">  622</span>        <span class="comment">// How: 使用return语句直接返回</span></div>
<div class="line"><span class="lineno">  623</span>        <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  624</span>    }</div>
<div class="line"><span class="lineno">  625</span>    </div>
<div class="line"><span class="lineno">  626</span>    <span class="comment">// 从当前位置移除</span></div>
<div class="line"><span class="lineno">  627</span>    <span class="comment">// Why: 需要从当前位置删除页面，然后才能将其添加到头部</span></div>
<div class="line"><span class="lineno">  628</span>    <span class="comment">// What: 使用迭代器从lru_list_中删除页面</span></div>
<div class="line"><span class="lineno">  629</span>    <span class="comment">// How: 使用std::list的erase方法删除</span></div>
<div class="line"><span class="lineno">  630</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.erase(it-&gt;second);</div>
<div class="line"><span class="lineno">  631</span>    </div>
<div class="line"><span class="lineno">  632</span>    <span class="comment">// 添加到头部</span></div>
<div class="line"><span class="lineno">  633</span>    <span class="comment">// Why: 将页面添加到头部表示最近被访问</span></div>
<div class="line"><span class="lineno">  634</span>    <span class="comment">// What: 使用push_front方法将页面ID添加到lru_list_头部</span></div>
<div class="line"><span class="lineno">  635</span>    <span class="comment">// How: 使用std::list的push_front方法添加</span></div>
<div class="line"><span class="lineno">  636</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.push_front(page_id);</div>
<div class="line"><span class="lineno">  637</span>    </div>
<div class="line"><span class="lineno">  638</span>    <span class="comment">// 更新LRU映射中的迭代器</span></div>
<div class="line"><span class="lineno">  639</span>    <span class="comment">// Why: 需要更新LRU映射中的迭代器，以保持映射的正确性</span></div>
<div class="line"><span class="lineno">  640</span>    <span class="comment">// What: 在lru_map_中更新页面ID对应的迭代器</span></div>
<div class="line"><span class="lineno">  641</span>    <span class="comment">// How: 将页面ID映射到lru_list_的begin()迭代器</span></div>
<div class="line"><span class="lineno">  642</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ac6cc45a3a4a4ceabc7c0b57155fedd0b">lru_map_</a>[page_id] = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.begin();</div>
<div class="line"><span class="lineno">  643</span>    </div>
<div class="line"><span class="lineno">  644</span>    <span class="comment">// 记录页面移动成功，便于调试</span></div>
<div class="line"><span class="lineno">  645</span>    <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Page ID &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; moved to head of LRU list&quot;</span>);</div>
<div class="line"><span class="lineno">  646</span>}</div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="buffer__pool_8h_source.html#l00335">lru_list_</a>, <a class="el" href="buffer__pool_8h_source.html#l00341">lru_map_</a>, and <a class="el" href="logger_8h_source.html#l00265">SQLCC_LOG_DEBUG</a>.</p>

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l00745">BatchFetchPages()</a>, and <a class="el" href="buffer__pool_8cpp_source.html#l00063">FetchPage()</a>.</p>

</div>
</div>
<a id="a5a697f8e177b9f1d22e95d2a6472dbfb" name="a5a697f8e177b9f1d22e95d2a6472dbfb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5a697f8e177b9f1d22e95d2a6472dbfb">&#9670;&#160;</a></span>NewPage() <span class="overload">[1/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classsqlcc_1_1Page.html">Page</a> * sqlcc::BufferPool::NewPage </td>
          <td>(</td>
          <td class="paramtype">int32_t *&#160;</td>
          <td class="paramname"><em>page_id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8cpp_source.html#l00652">652</a> of file <a class="el" href="buffer__pool_8cpp_source.html">buffer_pool.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  652</span>                                          {</div>
<div class="line"><span class="lineno">  653</span>    <span class="comment">// 加锁保护并发访问 - 使用带超时的unique_lock以支持临时解锁避免死锁</span></div>
<div class="line"><span class="lineno">  654</span>    std::unique_lock&lt;std::timed_mutex&gt; lock(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#add85ac70113f80ae97898aada5f87994">latch_</a>, std::defer_lock);</div>
<div class="line"><span class="lineno">  655</span>    <span class="keywordflow">if</span> (!lock.try_lock_for(std::chrono::milliseconds(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6f94e56229b9887a9c10b6305825cf31">write_lock_timeout_ms_</a>))) {</div>
<div class="line"><span class="lineno">  656</span>        <span class="comment">// 获取锁失败，记录警告但不抛出异常，避免在高并发场景下级联失败</span></div>
<div class="line"><span class="lineno">  657</span>        <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Failed to acquire buffer pool lock for creating new page, timeout after &quot;</span> + </div>
<div class="line"><span class="lineno">  658</span>                      std::to_string(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6f94e56229b9887a9c10b6305825cf31">write_lock_timeout_ms_</a>) + <span class="stringliteral">&quot;ms&quot;</span>);</div>
<div class="line"><span class="lineno">  659</span>        <span class="keywordflow">if</span> (page_id != <span class="keyword">nullptr</span>) {</div>
<div class="line"><span class="lineno">  660</span>            *page_id = -1;  <span class="comment">// 使用-1作为无效页面ID</span></div>
<div class="line"><span class="lineno">  661</span>        }</div>
<div class="line"><span class="lineno">  662</span>        <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line"><span class="lineno">  663</span>    }</div>
<div class="line"><span class="lineno">  664</span>    </div>
<div class="line"><span class="lineno">  665</span>    <span class="comment">// 如果缓冲池已满，先进行页面替换</span></div>
<div class="line"><span class="lineno">  666</span>    <span class="comment">// Why: 必须在分配页面ID之前确保有空间，避免页面ID重用造成数据混乱</span></div>
<div class="line"><span class="lineno">  667</span>    <span class="comment">// What: 检查page_table_的大小是否达到pool_size_</span></div>
<div class="line"><span class="lineno">  668</span>    <span class="comment">// How: 比较page_table_.size()和pool_size_</span></div>
<div class="line"><span class="lineno">  669</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.size() &gt;= <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ab824ca05f9fc912a0d2def90f30412fa">pool_size_</a>) {</div>
<div class="line"><span class="lineno">  670</span>        <span class="comment">// 记录缓冲池已满的信息，便于调试</span></div>
<div class="line"><span class="lineno">  671</span>        <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Buffer pool is full, replacing page for new page allocation&quot;</span>);</div>
<div class="line"><span class="lineno">  672</span>        </div>
<div class="line"><span class="lineno">  673</span>        <span class="comment">// 调用ReplacePage方法选择一个页面进行替换</span></div>
<div class="line"><span class="lineno">  674</span>        <span class="comment">// Why: 需要选择一个页面进行替换，为新页面腾出空间</span></div>
<div class="line"><span class="lineno">  675</span>        <span class="comment">// What: ReplacePage方法使用LRU算法选择一个可替换的页面</span></div>
<div class="line"><span class="lineno">  676</span>        <span class="comment">// How: 从LRU链表尾部开始查找，找到第一个引用计数为0的页面</span></div>
<div class="line"><span class="lineno">  677</span>        int32_t replaced_page_id = <a class="code hl_function" href="classsqlcc_1_1BufferPool.html#a7e1ed47ea2f229397ec3e54b57d41868">ReplacePage</a>();</div>
<div class="line"><span class="lineno">  678</span>        <span class="keywordflow">if</span> (replaced_page_id == -1) {</div>
<div class="line"><span class="lineno">  679</span>            <span class="comment">// 无法替换页面，返回nullptr</span></div>
<div class="line"><span class="lineno">  680</span>            <span class="comment">// Why: 如果所有页面都在使用中，无法为新页面腾出空间，必须报错</span></div>
<div class="line"><span class="lineno">  681</span>            <span class="comment">// What: 记录错误信息并返回nullptr</span></div>
<div class="line"><span class="lineno">  682</span>            <span class="comment">// How: 使用SQLCC_LOG_ERROR记录错误级别日志</span></div>
<div class="line"><span class="lineno">  683</span>            std::string error_msg = <span class="stringliteral">&quot;Failed to replace page in buffer pool for new page allocation&quot;</span>;</div>
<div class="line"><span class="lineno">  684</span>            <a class="code hl_define" href="logger_8h.html#a84e665e7d7b3157724d71a7c46644680">SQLCC_LOG_ERROR</a>(error_msg);</div>
<div class="line"><span class="lineno">  685</span>            <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line"><span class="lineno">  686</span>        }</div>
<div class="line"><span class="lineno">  687</span>    }</div>
<div class="line"><span class="lineno">  688</span>    </div>
<div class="line"><span class="lineno">  689</span>    <span class="comment">// 现在分配新的页面ID（此时已有可用空间）</span></div>
<div class="line"><span class="lineno">  690</span>    <span class="comment">// Why: 分配页面ID必须在有空间之后，避免ID重用混乱</span></div>
<div class="line"><span class="lineno">  691</span>    <span class="comment">// What: 调用磁盘管理器的AllocatePage方法获取新页面ID</span></div>
<div class="line"><span class="lineno">  692</span>    <span class="comment">// How: AllocatePage方法返回新的页面ID</span></div>
<div class="line"><span class="lineno">  693</span>    *page_id = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a85424d92e888ae0b2a0754e7fea7d089">disk_manager_</a>-&gt;<a class="code hl_function" href="classsqlcc_1_1DiskManager.html#a2834723cc4c2c3017e62223c0660f9b0">AllocatePage</a>();</div>
<div class="line"><span class="lineno">  694</span>    <span class="keywordflow">if</span> (*page_id &lt; 0) {</div>
<div class="line"><span class="lineno">  695</span>        <span class="comment">// 无法分配新页面，记录错误并返回nullptr</span></div>
<div class="line"><span class="lineno">  696</span>        <span class="comment">// Why: 磁盘空间不足或磁盘管理器错误导致无法分配新页面</span></div>
<div class="line"><span class="lineno">  697</span>        <span class="comment">// What: 记录错误信息并返回nullptr表示失败</span></div>
<div class="line"><span class="lineno">  698</span>        <span class="comment">// How: 使用SQLCC_LOG_ERROR记录错误级别日志</span></div>
<div class="line"><span class="lineno">  699</span>        std::string error_msg = <span class="stringliteral">&quot;Failed to allocate new page from disk manager&quot;</span>;</div>
<div class="line"><span class="lineno">  700</span>        <a class="code hl_define" href="logger_8h.html#a84e665e7d7b3157724d71a7c46644680">SQLCC_LOG_ERROR</a>(error_msg);</div>
<div class="line"><span class="lineno">  701</span>        <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line"><span class="lineno">  702</span>    }</div>
<div class="line"><span class="lineno">  703</span>    </div>
<div class="line"><span class="lineno">  704</span>    <span class="comment">// 记录新页面分配成功，便于调试</span></div>
<div class="line"><span class="lineno">  705</span>    <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Allocated new page ID &quot;</span> + std::to_string(*page_id) + <span class="stringliteral">&quot; from disk manager&quot;</span>);</div>
<div class="line"><span class="lineno">  706</span>    </div>
<div class="line"><span class="lineno">  707</span>    <span class="comment">// 创建新页面对象</span></div>
<div class="line"><span class="lineno">  708</span>    <span class="comment">// Why: 需要创建页面对象来管理新页面的数据和元数据</span></div>
<div class="line"><span class="lineno">  709</span>    <span class="comment">// What: 使用页面ID创建新的Page对象</span></div>
<div class="line"><span class="lineno">  710</span>    <span class="comment">// How: 使用std::make_unique创建页面对象，然后释放所有权获取指针</span></div>
<div class="line"><span class="lineno">  711</span>    <span class="keyword">auto</span> page = std::make_unique&lt;Page&gt;(*page_id);</div>
<div class="line"><span class="lineno">  712</span>    </div>
<div class="line"><span class="lineno">  713</span>    <span class="comment">// 初始化页面数据（可选）</span></div>
<div class="line"><span class="lineno">  714</span>    <span class="comment">// Why: 新页面可能需要初始化为空或特定值</span></div>
<div class="line"><span class="lineno">  715</span>    <span class="comment">// What: 可以选择初始化页面数据为特定值</span></div>
<div class="line"><span class="lineno">  716</span>    <span class="comment">// How: 这里不初始化，让调用者自行处理页面数据</span></div>
<div class="line"><span class="lineno">  717</span>    </div>
<div class="line"><span class="lineno">  718</span>    <span class="comment">// 添加到页面表</span></div>
<div class="line"><span class="lineno">  719</span>    <span class="comment">// Why: 需要将新创建的页面加入缓冲池管理，以便后续查找和使用</span></div>
<div class="line"><span class="lineno">  720</span>    <span class="comment">// What: 将页面对象添加到page_table_哈希表中</span></div>
<div class="line"><span class="lineno">  721</span>    <span class="comment">// How: 使用页面ID作为键，使用std::move转移页面对象的所有权</span></div>
<div class="line"><span class="lineno">  722</span>    Page* page_ptr = page.release(); <span class="comment">// 释放所有权，获取原始指针</span></div>
<div class="line"><span class="lineno">  723</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>[*page_id] = page_ptr;</div>
<div class="line"><span class="lineno">  724</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>[*page_id] = 1; <span class="comment">// 新页面默认引用计数为1</span></div>
<div class="line"><span class="lineno">  725</span>    </div>
<div class="line"><span class="lineno">  726</span>    <span class="comment">// 初始化脏页标记</span></div>
<div class="line"><span class="lineno">  727</span>    <span class="comment">// Why: 需要跟踪页面是否被修改过，以便在替换时写回磁盘</span></div>
<div class="line"><span class="lineno">  728</span>    <span class="comment">// What: 将页面标记为非脏页，因为新创建页面</span></div>
<div class="line"><span class="lineno">  729</span>    <span class="comment">// How: 在dirty_pages_哈希表中设置页面ID的值为false</span></div>
<div class="line"><span class="lineno">  730</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>[*page_id] = <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  731</span>    </div>
<div class="line"><span class="lineno">  732</span>    <span class="comment">// 添加到LRU链表头部</span></div>
<div class="line"><span class="lineno">  733</span>    <span class="comment">// Why: 新创建的页面应该放在LRU链表头部，表示最近被访问</span></div>
<div class="line"><span class="lineno">  734</span>    <span class="comment">// What: 将页面ID添加到lru_list_的头部</span></div>
<div class="line"><span class="lineno">  735</span>    <span class="comment">// How: 使用push_front方法添加到链表头部，并在lru_map_中记录迭代器</span></div>
<div class="line"><span class="lineno">  736</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.push_front(*page_id);</div>
<div class="line"><span class="lineno">  737</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ac6cc45a3a4a4ceabc7c0b57155fedd0b">lru_map_</a>[*page_id] = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.begin();</div>
<div class="line"><span class="lineno">  738</span>    </div>
<div class="line"><span class="lineno">  739</span>    <span class="comment">// 记录新页面创建成功，便于调试</span></div>
<div class="line"><span class="lineno">  740</span>    <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;New page ID &quot;</span> + std::to_string(*page_id) + <span class="stringliteral">&quot; created in buffer pool&quot;</span>);</div>
<div class="line"><span class="lineno">  741</span>    </div>
<div class="line"><span class="lineno">  742</span>    <span class="keywordflow">return</span> page_ptr;</div>
<div class="line"><span class="lineno">  743</span>}</div>
<div class="ttc" id="aclasssqlcc_1_1DiskManager_html_a2834723cc4c2c3017e62223c0660f9b0"><div class="ttname"><a href="classsqlcc_1_1DiskManager.html#a2834723cc4c2c3017e62223c0660f9b0">sqlcc::DiskManager::AllocatePage</a></div><div class="ttdeci">int32_t AllocatePage()</div><div class="ttdef"><b>Definition</b> <a href="disk__manager_8cpp_source.html#l00352">disk_manager.cpp:352</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="disk__manager_8cpp_source.html#l00352">sqlcc::DiskManager::AllocatePage()</a>, <a class="el" href="buffer__pool_8h_source.html#l00372">dirty_pages_</a>, <a class="el" href="buffer__pool_8h_source.html#l00311">disk_manager_</a>, <a class="el" href="buffer__pool_8h_source.html#l00347">latch_</a>, <a class="el" href="buffer__pool_8h_source.html#l00335">lru_list_</a>, <a class="el" href="buffer__pool_8h_source.html#l00341">lru_map_</a>, <a class="el" href="buffer__pool_8h_source.html#l00366">page_refs_</a>, <a class="el" href="buffer__pool_8h_source.html#l00329">page_table_</a>, <a class="el" href="buffer__pool_8h_source.html#l00323">pool_size_</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00466">ReplacePage()</a>, <a class="el" href="logger_8h_source.html#l00265">SQLCC_LOG_DEBUG</a>, <a class="el" href="logger_8h_source.html#l00292">SQLCC_LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00283">SQLCC_LOG_WARN</a>, and <a class="el" href="buffer__pool_8h_source.html#l00403">write_lock_timeout_ms_</a>.</p>

</div>
</div>
<a id="a5a697f8e177b9f1d22e95d2a6472dbfb" name="a5a697f8e177b9f1d22e95d2a6472dbfb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5a697f8e177b9f1d22e95d2a6472dbfb">&#9670;&#160;</a></span>NewPage() <span class="overload">[2/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classsqlcc_1_1Page.html">Page</a> * sqlcc::BufferPool::NewPage </td>
          <td>(</td>
          <td class="paramtype">int32_t *&#160;</td>
          <td class="paramname"><em>page_id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="aab230e7c61921995edfe616a2cf89bbe" name="aab230e7c61921995edfe616a2cf89bbe"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aab230e7c61921995edfe616a2cf89bbe">&#9670;&#160;</a></span>OnConfigChange()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void sqlcc::BufferPool::OnConfigChange </td>
          <td>(</td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>key</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="namespacesqlcc.html#a35365cc4e9f1ef07e5d024b9963eff15">ConfigValue</a> &amp;&#160;</td>
          <td class="paramname"><em>value</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8cpp_source.html#l01213">1213</a> of file <a class="el" href="buffer__pool_8cpp_source.html">buffer_pool.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno"> 1213</span>                                                                          {</div>
<div class="line"><span class="lineno"> 1214</span>    <span class="comment">// 注意：由于配置回调功能已禁用，此方法现在不会被调用</span></div>
<div class="line"><span class="lineno"> 1215</span>    <span class="comment">// 保留此方法以保持接口兼容性</span></div>
<div class="line"><span class="lineno"> 1216</span>    <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Dynamic configuration change handling is disabled: &quot;</span> + key);</div>
<div class="line"><span class="lineno"> 1217</span>}</div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="logger_8h_source.html#l00265">SQLCC_LOG_DEBUG</a>.</p>

</div>
</div>
<a id="a792661db8aaf7cf60fcb9904340f9c5d" name="a792661db8aaf7cf60fcb9904340f9c5d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a792661db8aaf7cf60fcb9904340f9c5d">&#9670;&#160;</a></span>operator=() <span class="overload">[1/2]</span></h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classsqlcc_1_1BufferPool.html">BufferPool</a> &amp; sqlcc::BufferPool::operator= </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="classsqlcc_1_1BufferPool.html">BufferPool</a> &amp;&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">delete</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<a id="a792661db8aaf7cf60fcb9904340f9c5d" name="a792661db8aaf7cf60fcb9904340f9c5d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a792661db8aaf7cf60fcb9904340f9c5d">&#9670;&#160;</a></span>operator=() <span class="overload">[2/2]</span></h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classsqlcc_1_1BufferPool.html">BufferPool</a> &amp; sqlcc::BufferPool::operator= </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="classsqlcc_1_1BufferPool.html">BufferPool</a> &amp;&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span><span class="mlabel">delete</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<a id="a9e09cd1844c8952220c2cef60d8f8932" name="a9e09cd1844c8952220c2cef60d8f8932"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9e09cd1844c8952220c2cef60d8f8932">&#9670;&#160;</a></span>PrefetchPage()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool sqlcc::BufferPool::PrefetchPage </td>
          <td>(</td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>page_id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8cpp_source.html#l01022">1022</a> of file <a class="el" href="buffer__pool_8cpp_source.html">buffer_pool.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno"> 1022</span>                                             {</div>
<div class="line"><span class="lineno"> 1023</span>    <span class="comment">// 检查页面ID是否有效</span></div>
<div class="line"><span class="lineno"> 1024</span>    <span class="keywordflow">if</span> (page_id &lt; 0) {</div>
<div class="line"><span class="lineno"> 1025</span>        <a class="code hl_define" href="logger_8h.html#a84e665e7d7b3157724d71a7c46644680">SQLCC_LOG_ERROR</a>(<span class="stringliteral">&quot;Invalid page ID for prefetch: &quot;</span> + std::to_string(page_id));</div>
<div class="line"><span class="lineno"> 1026</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno"> 1027</span>    }</div>
<div class="line"><span class="lineno"> 1028</span>    </div>
<div class="line"><span class="lineno"> 1029</span>    <span class="comment">// 检查预取功能是否启用</span></div>
<div class="line"><span class="lineno"> 1030</span>    <span class="keywordtype">bool</span> prefetch_enabled = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a52b7cc65c932b03c35af2e56916e9c9d">config_manager_</a>.<a class="code hl_function" href="classsqlcc_1_1ConfigManager.html#abc13ba41aba1d90bcf127993b65e8509">GetBool</a>(<span class="stringliteral">&quot;buffer_pool.enable_prefetch&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line"><span class="lineno"> 1031</span>    <span class="keywordflow">if</span> (!prefetch_enabled) {</div>
<div class="line"><span class="lineno"> 1032</span>        <span class="comment">// 预取功能被禁用</span></div>
<div class="line"><span class="lineno"> 1033</span>        <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Prefetch disabled, skipping page &quot;</span> + std::to_string(page_id));</div>
<div class="line"><span class="lineno"> 1034</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno"> 1035</span>    }</div>
<div class="line"><span class="lineno"> 1036</span>    </div>
<div class="line"><span class="lineno"> 1037</span>    <span class="comment">// 加锁保护并发访问 - 使用带超时的unique_lock以支持临时解锁避免死锁</span></div>
<div class="line"><span class="lineno"> 1038</span>    std::unique_lock&lt;std::timed_mutex&gt; lock(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#add85ac70113f80ae97898aada5f87994">latch_</a>, std::defer_lock);</div>
<div class="line"><span class="lineno"> 1039</span>    <span class="keywordflow">if</span> (!lock.try_lock_for(std::chrono::milliseconds(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#abe6985900d8804e2c0fe37299133eb08">read_lock_timeout_ms_</a>))) {</div>
<div class="line"><span class="lineno"> 1040</span>        <span class="comment">// 获取锁失败，避免长时间等待，记录警告并返回</span></div>
<div class="line"><span class="lineno"> 1041</span>        <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Failed to acquire buffer pool lock for prefetch, timeout after &quot;</span> + </div>
<div class="line"><span class="lineno"> 1042</span>                      std::to_string(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#abe6985900d8804e2c0fe37299133eb08">read_lock_timeout_ms_</a>) + <span class="stringliteral">&quot;ms, skipping page &quot;</span> + std::to_string(page_id));</div>
<div class="line"><span class="lineno"> 1043</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno"> 1044</span>    }</div>
<div class="line"><span class="lineno"> 1045</span>    </div>
<div class="line"><span class="lineno"> 1046</span>    <span class="comment">// 检查页面是否已在缓冲池中</span></div>
<div class="line"><span class="lineno"> 1047</span>    <span class="keyword">auto</span> it = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.find(page_id);</div>
<div class="line"><span class="lineno"> 1048</span>    <span class="keywordflow">if</span> (it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.end()) {</div>
<div class="line"><span class="lineno"> 1049</span>        <span class="comment">// 页面已在缓冲池中，无需预取</span></div>
<div class="line"><span class="lineno"> 1050</span>        <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Page &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; already in buffer pool&quot;</span>);</div>
<div class="line"><span class="lineno"> 1051</span>        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno"> 1052</span>    }</div>
<div class="line"><span class="lineno"> 1053</span>    </div>
<div class="line"><span class="lineno"> 1054</span>    <span class="comment">// 检查页面是否已在预取队列中</span></div>
<div class="line"><span class="lineno"> 1055</span>    <span class="keyword">auto</span> queue_it = std::find(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a>.begin(), <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a>.end(), page_id);</div>
<div class="line"><span class="lineno"> 1056</span>    <span class="keywordflow">if</span> (queue_it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a>.end()) {</div>
<div class="line"><span class="lineno"> 1057</span>        <span class="comment">// 页面已在预取队列中，无需重复预取</span></div>
<div class="line"><span class="lineno"> 1058</span>        <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Page &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; already in prefetch queue&quot;</span>);</div>
<div class="line"><span class="lineno"> 1059</span>        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno"> 1060</span>    }</div>
<div class="line"><span class="lineno"> 1061</span>    </div>
<div class="line"><span class="lineno"> 1062</span>    <span class="comment">// 检查缓冲池是否已满</span></div>
<div class="line"><span class="lineno"> 1063</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.size() &gt;= <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ab824ca05f9fc912a0d2def90f30412fa">pool_size_</a>) {</div>
<div class="line"><span class="lineno"> 1064</span>        <span class="comment">// 尝试替换一个页面</span></div>
<div class="line"><span class="lineno"> 1065</span>        int32_t victim_page_id = <a class="code hl_function" href="classsqlcc_1_1BufferPool.html#a7e1ed47ea2f229397ec3e54b57d41868">ReplacePage</a>();</div>
<div class="line"><span class="lineno"> 1066</span>        <span class="keywordflow">if</span> (victim_page_id == -1) {</div>
<div class="line"><span class="lineno"> 1067</span>            <span class="comment">// 没有可替换的页面，预取失败</span></div>
<div class="line"><span class="lineno"> 1068</span>            <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Buffer pool is full and no pages can be replaced, prefetch failed for page &quot;</span> + std::to_string(page_id));</div>
<div class="line"><span class="lineno"> 1069</span>            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno"> 1070</span>        }</div>
<div class="line"><span class="lineno"> 1071</span>    }</div>
<div class="line"><span class="lineno"> 1072</span>    </div>
<div class="line"><span class="lineno"> 1073</span>    <span class="comment">// 创建新页面对象</span></div>
<div class="line"><span class="lineno"> 1074</span>    Page* page = <span class="keyword">new</span> Page();</div>
<div class="line"><span class="lineno"> 1075</span>    page-&gt;SetPageId(page_id);</div>
<div class="line"><span class="lineno"> 1076</span>    </div>
<div class="line"><span class="lineno"> 1077</span>    <span class="comment">// 释放锁，进行磁盘I/O操作 - 避免死锁的关键修复</span></div>
<div class="line"><span class="lineno"> 1078</span>    lock.unlock();</div>
<div class="line"><span class="lineno"> 1079</span>    </div>
<div class="line"><span class="lineno"> 1080</span>    <span class="comment">// 从磁盘加载页面数据（在锁外执行）</span></div>
<div class="line"><span class="lineno"> 1081</span>    <span class="keywordtype">bool</span> read_success = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a85424d92e888ae0b2a0754e7fea7d089">disk_manager_</a>-&gt;<a class="code hl_function" href="classsqlcc_1_1DiskManager.html#aee0ac0ad4df85f6522d355be6f47598b">ReadPage</a>(page_id, page-&gt;GetData());</div>
<div class="line"><span class="lineno"> 1082</span>    <span class="keywordflow">if</span> (!read_success) {</div>
<div class="line"><span class="lineno"> 1083</span>        <span class="comment">// 磁盘读取失败，清理资源并返回</span></div>
<div class="line"><span class="lineno"> 1084</span>        <a class="code hl_define" href="logger_8h.html#a84e665e7d7b3157724d71a7c46644680">SQLCC_LOG_ERROR</a>(<span class="stringliteral">&quot;Failed to read page &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; from disk&quot;</span>);</div>
<div class="line"><span class="lineno"> 1085</span>        <span class="keyword">delete</span> page;</div>
<div class="line"><span class="lineno"> 1086</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno"> 1087</span>    }</div>
<div class="line"><span class="lineno"> 1088</span>    </div>
<div class="line"><span class="lineno"> 1089</span>    <span class="comment">// 重新获取锁以更新缓冲池状态</span></div>
<div class="line"><span class="lineno"> 1090</span>    <span class="keywordflow">if</span> (!lock.try_lock_for(std::chrono::milliseconds(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#abe6985900d8804e2c0fe37299133eb08">read_lock_timeout_ms_</a>))) {</div>
<div class="line"><span class="lineno"> 1091</span>        <span class="comment">// 获取锁失败，清理资源并返回</span></div>
<div class="line"><span class="lineno"> 1092</span>        <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Failed to acquire buffer pool lock after disk read, timeout after &quot;</span> + </div>
<div class="line"><span class="lineno"> 1093</span>                      std::to_string(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#abe6985900d8804e2c0fe37299133eb08">read_lock_timeout_ms_</a>) + <span class="stringliteral">&quot;ms, skipping page &quot;</span> + std::to_string(page_id));</div>
<div class="line"><span class="lineno"> 1094</span>        <span class="keyword">delete</span> page;</div>
<div class="line"><span class="lineno"> 1095</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno"> 1096</span>    }</div>
<div class="line"><span class="lineno"> 1097</span>    </div>
<div class="line"><span class="lineno"> 1098</span>    <span class="comment">// 再次检查页面是否已在缓冲池中（可能已被其他线程添加）</span></div>
<div class="line"><span class="lineno"> 1099</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.find(page_id) != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.end()) {</div>
<div class="line"><span class="lineno"> 1100</span>        <span class="comment">// 页面已被其他线程添加到缓冲池，清理资源并返回</span></div>
<div class="line"><span class="lineno"> 1101</span>        <span class="keyword">delete</span> page;</div>
<div class="line"><span class="lineno"> 1102</span>        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno"> 1103</span>    }</div>
<div class="line"><span class="lineno"> 1104</span>    </div>
<div class="line"><span class="lineno"> 1105</span>    <span class="comment">// 再次检查页面是否已在预取队列中</span></div>
<div class="line"><span class="lineno"> 1106</span>    queue_it = std::find(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a>.begin(), <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a>.end(), page_id);</div>
<div class="line"><span class="lineno"> 1107</span>    <span class="keywordflow">if</span> (queue_it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a>.end()) {</div>
<div class="line"><span class="lineno"> 1108</span>        <span class="comment">// 页面已被其他线程添加到预取队列，清理资源并返回</span></div>
<div class="line"><span class="lineno"> 1109</span>        <span class="keyword">delete</span> page;</div>
<div class="line"><span class="lineno"> 1110</span>        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno"> 1111</span>    }</div>
<div class="line"><span class="lineno"> 1112</span>    </div>
<div class="line"><span class="lineno"> 1113</span>    <span class="comment">// 将页面添加到缓冲池</span></div>
<div class="line"><span class="lineno"> 1114</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>[page_id] = page;</div>
<div class="line"><span class="lineno"> 1115</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.push_front(page_id);</div>
<div class="line"><span class="lineno"> 1116</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ac6cc45a3a4a4ceabc7c0b57155fedd0b">lru_map_</a>[page_id] = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.begin();</div>
<div class="line"><span class="lineno"> 1117</span>    </div>
<div class="line"><span class="lineno"> 1118</span>    <span class="comment">// 预取页面的引用计数为0（表示预取）</span></div>
<div class="line"><span class="lineno"> 1119</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>[page_id] = 0;</div>
<div class="line"><span class="lineno"> 1120</span>    </div>
<div class="line"><span class="lineno"> 1121</span>    <span class="comment">// 预取页面不是脏页</span></div>
<div class="line"><span class="lineno"> 1122</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>[page_id] = <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno"> 1123</span>    </div>
<div class="line"><span class="lineno"> 1124</span>    <span class="comment">// 添加到预取队列</span></div>
<div class="line"><span class="lineno"> 1125</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#af1b9545a6884861a6d10237e0131fee5">prefetch_queue_</a>.push_back(page_id);</div>
<div class="line"><span class="lineno"> 1126</span>    </div>
<div class="line"><span class="lineno"> 1127</span>    <span class="comment">// 更新统计信息</span></div>
<div class="line"><span class="lineno"> 1128</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a4f10df0f06c12c12ab49e0a4db686de4">stats_</a>.<a class="code hl_variable" href="structsqlcc_1_1BufferPool_1_1Stats.html#afbdf6aeb63bb60553872187dcff2d0f1">total_prefetches</a>++;</div>
<div class="line"><span class="lineno"> 1129</span>    </div>
<div class="line"><span class="lineno"> 1130</span>    <span class="comment">// 记录预取成功信息</span></div>
<div class="line"><span class="lineno"> 1131</span>    <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Successfully prefetched page &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; into buffer pool&quot;</span>);</div>
<div class="line"><span class="lineno"> 1132</span>    </div>
<div class="line"><span class="lineno"> 1133</span>    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno"> 1134</span>}</div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_a4f10df0f06c12c12ab49e0a4db686de4"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#a4f10df0f06c12c12ab49e0a4db686de4">sqlcc::BufferPool::stats_</a></div><div class="ttdeci">struct sqlcc::BufferPool::Stats stats_</div></div>
<div class="ttc" id="astructsqlcc_1_1BufferPool_1_1Stats_html_afbdf6aeb63bb60553872187dcff2d0f1"><div class="ttname"><a href="structsqlcc_1_1BufferPool_1_1Stats.html#afbdf6aeb63bb60553872187dcff2d0f1">sqlcc::BufferPool::Stats::total_prefetches</a></div><div class="ttdeci">size_t total_prefetches</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool_8h_source.html#l00358">buffer_pool.h:358</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="buffer__pool_8h_source.html#l00317">config_manager_</a>, <a class="el" href="buffer__pool_8h_source.html#l00372">dirty_pages_</a>, <a class="el" href="buffer__pool_8h_source.html#l00311">disk_manager_</a>, <a class="el" href="config__manager_8cpp_source.html#l00117">sqlcc::ConfigManager::GetBool()</a>, <a class="el" href="page_8h_source.html#l00079">sqlcc::Page::GetData()</a>, <a class="el" href="buffer__pool_8h_source.html#l00347">latch_</a>, <a class="el" href="buffer__pool_8h_source.html#l00335">lru_list_</a>, <a class="el" href="buffer__pool_8h_source.html#l00341">lru_map_</a>, <a class="el" href="buffer__pool_8h_source.html#l00366">page_refs_</a>, <a class="el" href="buffer__pool_8h_source.html#l00329">page_table_</a>, <a class="el" href="buffer__pool_8h_source.html#l00323">pool_size_</a>, <a class="el" href="buffer__pool_8h_source.html#l00378">prefetch_queue_</a>, <a class="el" href="buffer__pool_8h_source.html#l00402">read_lock_timeout_ms_</a>, <a class="el" href="disk__manager_8cpp_source.html#l00258">sqlcc::DiskManager::ReadPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00466">ReplacePage()</a>, <a class="el" href="page_8h_source.html#l00069">sqlcc::Page::SetPageId()</a>, <a class="el" href="logger_8h_source.html#l00265">SQLCC_LOG_DEBUG</a>, <a class="el" href="logger_8h_source.html#l00292">SQLCC_LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00283">SQLCC_LOG_WARN</a>, <a class="el" href="classsqlcc_1_1BufferPool.html#a4f10df0f06c12c12ab49e0a4db686de4">stats_</a>, and <a class="el" href="buffer__pool_8h_source.html#l00358">sqlcc::BufferPool::Stats::total_prefetches</a>.</p>

</div>
</div>
<a id="a09c7879bf4f4f7cee87b8baa89c25829" name="a09c7879bf4f4f7cee87b8baa89c25829"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a09c7879bf4f4f7cee87b8baa89c25829">&#9670;&#160;</a></span>RemoveFromLRUList()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void sqlcc::BufferPool::RemoveFromLRUList </td>
          <td>(</td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>page_id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8cpp_source.html#l01223">1223</a> of file <a class="el" href="buffer__pool_8cpp_source.html">buffer_pool.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno"> 1223</span>                                                  {</div>
<div class="line"><span class="lineno"> 1224</span>    <span class="comment">// 查找页面在LRU映射中的位置</span></div>
<div class="line"><span class="lineno"> 1225</span>    <span class="keyword">auto</span> it = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ac6cc45a3a4a4ceabc7c0b57155fedd0b">lru_map_</a>.find(page_id);</div>
<div class="line"><span class="lineno"> 1226</span>    <span class="keywordflow">if</span> (it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ac6cc45a3a4a4ceabc7c0b57155fedd0b">lru_map_</a>.end()) {</div>
<div class="line"><span class="lineno"> 1227</span>        <span class="comment">// 从LRU列表中移除页面</span></div>
<div class="line"><span class="lineno"> 1228</span>        <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.erase(it-&gt;second);</div>
<div class="line"><span class="lineno"> 1229</span>        <span class="comment">// 从LRU映射中移除条目</span></div>
<div class="line"><span class="lineno"> 1230</span>        <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ac6cc45a3a4a4ceabc7c0b57155fedd0b">lru_map_</a>.erase(it);</div>
<div class="line"><span class="lineno"> 1231</span>        </div>
<div class="line"><span class="lineno"> 1232</span>        <span class="comment">// 记录页面从LRU列表移除的调试信息</span></div>
<div class="line"><span class="lineno"> 1233</span>        <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Page &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; removed from LRU list&quot;</span>);</div>
<div class="line"><span class="lineno"> 1234</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno"> 1235</span>        <span class="comment">// 页面不在LRU列表中，记录警告信息</span></div>
<div class="line"><span class="lineno"> 1236</span>        <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Page &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; not found in LRU list for removal&quot;</span>);</div>
<div class="line"><span class="lineno"> 1237</span>    }</div>
<div class="line"><span class="lineno"> 1238</span>}</div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="buffer__pool_8h_source.html#l00335">lru_list_</a>, <a class="el" href="buffer__pool_8h_source.html#l00341">lru_map_</a>, <a class="el" href="logger_8h_source.html#l00265">SQLCC_LOG_DEBUG</a>, and <a class="el" href="logger_8h_source.html#l00283">SQLCC_LOG_WARN</a>.</p>

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l00279">DeletePage()</a>.</p>

</div>
</div>
<a id="a7e1ed47ea2f229397ec3e54b57d41868" name="a7e1ed47ea2f229397ec3e54b57d41868"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7e1ed47ea2f229397ec3e54b57d41868">&#9670;&#160;</a></span>ReplacePage() <span class="overload">[1/3]</span></h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">int32_t sqlcc::BufferPool::ReplacePage </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8cpp_source.html#l00466">466</a> of file <a class="el" href="buffer__pool_8cpp_source.html">buffer_pool.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  466</span>                                {</div>
<div class="line"><span class="lineno">  467</span>    <span class="comment">// 加锁保护并发访问 - 使用带超时的unique_lock以支持临时解锁避免死锁</span></div>
<div class="line"><span class="lineno">  468</span>    std::unique_lock&lt;std::timed_mutex&gt; lock(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#add85ac70113f80ae97898aada5f87994">latch_</a>, std::defer_lock);</div>
<div class="line"><span class="lineno">  469</span>    <span class="keywordflow">if</span> (!lock.try_lock_for(std::chrono::milliseconds(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad51347a7c8621ac0b20071c60fef39ee">lock_timeout_ms_</a>))) {</div>
<div class="line"><span class="lineno">  470</span>        <span class="comment">// 获取锁失败，记录警告并抛出异常</span></div>
<div class="line"><span class="lineno">  471</span>        <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Failed to acquire buffer pool lock for page replacement&quot;</span>);</div>
<div class="line"><span class="lineno">  472</span>        <span class="keywordflow">throw</span> LockTimeoutException(<span class="stringliteral">&quot;Failed to acquire buffer pool lock for page replacement&quot;</span>);</div>
<div class="line"><span class="lineno">  473</span>    }</div>
<div class="line"><span class="lineno">  474</span>    </div>
<div class="line"><span class="lineno">  475</span>    <span class="comment">// 从LRU链表尾部开始查找可替换的页面</span></div>
<div class="line"><span class="lineno">  476</span>    <span class="comment">// Why: LRU链表尾部是最近最少使用的页面，应该优先替换</span></div>
<div class="line"><span class="lineno">  477</span>    <span class="comment">// What: 从lru_list_的尾部开始遍历，查找引用计数为0的页面</span></div>
<div class="line"><span class="lineno">  478</span>    <span class="comment">// How: 使用反向迭代器从链表尾部开始遍历</span></div>
<div class="line"><span class="lineno">  479</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> it = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.rbegin(); it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.rend(); ++it) {</div>
<div class="line"><span class="lineno">  480</span>        int32_t page_id = *it;</div>
<div class="line"><span class="lineno">  481</span>        </div>
<div class="line"><span class="lineno">  482</span>        <span class="comment">// 检查页面引用计数</span></div>
<div class="line"><span class="lineno">  483</span>        <span class="comment">// Why: 引用计数大于0的页面正在被使用，不能替换</span></div>
<div class="line"><span class="lineno">  484</span>        <span class="comment">// What: 检查page_refs_中该页面的引用计数</span></div>
<div class="line"><span class="lineno">  485</span>        <span class="comment">// How: 使用std::unordered_map的find方法查找引用计数</span></div>
<div class="line"><span class="lineno">  486</span>        <span class="keyword">auto</span> ref_it = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>.find(page_id);</div>
<div class="line"><span class="lineno">  487</span>        <span class="keywordflow">if</span> (ref_it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>.end() &amp;&amp; ref_it-&gt;second &gt; 0) {</div>
<div class="line"><span class="lineno">  488</span>            <span class="comment">// 页面正在被使用，不能替换，继续查找</span></div>
<div class="line"><span class="lineno">  489</span>            <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno">  490</span>        }</div>
<div class="line"><span class="lineno">  491</span>        </div>
<div class="line"><span class="lineno">  492</span>        <span class="comment">// 检查脏页标记 - 修复死锁问题：使用unique_lock支持锁释放机制</span></div>
<div class="line"><span class="lineno">  493</span>        <span class="comment">// Why: 如果页面是脏的，需要先写回磁盘才能替换，但必须在锁外进行磁盘I/O以避免死锁</span></div>
<div class="line"><span class="lineno">  494</span>        <span class="comment">// What: 使用std::unique_lock的unlock()方法临时释放锁，在锁外执行磁盘写入操作</span></div>
<div class="line"><span class="lineno">  495</span>        <span class="comment">// How: 先在锁内准备数据，然后解锁调用DiskManager，再重新加锁继续操作</span></div>
<div class="line"><span class="lineno">  496</span>        <span class="keyword">auto</span> dirty_it = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>.find(page_id);</div>
<div class="line"><span class="lineno">  497</span>        <span class="keywordflow">if</span> (dirty_it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>.end() &amp;&amp; dirty_it-&gt;second) {</div>
<div class="line"><span class="lineno">  498</span>            <span class="comment">// 页面是脏的，需要先写回磁盘</span></div>
<div class="line"><span class="lineno">  499</span>            <span class="comment">// Why: 脏页的内容与磁盘不一致，需要写回磁盘以保证数据持久性</span></div>
<div class="line"><span class="lineno">  500</span>            <span class="comment">// What: 先在锁内准备数据，然后释放锁进行磁盘写入，最后重新加锁</span></div>
<div class="line"><span class="lineno">  501</span>            <span class="comment">// How: 这是解决BufferPool latch_和DiskManager io_mutex_死锁的核心策略</span></div>
<div class="line"><span class="lineno">  502</span>            </div>
<div class="line"><span class="lineno">  503</span>            <span class="comment">// 查找页面在页面表中的位置</span></div>
<div class="line"><span class="lineno">  504</span>            <span class="keyword">auto</span> page_it = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.find(page_id);</div>
<div class="line"><span class="lineno">  505</span>            <span class="keywordflow">if</span> (page_it == <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.end()) {</div>
<div class="line"><span class="lineno">  506</span>                <span class="comment">// 页面不在页面表中，继续查找下一个页面</span></div>
<div class="line"><span class="lineno">  507</span>                <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno">  508</span>            }</div>
<div class="line"><span class="lineno">  509</span>            </div>
<div class="line"><span class="lineno">  510</span>            <span class="comment">// 获取页面数据和ID用于后续处理</span></div>
<div class="line"><span class="lineno">  511</span>            Page* page = page_it-&gt;second;</div>
<div class="line"><span class="lineno">  512</span>            <span class="keywordtype">void</span>* page_data = page-&gt;GetData();</div>
<div class="line"><span class="lineno">  513</span>            int32_t current_page_id = page_id;</div>
<div class="line"><span class="lineno">  514</span>            </div>
<div class="line"><span class="lineno">  515</span>            <span class="comment">// 先从脏页列表中移除，标记为正在处理</span></div>
<div class="line"><span class="lineno">  516</span>            <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>.erase(dirty_it);</div>
<div class="line"><span class="lineno">  517</span>            </div>
<div class="line"><span class="lineno">  518</span>            <span class="comment">// 释放锁，进行磁盘写入操作 - 这是避免死锁的关键修复</span></div>
<div class="line"><span class="lineno">  519</span>            <span class="comment">// Why: 需要先释放BufferPool锁，再调用DiskManager避免循环锁等待</span></div>
<div class="line"><span class="lineno">  520</span>            <span class="comment">// What: 使用std::unique_lock的unlock()方法临时释放锁</span></div>
<div class="line"><span class="lineno">  521</span>            <span class="comment">// How: 调用unlock()释放latch_锁，然后进行磁盘写入，再重新加锁</span></div>
<div class="line"><span class="lineno">  522</span>            lock.unlock();</div>
<div class="line"><span class="lineno">  523</span>            </div>
<div class="line"><span class="lineno">  524</span>            <span class="comment">// 现在在锁外进行磁盘写入操作</span></div>
<div class="line"><span class="lineno">  525</span>            <span class="comment">// Why: DiskManager::WritePage会获取io_mutex_，必须在BufferPool latch_释放后调用</span></div>
<div class="line"><span class="lineno">  526</span>            <span class="comment">// What: 执行实际的页面写入磁盘操作</span></div>
<div class="line"><span class="lineno">  527</span>            <span class="comment">// How: 调用disk_manager_-&gt;WritePage进行磁盘写入</span></div>
<div class="line"><span class="lineno">  528</span>            <span class="keywordtype">bool</span> write_success = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a85424d92e888ae0b2a0754e7fea7d089">disk_manager_</a>-&gt;<a class="code hl_function" href="classsqlcc_1_1DiskManager.html#aa65011bfb8783d5808787795c8786827">WritePage</a>(current_page_id, <span class="keyword">static_cast&lt;</span><span class="keyword">const </span><span class="keywordtype">char</span>*<span class="keyword">&gt;</span>(page_data));</div>
<div class="line"><span class="lineno">  529</span>            </div>
<div class="line"><span class="lineno">  530</span>            <span class="comment">// 重新获取锁</span></div>
<div class="line"><span class="lineno">  531</span>            <span class="comment">// Why: 需要重新获取锁以继续保护BufferPool的数据结构</span></div>
<div class="line"><span class="lineno">  532</span>            <span class="comment">// What: 使用带超时的方式重新加锁</span></div>
<div class="line"><span class="lineno">  533</span>            <span class="comment">// How: 调用try_lock_for()尝试重新获取latch_锁</span></div>
<div class="line"><span class="lineno">  534</span>            <span class="keywordflow">if</span> (!lock.try_lock_for(std::chrono::milliseconds(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad51347a7c8621ac0b20071c60fef39ee">lock_timeout_ms_</a>))) {</div>
<div class="line"><span class="lineno">  535</span>                <span class="comment">// 获取锁失败，记录警告并抛出异常</span></div>
<div class="line"><span class="lineno">  536</span>                <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Failed to re-acquire buffer pool lock after writing page &quot;</span> + std::to_string(current_page_id));</div>
<div class="line"><span class="lineno">  537</span>                <span class="keywordflow">throw</span> LockTimeoutException(<span class="stringliteral">&quot;Failed to re-acquire buffer pool lock after writing page&quot;</span>);</div>
<div class="line"><span class="lineno">  538</span>            }</div>
<div class="line"><span class="lineno">  539</span>            </div>
<div class="line"><span class="lineno">  540</span>            <span class="keywordflow">if</span> (!write_success) {</div>
<div class="line"><span class="lineno">  541</span>                <span class="comment">// 写入失败，恢复脏页标记</span></div>
<div class="line"><span class="lineno">  542</span>                <span class="comment">// Why: 写入磁盘失败可能导致数据丢失，必须恢复脏页状态</span></div>
<div class="line"><span class="lineno">  543</span>                <span class="comment">// What: 重新获取锁后恢复页面的脏页标记</span></div>
<div class="line"><span class="lineno">  544</span>                <span class="comment">// How: 在dirty_pages_哈希表中重新设置脏页标记</span></div>
<div class="line"><span class="lineno">  545</span>                <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>[current_page_id] = <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno">  546</span>                std::string error_msg = <span class="stringliteral">&quot;Failed to write dirty page ID &quot;</span> + std::to_string(current_page_id) + <span class="stringliteral">&quot; to disk&quot;</span>;</div>
<div class="line"><span class="lineno">  547</span>                <a class="code hl_define" href="logger_8h.html#a84e665e7d7b3157724d71a7c46644680">SQLCC_LOG_ERROR</a>(error_msg);</div>
<div class="line"><span class="lineno">  548</span>                </div>
<div class="line"><span class="lineno">  549</span>                <span class="comment">// 跳过此页面，继续查找下一个可替换页面</span></div>
<div class="line"><span class="lineno">  550</span>                <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno">  551</span>            }</div>
<div class="line"><span class="lineno">  552</span>            </div>
<div class="line"><span class="lineno">  553</span>            <span class="comment">// 写入成功，记录日志</span></div>
<div class="line"><span class="lineno">  554</span>            <span class="comment">// Why: 成功写入脏页到磁盘，可以安全进行页面替换</span></div>
<div class="line"><span class="lineno">  555</span>            <span class="comment">// What: 记录成功的磁盘写入操作，便于调试和监控</span></div>
<div class="line"><span class="lineno">  556</span>            <span class="comment">// How: 使用SQLCC_LOG_DEBUG记录调试级别日志</span></div>
<div class="line"><span class="lineno">  557</span>            <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Successfully wrote dirty page ID &quot;</span> + std::to_string(current_page_id) + <span class="stringliteral">&quot; to disk&quot;</span>);</div>
<div class="line"><span class="lineno">  558</span>            </div>
<div class="line"><span class="lineno">  559</span>            <span class="comment">// 页面已成功写回，现在可以安全替换</span></div>
<div class="line"><span class="lineno">  560</span>            <span class="comment">// Why: 脏页已经刷新到磁盘，可以安全地从内存中移除</span></div>
<div class="line"><span class="lineno">  561</span>            <span class="comment">// What: 页面已不再是脏页，可以进行正常的页面替换</span></div>
<div class="line"><span class="lineno">  562</span>            <span class="comment">// How: 继续执行页面移除逻辑（已在原代码中处理）</span></div>
<div class="line"><span class="lineno">  563</span>        }</div>
<div class="line"><span class="lineno">  564</span>        </div>
<div class="line"><span class="lineno">  565</span>        <span class="comment">// 从缓冲池中移除页面</span></div>
<div class="line"><span class="lineno">  566</span>        <span class="comment">// Why: 需要从页面表中删除页面，以释放页面占用的内存</span></div>
<div class="line"><span class="lineno">  567</span>        <span class="comment">// What: 从page_table_哈希表中删除页面ID</span></div>
<div class="line"><span class="lineno">  568</span>        <span class="comment">// How: 使用std::unordered_map的erase方法删除</span></div>
<div class="line"><span class="lineno">  569</span>        <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.erase(page_id);</div>
<div class="line"><span class="lineno">  570</span>        </div>
<div class="line"><span class="lineno">  571</span>        <span class="comment">// 从脏页表中移除</span></div>
<div class="line"><span class="lineno">  572</span>        <span class="comment">// Why: 需要从脏页表中删除页面，以释放脏页标记占用的内存</span></div>
<div class="line"><span class="lineno">  573</span>        <span class="comment">// What: 从dirty_pages_哈希表中删除页面ID</span></div>
<div class="line"><span class="lineno">  574</span>        <span class="comment">// How: 使用std::unordered_map的erase方法删除</span></div>
<div class="line"><span class="lineno">  575</span>        <span class="keywordflow">if</span> (dirty_it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>.end()) {</div>
<div class="line"><span class="lineno">  576</span>            <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>.erase(dirty_it);</div>
<div class="line"><span class="lineno">  577</span>        }</div>
<div class="line"><span class="lineno">  578</span>        </div>
<div class="line"><span class="lineno">  579</span>        <span class="comment">// 从引用计数表中移除</span></div>
<div class="line"><span class="lineno">  580</span>        <span class="comment">// Why: 需要从引用计数表中删除页面，以释放引用计数占用的内存</span></div>
<div class="line"><span class="lineno">  581</span>        <span class="comment">// What: 从page_refs_哈希表中删除页面ID</span></div>
<div class="line"><span class="lineno">  582</span>        <span class="comment">// How: 使用std::unordered_map的erase方法删除</span></div>
<div class="line"><span class="lineno">  583</span>        <span class="keywordflow">if</span> (ref_it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>.end()) {</div>
<div class="line"><span class="lineno">  584</span>            <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>.erase(ref_it);</div>
<div class="line"><span class="lineno">  585</span>        }</div>
<div class="line"><span class="lineno">  586</span>        </div>
<div class="line"><span class="lineno">  587</span>        <span class="comment">// 从LRU链表中移除</span></div>
<div class="line"><span class="lineno">  588</span>        <span class="comment">// Why: 需要从LRU链表中删除页面，以维护LRU链表的正确性</span></div>
<div class="line"><span class="lineno">  589</span>        <span class="comment">// What: 从lru_list_和lru_map_中删除页面ID</span></div>
<div class="line"><span class="lineno">  590</span>        <span class="comment">// How: 使用pop_back方法从链表尾部删除，并从lru_map_中删除映射</span></div>
<div class="line"><span class="lineno">  591</span>        <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.pop_back();</div>
<div class="line"><span class="lineno">  592</span>        <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ac6cc45a3a4a4ceabc7c0b57155fedd0b">lru_map_</a>.erase(page_id);</div>
<div class="line"><span class="lineno">  593</span>        </div>
<div class="line"><span class="lineno">  594</span>        <span class="comment">// 记录页面替换成功，便于调试</span></div>
<div class="line"><span class="lineno">  595</span>        <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Page ID &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; replaced&quot;</span>);</div>
<div class="line"><span class="lineno">  596</span>        <span class="keywordflow">return</span> page_id;</div>
<div class="line"><span class="lineno">  597</span>    }</div>
<div class="line"><span class="lineno">  598</span>    </div>
<div class="line"><span class="lineno">  599</span>    <span class="comment">// 无法找到可替换的页面，记录警告并返回-1</span></div>
<div class="line"><span class="lineno">  600</span>    <span class="comment">// Why: 如果所有页面都在使用中，无法进行页面替换，需要记录警告</span></div>
<div class="line"><span class="lineno">  601</span>    <span class="comment">// What: 创建警告消息，记录警告日志，然后返回-1</span></div>
<div class="line"><span class="lineno">  602</span>    <span class="comment">// How: 使用SQLCC_LOG_WARN记录警告级别日志，然后返回-1</span></div>
<div class="line"><span class="lineno">  603</span>    <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;No page can be replaced in buffer pool&quot;</span>);</div>
<div class="line"><span class="lineno">  604</span>    <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno">  605</span>}</div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="buffer__pool_8h_source.html#l00372">dirty_pages_</a>, <a class="el" href="buffer__pool_8h_source.html#l00311">disk_manager_</a>, <a class="el" href="page_8h_source.html#l00079">sqlcc::Page::GetData()</a>, <a class="el" href="buffer__pool_8h_source.html#l00347">latch_</a>, <a class="el" href="buffer__pool_8h_source.html#l00404">lock_timeout_ms_</a>, <a class="el" href="buffer__pool_8h_source.html#l00335">lru_list_</a>, <a class="el" href="buffer__pool_8h_source.html#l00341">lru_map_</a>, <a class="el" href="buffer__pool_8h_source.html#l00366">page_refs_</a>, <a class="el" href="buffer__pool_8h_source.html#l00329">page_table_</a>, <a class="el" href="logger_8h_source.html#l00265">SQLCC_LOG_DEBUG</a>, <a class="el" href="logger_8h_source.html#l00292">SQLCC_LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00283">SQLCC_LOG_WARN</a>, and <a class="el" href="disk__manager_8cpp_source.html#l00145">sqlcc::DiskManager::WritePage()</a>.</p>

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l00745">BatchFetchPages()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00063">FetchPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00652">NewPage()</a>, and <a class="el" href="buffer__pool_8cpp_source.html#l01022">PrefetchPage()</a>.</p>

</div>
</div>
<a id="aa148877a3be9b10ebfcd8e35029e4780" name="aa148877a3be9b10ebfcd8e35029e4780"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa148877a3be9b10ebfcd8e35029e4780">&#9670;&#160;</a></span>ReplacePage() <span class="overload">[2/3]</span></h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">bool sqlcc::BufferPool::ReplacePage </td>
          <td>(</td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>victim_page_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>new_page_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool__new_8cpp_source.html#l00413">413</a> of file <a class="el" href="buffer__pool__new_8cpp_source.html">buffer_pool_new.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  413</span>                                                                        {</div>
<div class="line"><span class="lineno">  414</span>  <span class="comment">// 避免未使用参数警告</span></div>
<div class="line"><span class="lineno">  415</span>  (void)victim_page_id;</div>
<div class="line"><span class="lineno">  416</span>  (void)new_page_id;</div>
<div class="line"><span class="lineno">  417</span> </div>
<div class="line"><span class="lineno">  418</span>  <span class="comment">// TODO: 实现页面替换逻辑</span></div>
<div class="line"><span class="lineno">  419</span>  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  420</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="aa148877a3be9b10ebfcd8e35029e4780" name="aa148877a3be9b10ebfcd8e35029e4780"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa148877a3be9b10ebfcd8e35029e4780">&#9670;&#160;</a></span>ReplacePage() <span class="overload">[3/3]</span></h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">bool sqlcc::BufferPool::ReplacePage </td>
          <td>(</td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>victim_page_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>new_page_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<a id="a31652cb0e19328cfe574ee9b67726bcf" name="a31652cb0e19328cfe574ee9b67726bcf"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a31652cb0e19328cfe574ee9b67726bcf">&#9670;&#160;</a></span>ReplacePageInternal()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">int32_t sqlcc::BufferPool::ReplacePageInternal </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8cpp_source.html#l01259">1259</a> of file <a class="el" href="buffer__pool_8cpp_source.html">buffer_pool.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno"> 1259</span>                                        {</div>
<div class="line"><span class="lineno"> 1260</span>    <span class="comment">// 从LRU链表尾部开始查找可替换的页面</span></div>
<div class="line"><span class="lineno"> 1261</span>    <span class="comment">// Why: LRU链表尾部是最近最少使用的页面，应该优先替换</span></div>
<div class="line"><span class="lineno"> 1262</span>    <span class="comment">// What: 从lru_list_的尾部开始遍历，查找引用计数为0的页面</span></div>
<div class="line"><span class="lineno"> 1263</span>    <span class="comment">// How: 使用反向迭代器从链表尾部开始遍历</span></div>
<div class="line"><span class="lineno"> 1264</span>    <span class="keywordflow">for</span> (<span class="keyword">auto</span> it = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.rbegin(); it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.rend(); ++it) {</div>
<div class="line"><span class="lineno"> 1265</span>        int32_t page_id = *it;</div>
<div class="line"><span class="lineno"> 1266</span>        </div>
<div class="line"><span class="lineno"> 1267</span>        <span class="comment">// 检查页面引用计数</span></div>
<div class="line"><span class="lineno"> 1268</span>        <span class="comment">// Why: 引用计数大于0的页面正在被使用，不能替换</span></div>
<div class="line"><span class="lineno"> 1269</span>        <span class="comment">// What: 检查page_refs_中该页面的引用计数</span></div>
<div class="line"><span class="lineno"> 1270</span>        <span class="comment">// How: 使用std::unordered_map的find方法查找引用计数</span></div>
<div class="line"><span class="lineno"> 1271</span>        <span class="keyword">auto</span> ref_it = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>.find(page_id);</div>
<div class="line"><span class="lineno"> 1272</span>        <span class="keywordflow">if</span> (ref_it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>.end() &amp;&amp; ref_it-&gt;second &gt; 0) {</div>
<div class="line"><span class="lineno"> 1273</span>            <span class="comment">// 页面正在被使用，不能替换，继续查找</span></div>
<div class="line"><span class="lineno"> 1274</span>            <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno"> 1275</span>        }</div>
<div class="line"><span class="lineno"> 1276</span>        </div>
<div class="line"><span class="lineno"> 1277</span>        <span class="comment">// 检查脏页标记</span></div>
<div class="line"><span class="lineno"> 1278</span>        <span class="comment">// Why: 如果页面是脏的，需要先写回磁盘才能替换</span></div>
<div class="line"><span class="lineno"> 1279</span>        <span class="comment">// What: 检查页面是否在脏页列表中</span></div>
<div class="line"><span class="lineno"> 1280</span>        <span class="comment">// How: 使用std::unordered_map的find方法查找页面ID</span></div>
<div class="line"><span class="lineno"> 1281</span>        <span class="keyword">auto</span> dirty_it = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>.find(page_id);</div>
<div class="line"><span class="lineno"> 1282</span>        <span class="keywordflow">if</span> (dirty_it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>.end() &amp;&amp; dirty_it-&gt;second) {</div>
<div class="line"><span class="lineno"> 1283</span>            <span class="comment">// 跳过脏页，不在此次调整中处理，避免复杂的磁盘I/O操作</span></div>
<div class="line"><span class="lineno"> 1284</span>            <span class="comment">// Why: 在配置调整过程中处理脏页可能引起复杂的状态同步问题</span></div>
<div class="line"><span class="lineno"> 1285</span>            <span class="comment">// What: 跳过脏页，专注于页面数量调整</span></div>
<div class="line"><span class="lineno"> 1286</span>            <span class="comment">// How: 继续查找下一个可替换的页面</span></div>
<div class="line"><span class="lineno"> 1287</span>            <span class="keywordflow">continue</span>;</div>
<div class="line"><span class="lineno"> 1288</span>        }</div>
<div class="line"><span class="lineno"> 1289</span>        </div>
<div class="line"><span class="lineno"> 1290</span>        <span class="comment">// 从缓冲池中移除页面</span></div>
<div class="line"><span class="lineno"> 1291</span>        <span class="comment">// Why: 需要从页面表中删除页面，以释放页面占用的内存</span></div>
<div class="line"><span class="lineno"> 1292</span>        <span class="comment">// What: 从page_table_哈希表中删除页面ID</span></div>
<div class="line"><span class="lineno"> 1293</span>        <span class="comment">// How: 使用std::unordered_map的erase方法删除</span></div>
<div class="line"><span class="lineno"> 1294</span>        <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.erase(page_id);</div>
<div class="line"><span class="lineno"> 1295</span>        </div>
<div class="line"><span class="lineno"> 1296</span>        <span class="comment">// 从脏页表中移除</span></div>
<div class="line"><span class="lineno"> 1297</span>        <span class="comment">// Why: 需要从脏页表中删除页面，以释放脏页标记占用的内存</span></div>
<div class="line"><span class="lineno"> 1298</span>        <span class="comment">// What: 从dirty_pages_哈希表中删除页面ID</span></div>
<div class="line"><span class="lineno"> 1299</span>        <span class="comment">// How: 使用std::unordered_map的erase方法删除</span></div>
<div class="line"><span class="lineno"> 1300</span>        <span class="keywordflow">if</span> (dirty_it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>.end()) {</div>
<div class="line"><span class="lineno"> 1301</span>            <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>.erase(dirty_it);</div>
<div class="line"><span class="lineno"> 1302</span>        }</div>
<div class="line"><span class="lineno"> 1303</span>        </div>
<div class="line"><span class="lineno"> 1304</span>        <span class="comment">// 从引用计数表中移除</span></div>
<div class="line"><span class="lineno"> 1305</span>        <span class="comment">// Why: 需要从引用计数表中删除页面，以释放引用计数占用的内存</span></div>
<div class="line"><span class="lineno"> 1306</span>        <span class="comment">// What: 从page_refs_哈希表中删除页面ID</span></div>
<div class="line"><span class="lineno"> 1307</span>        <span class="comment">// How: 使用std::unordered_map的erase方法删除</span></div>
<div class="line"><span class="lineno"> 1308</span>        <span class="keywordflow">if</span> (ref_it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>.end()) {</div>
<div class="line"><span class="lineno"> 1309</span>            <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>.erase(ref_it);</div>
<div class="line"><span class="lineno"> 1310</span>        }</div>
<div class="line"><span class="lineno"> 1311</span>        </div>
<div class="line"><span class="lineno"> 1312</span>        <span class="comment">// 从LRU链表中移除</span></div>
<div class="line"><span class="lineno"> 1313</span>        <span class="comment">// Why: 需要从LRU链表中删除页面，以维护LRU链表的正确性</span></div>
<div class="line"><span class="lineno"> 1314</span>        <span class="comment">// What: 从lru_list_和lru_map_中删除页面ID</span></div>
<div class="line"><span class="lineno"> 1315</span>        <span class="comment">// How: 使用pop_back方法从链表尾部删除，并从lru_map_中删除映射</span></div>
<div class="line"><span class="lineno"> 1316</span>        <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.pop_back();</div>
<div class="line"><span class="lineno"> 1317</span>        <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ac6cc45a3a4a4ceabc7c0b57155fedd0b">lru_map_</a>.erase(page_id);</div>
<div class="line"><span class="lineno"> 1318</span>        </div>
<div class="line"><span class="lineno"> 1319</span>        <span class="comment">// 记录页面移除成功，便于调试</span></div>
<div class="line"><span class="lineno"> 1320</span>        <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Page ID &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; removed during buffer pool size adjustment&quot;</span>);</div>
<div class="line"><span class="lineno"> 1321</span>        <span class="keywordflow">return</span> page_id;</div>
<div class="line"><span class="lineno"> 1322</span>    }</div>
<div class="line"><span class="lineno"> 1323</span>    </div>
<div class="line"><span class="lineno"> 1324</span>    <span class="comment">// 无法找到可替换的页面，记录警告并返回-1</span></div>
<div class="line"><span class="lineno"> 1325</span>    <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;No clean page can be removed in buffer pool size adjustment&quot;</span>);</div>
<div class="line"><span class="lineno"> 1326</span>    <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno"> 1327</span>}</div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="buffer__pool_8h_source.html#l00372">dirty_pages_</a>, <a class="el" href="buffer__pool_8h_source.html#l00335">lru_list_</a>, <a class="el" href="buffer__pool_8h_source.html#l00341">lru_map_</a>, <a class="el" href="buffer__pool_8h_source.html#l00366">page_refs_</a>, <a class="el" href="buffer__pool_8h_source.html#l00329">page_table_</a>, <a class="el" href="logger_8h_source.html#l00265">SQLCC_LOG_DEBUG</a>, and <a class="el" href="logger_8h_source.html#l00283">SQLCC_LOG_WARN</a>.</p>

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l01333">AdjustBufferPoolSize()</a>.</p>

</div>
</div>
<a id="a8cfea66edcf4a56f346a03d87e35c9df" name="a8cfea66edcf4a56f346a03d87e35c9df"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8cfea66edcf4a56f346a03d87e35c9df">&#9670;&#160;</a></span>Resize()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool sqlcc::BufferPool::Resize </td>
          <td>(</td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>new_pool_size</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool__new_8cpp_source.html#l00344">344</a> of file <a class="el" href="buffer__pool__new_8cpp_source.html">buffer_pool_new.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  344</span>                                            {</div>
<div class="line"><span class="lineno">  345</span>  std::unique_lock&lt;std::timed_mutex&gt; lock(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#add85ac70113f80ae97898aada5f87994">latch_</a>, std::defer_lock);</div>
<div class="line"><span class="lineno">  346</span>  <span class="keywordflow">if</span> (!lock.try_lock_for(std::chrono::milliseconds(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad51347a7c8621ac0b20071c60fef39ee">lock_timeout_ms_</a>))) {</div>
<div class="line"><span class="lineno">  347</span>    <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Failed to acquire buffer pool lock for resizing&quot;</span>);</div>
<div class="line"><span class="lineno">  348</span>    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  349</span>  }</div>
<div class="line"><span class="lineno">  350</span> </div>
<div class="line"><span class="lineno">  351</span>  <a class="code hl_define" href="logger_8h.html#a51a9494ff02cefe77ed341798f825fdf">SQLCC_LOG_INFO</a>(<span class="stringliteral">&quot;Resizing buffer pool from &quot;</span> + std::to_string(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ab824ca05f9fc912a0d2def90f30412fa">pool_size_</a>) +</div>
<div class="line"><span class="lineno">  352</span>                 <span class="stringliteral">&quot; to &quot;</span> + std::to_string(new_pool_size));</div>
<div class="line"><span class="lineno">  353</span> </div>
<div class="line"><span class="lineno">  354</span>  <span class="keywordflow">if</span> (new_pool_size &lt; <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.size()) {</div>
<div class="line"><span class="lineno">  355</span>    <span class="comment">// Need to evict some pages</span></div>
<div class="line"><span class="lineno">  356</span>    <span class="keywordtype">size_t</span> pages_to_evict = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.size() - new_pool_size;</div>
<div class="line"><span class="lineno">  357</span> </div>
<div class="line"><span class="lineno">  358</span>    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; pages_to_evict; ++i) {</div>
<div class="line"><span class="lineno">  359</span>      int32_t victim_id = <a class="code hl_function" href="classsqlcc_1_1BufferPool.html#ae0096083797a56ae4ed4b28800bc5ad6">FindVictimPage</a>();</div>
<div class="line"><span class="lineno">  360</span>      <span class="keywordflow">if</span> (victim_id == -1) {</div>
<div class="line"><span class="lineno">  361</span>        <a class="code hl_define" href="logger_8h.html#a84e665e7d7b3157724d71a7c46644680">SQLCC_LOG_ERROR</a>(</div>
<div class="line"><span class="lineno">  362</span>            <span class="stringliteral">&quot;Cannot resize buffer pool - no pages available for eviction&quot;</span>);</div>
<div class="line"><span class="lineno">  363</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  364</span>      }</div>
<div class="line"><span class="lineno">  365</span> </div>
<div class="line"><span class="lineno">  366</span>      <span class="keywordflow">if</span> (!<a class="code hl_function" href="classsqlcc_1_1BufferPool.html#a7e1ed47ea2f229397ec3e54b57d41868">ReplacePage</a>(victim_id, -1)) {</div>
<div class="line"><span class="lineno">  367</span>        <a class="code hl_define" href="logger_8h.html#a84e665e7d7b3157724d71a7c46644680">SQLCC_LOG_ERROR</a>(<span class="stringliteral">&quot;Failed to evict page during resize&quot;</span>);</div>
<div class="line"><span class="lineno">  368</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  369</span>      }</div>
<div class="line"><span class="lineno">  370</span>    }</div>
<div class="line"><span class="lineno">  371</span>  }</div>
<div class="line"><span class="lineno">  372</span> </div>
<div class="line"><span class="lineno">  373</span>  <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ab824ca05f9fc912a0d2def90f30412fa">pool_size_</a> = new_pool_size;</div>
<div class="line"><span class="lineno">  374</span>  <a class="code hl_define" href="logger_8h.html#a51a9494ff02cefe77ed341798f825fdf">SQLCC_LOG_INFO</a>(<span class="stringliteral">&quot;Buffer pool resized successfully to &quot;</span> +</div>
<div class="line"><span class="lineno">  375</span>                 std::to_string(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ab824ca05f9fc912a0d2def90f30412fa">pool_size_</a>));</div>
<div class="line"><span class="lineno">  376</span>  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno">  377</span>}</div>
<div class="ttc" id="aclasssqlcc_1_1BufferPool_html_ae0096083797a56ae4ed4b28800bc5ad6"><div class="ttname"><a href="classsqlcc_1_1BufferPool.html#ae0096083797a56ae4ed4b28800bc5ad6">sqlcc::BufferPool::FindVictimPage</a></div><div class="ttdeci">int32_t FindVictimPage()</div><div class="ttdef"><b>Definition</b> <a href="buffer__pool__new_8cpp_source.html#l00400">buffer_pool_new.cpp:400</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="logger_8h_source.html#l00292">SQLCC_LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00274">SQLCC_LOG_INFO</a>, and <a class="el" href="logger_8h_source.html#l00283">SQLCC_LOG_WARN</a>.</p>

</div>
</div>
<a id="a1d60f9455553ca6e7047b24818e853a5" name="a1d60f9455553ca6e7047b24818e853a5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1d60f9455553ca6e7047b24818e853a5">&#9670;&#160;</a></span>SetEnableConfigCallback()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void sqlcc::BufferPool::SetEnableConfigCallback </td>
          <td>(</td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8h_source.html#l00244">244</a> of file <a class="el" href="buffer__pool_8h_source.html">buffer_pool.h</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  244</span>{}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a4ba1058d89ffa3c56845412bcbd27f09" name="a4ba1058d89ffa3c56845412bcbd27f09"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4ba1058d89ffa3c56845412bcbd27f09">&#9670;&#160;</a></span>SetSimulateFlushFailure()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void sqlcc::BufferPool::SetSimulateFlushFailure </td>
          <td>(</td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>simulate</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8h_source.html#l00238">238</a> of file <a class="el" href="buffer__pool_8h_source.html">buffer_pool.h</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  238</span>{ <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6a1ad43771d8cae7413806fbb7db31dd">simulate_flush_failure_</a> = simulate; }</div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="buffer__pool_8h_source.html#l00396">simulate_flush_failure_</a>.</p>

</div>
</div>
<a id="ac9b37e03a56a791dd483858d76ad4299" name="ac9b37e03a56a791dd483858d76ad4299"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac9b37e03a56a791dd483858d76ad4299">&#9670;&#160;</a></span>UnpinPage() <span class="overload">[1/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool sqlcc::BufferPool::UnpinPage </td>
          <td>(</td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>page_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>is_dirty</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8cpp_source.html#l00406">406</a> of file <a class="el" href="buffer__pool_8cpp_source.html">buffer_pool.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  406</span>                                                         {</div>
<div class="line"><span class="lineno">  407</span>    <span class="comment">// 加锁保护并发访问 - 使用带超时的unique_lock以支持临时解锁避免死锁</span></div>
<div class="line"><span class="lineno">  408</span>    std::unique_lock&lt;std::timed_mutex&gt; lock(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#add85ac70113f80ae97898aada5f87994">latch_</a>, std::defer_lock);</div>
<div class="line"><span class="lineno">  409</span>    <span class="keywordflow">if</span> (!lock.try_lock_for(std::chrono::milliseconds(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6f94e56229b9887a9c10b6305825cf31">write_lock_timeout_ms_</a>))) {</div>
<div class="line"><span class="lineno">  410</span>        <span class="comment">// 获取锁失败，记录警告但不抛出异常，避免在高并发场景下级联失败</span></div>
<div class="line"><span class="lineno">  411</span>        <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Failed to acquire buffer pool lock for unpinning page &quot;</span> + std::to_string(page_id) + </div>
<div class="line"><span class="lineno">  412</span>                      <span class="stringliteral">&quot;, timeout after &quot;</span> + std::to_string(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6f94e56229b9887a9c10b6305825cf31">write_lock_timeout_ms_</a>) + <span class="stringliteral">&quot;ms&quot;</span>);</div>
<div class="line"><span class="lineno">  413</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  414</span>    }</div>
<div class="line"><span class="lineno">  415</span>    </div>
<div class="line"><span class="lineno">  416</span>    <span class="comment">// 检查页面是否存在</span></div>
<div class="line"><span class="lineno">  417</span>    <span class="comment">// Why: 需要确保页面确实存在于缓冲池中，避免操作不存在的页面</span></div>
<div class="line"><span class="lineno">  418</span>    <span class="comment">// What: 在page_table_中查找页面ID</span></div>
<div class="line"><span class="lineno">  419</span>    <span class="comment">// How: 使用std::unordered_map的find方法查找</span></div>
<div class="line"><span class="lineno">  420</span>    <span class="keyword">auto</span> it = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.find(page_id);</div>
<div class="line"><span class="lineno">  421</span>    <span class="keywordflow">if</span> (it == <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a6558e895d89c28c3a7a52d6c1e534309">page_table_</a>.end()) {</div>
<div class="line"><span class="lineno">  422</span>        <span class="comment">// 页面不存在，记录警告并返回false</span></div>
<div class="line"><span class="lineno">  423</span>        <span class="comment">// Why: 页面不存在于缓冲池中，无法取消固定</span></div>
<div class="line"><span class="lineno">  424</span>        <span class="comment">// What: 记录警告信息并返回false表示操作失败</span></div>
<div class="line"><span class="lineno">  425</span>        <span class="comment">// How: 使用SQLCC_LOG_WARN记录警告，然后返回false</span></div>
<div class="line"><span class="lineno">  426</span>        <a class="code hl_define" href="logger_8h.html#a6288fa1e809caec231f7ba41f7f9b6e2">SQLCC_LOG_WARN</a>(<span class="stringliteral">&quot;Page ID &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; not found in buffer pool&quot;</span>);</div>
<div class="line"><span class="lineno">  427</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  428</span>    }</div>
<div class="line"><span class="lineno">  429</span>    </div>
<div class="line"><span class="lineno">  430</span>    <span class="comment">// 减少引用计数</span></div>
<div class="line"><span class="lineno">  431</span>    <span class="comment">// Why: 页面使用完毕，需要减少引用计数，以便缓冲池可以正确管理页面的生命周期</span></div>
<div class="line"><span class="lineno">  432</span>    <span class="comment">// What: 减少page_refs_中该页面的引用计数</span></div>
<div class="line"><span class="lineno">  433</span>    <span class="comment">// How: 先检查当前引用计数，确保减少后不会变为负数</span></div>
<div class="line"><span class="lineno">  434</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>[page_id] &gt; 0) {</div>
<div class="line"><span class="lineno">  435</span>        <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>[page_id]--;</div>
<div class="line"><span class="lineno">  436</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  437</span>        <span class="comment">// 引用计数已经为0或负数，表示页面已经被完全释放</span></div>
<div class="line"><span class="lineno">  438</span>        <span class="comment">// Why: 重复调用UnpinPage表示程序逻辑错误</span></div>
<div class="line"><span class="lineno">  439</span>        <span class="comment">// What: 记录错误信息并返回false表示操作失败</span></div>
<div class="line"><span class="lineno">  440</span>        <span class="comment">// How: 使用SQLCC_LOG_ERROR记录错误级别日志，然后返回false</span></div>
<div class="line"><span class="lineno">  441</span>        <a class="code hl_define" href="logger_8h.html#a84e665e7d7b3157724d71a7c46644680">SQLCC_LOG_ERROR</a>(<span class="stringliteral">&quot;Attempting to unpin page &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; with reference count &quot;</span> +</div>
<div class="line"><span class="lineno">  442</span>                      std::to_string(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>[page_id]) + <span class="stringliteral">&quot;, page already fully unpinned&quot;</span>);</div>
<div class="line"><span class="lineno">  443</span>        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">  444</span>    }</div>
<div class="line"><span class="lineno">  445</span>    </div>
<div class="line"><span class="lineno">  446</span>    <span class="comment">// 标记页面为脏页（如果被修改）</span></div>
<div class="line"><span class="lineno">  447</span>    <span class="comment">// Why: 如果页面被修改过，需要标记为脏页，以便在替换时写回磁盘</span></div>
<div class="line"><span class="lineno">  448</span>    <span class="comment">// What: 如果is_dirty为true，则将页面标记为脏页</span></div>
<div class="line"><span class="lineno">  449</span>    <span class="comment">// How: 在dirty_pages_哈希表中设置页面ID的值为true</span></div>
<div class="line"><span class="lineno">  450</span>    <span class="keywordflow">if</span> (is_dirty) {</div>
<div class="line"><span class="lineno">  451</span>        <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a08cc880334bde9136f0a614786afea5d">dirty_pages_</a>[page_id] = <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno">  452</span>        <span class="comment">// 记录页面被标记为脏页的信息，便于调试</span></div>
<div class="line"><span class="lineno">  453</span>        <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Page ID &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; marked as dirty&quot;</span>);</div>
<div class="line"><span class="lineno">  454</span>    }</div>
<div class="line"><span class="lineno">  455</span>    </div>
<div class="line"><span class="lineno">  456</span>    <span class="comment">// 记录取消固定页面的信息，便于调试</span></div>
<div class="line"><span class="lineno">  457</span>    <a class="code hl_define" href="logger_8h.html#a745e4cf15e366f591854e16f189a8ccc">SQLCC_LOG_DEBUG</a>(<span class="stringliteral">&quot;Page ID &quot;</span> + std::to_string(page_id) + <span class="stringliteral">&quot; unpinned, refs: &quot;</span> + std::to_string(<a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ad5caecdc03c1393603275e080c052bd4">page_refs_</a>[page_id]));</div>
<div class="line"><span class="lineno">  458</span>    </div>
<div class="line"><span class="lineno">  459</span>    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno">  460</span>}</div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="buffer__pool_8h_source.html#l00372">dirty_pages_</a>, <a class="el" href="buffer__pool_8h_source.html#l00347">latch_</a>, <a class="el" href="buffer__pool_8h_source.html#l00366">page_refs_</a>, <a class="el" href="buffer__pool_8h_source.html#l00329">page_table_</a>, <a class="el" href="logger_8h_source.html#l00265">SQLCC_LOG_DEBUG</a>, <a class="el" href="logger_8h_source.html#l00292">SQLCC_LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00283">SQLCC_LOG_WARN</a>, and <a class="el" href="buffer__pool_8h_source.html#l00403">write_lock_timeout_ms_</a>.</p>

</div>
</div>
<a id="ac9b37e03a56a791dd483858d76ad4299" name="ac9b37e03a56a791dd483858d76ad4299"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac9b37e03a56a791dd483858d76ad4299">&#9670;&#160;</a></span>UnpinPage() <span class="overload">[2/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool sqlcc::BufferPool::UnpinPage </td>
          <td>(</td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>page_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>is_dirty</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="af7823ea920cd5e3239e2f9ac5b4860d2" name="af7823ea920cd5e3239e2f9ac5b4860d2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af7823ea920cd5e3239e2f9ac5b4860d2">&#9670;&#160;</a></span>UpdateLRU()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void sqlcc::BufferPool::UpdateLRU </td>
          <td>(</td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>page_id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool__new_8cpp_source.html#l00423">423</a> of file <a class="el" href="buffer__pool__new_8cpp_source.html">buffer_pool_new.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">  423</span>                                          {</div>
<div class="line"><span class="lineno">  424</span>  <span class="keyword">auto</span> it = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ac6cc45a3a4a4ceabc7c0b57155fedd0b">lru_map_</a>.find(page_id);</div>
<div class="line"><span class="lineno">  425</span>  <span class="keywordflow">if</span> (it != <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#ac6cc45a3a4a4ceabc7c0b57155fedd0b">lru_map_</a>.end()) {</div>
<div class="line"><span class="lineno">  426</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.erase(it-&gt;second);</div>
<div class="line"><span class="lineno">  427</span>    <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.push_front(page_id);</div>
<div class="line"><span class="lineno">  428</span>    it-&gt;second = <a class="code hl_variable" href="classsqlcc_1_1BufferPool.html#a1aa80be20bb1b29ae3a8045fef1efb54">lru_list_</a>.begin();</div>
<div class="line"><span class="lineno">  429</span>  }</div>
<div class="line"><span class="lineno">  430</span>}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a78d1dd2d7460d0eb2c7bf21ba2e97f75" name="a78d1dd2d7460d0eb2c7bf21ba2e97f75"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a78d1dd2d7460d0eb2c7bf21ba2e97f75">&#9670;&#160;</a></span>UpdateLRUList()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void sqlcc::BufferPool::UpdateLRUList </td>
          <td>(</td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>page_id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

</div>
</div>
<h2 class="groupheader">Member Data Documentation</h2>
<a id="a9b5dc3d10a60b03cdfa04a9629e46df1" name="a9b5dc3d10a60b03cdfa04a9629e46df1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9b5dc3d10a60b03cdfa04a9629e46df1">&#9670;&#160;</a></span>access_stats_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">std::unordered_map&lt;int32_t, int&gt; sqlcc::BufferPool::access_stats_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8h_source.html#l00384">384</a> of file <a class="el" href="buffer__pool_8h_source.html">buffer_pool.h</a>.</p>

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l00745">BatchFetchPages()</a>, and <a class="el" href="buffer__pool_8cpp_source.html#l00063">FetchPage()</a>.</p>

</div>
</div>
<a id="aec6235e35f498e90ed5c66bf1ca8b4d2" name="aec6235e35f498e90ed5c66bf1ca8b4d2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aec6235e35f498e90ed5c66bf1ca8b4d2">&#9670;&#160;</a></span>batch_buffer_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">std::vector&lt;char*&gt; sqlcc::BufferPool::batch_buffer_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8h_source.html#l00390">390</a> of file <a class="el" href="buffer__pool_8h_source.html">buffer_pool.h</a>.</p>

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l00015">BufferPool()</a>.</p>

</div>
</div>
<a id="a52b7cc65c932b03c35af2e56916e9c9d" name="a52b7cc65c932b03c35af2e56916e9c9d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a52b7cc65c932b03c35af2e56916e9c9d">&#9670;&#160;</a></span>config_manager_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classsqlcc_1_1ConfigManager.html">ConfigManager</a> &amp; sqlcc::BufferPool::config_manager_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8h_source.html#l00317">317</a> of file <a class="el" href="buffer__pool_8h_source.html">buffer_pool.h</a>.</p>

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l00930">BatchPrefetchPages()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00015">BufferPool()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01140">GetStats()</a>, and <a class="el" href="buffer__pool_8cpp_source.html#l01022">PrefetchPage()</a>.</p>

</div>
</div>
<a id="a08cc880334bde9136f0a614786afea5d" name="a08cc880334bde9136f0a614786afea5d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a08cc880334bde9136f0a614786afea5d">&#9670;&#160;</a></span>dirty_pages_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">std::unordered_map&lt; int32_t, bool &gt; sqlcc::BufferPool::dirty_pages_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8h_source.html#l00372">372</a> of file <a class="el" href="buffer__pool_8h_source.html">buffer_pool.h</a>.</p>

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l00745">BatchFetchPages()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00279">DeletePage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00063">FetchPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00869">FlushAllPages()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00184">FlushPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01140">GetStats()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00652">NewPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01022">PrefetchPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00466">ReplacePage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01259">ReplacePageInternal()</a>, and <a class="el" href="buffer__pool_8cpp_source.html#l00406">UnpinPage()</a>.</p>

</div>
</div>
<a id="a85424d92e888ae0b2a0754e7fea7d089" name="a85424d92e888ae0b2a0754e7fea7d089"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a85424d92e888ae0b2a0754e7fea7d089">&#9670;&#160;</a></span>disk_manager_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classsqlcc_1_1DiskManager.html">DiskManager</a> * sqlcc::BufferPool::disk_manager_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8h_source.html#l00311">311</a> of file <a class="el" href="buffer__pool_8h_source.html">buffer_pool.h</a>.</p>

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l00745">BatchFetchPages()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00930">BatchPrefetchPages()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00279">DeletePage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00063">FetchPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00869">FlushAllPages()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00184">FlushPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00652">NewPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01022">PrefetchPage()</a>, and <a class="el" href="buffer__pool_8cpp_source.html#l00466">ReplacePage()</a>.</p>

</div>
</div>
<a id="add85ac70113f80ae97898aada5f87994" name="add85ac70113f80ae97898aada5f87994"></a>
<h2 class="memtitle"><span class="permalink"><a href="#add85ac70113f80ae97898aada5f87994">&#9670;&#160;</a></span>latch_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">std::timed_mutex sqlcc::BufferPool::latch_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">mutable</span><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8h_source.html#l00347">347</a> of file <a class="el" href="buffer__pool_8h_source.html">buffer_pool.h</a>.</p>

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l01333">AdjustBufferPoolSize()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00745">BatchFetchPages()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00930">BatchPrefetchPages()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00279">DeletePage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00063">FetchPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00869">FlushAllPages()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00184">FlushPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01140">GetStats()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01244">IsPageInBuffer()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00652">NewPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01022">PrefetchPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00466">ReplacePage()</a>, and <a class="el" href="buffer__pool_8cpp_source.html#l00406">UnpinPage()</a>.</p>

</div>
</div>
<a id="ad51347a7c8621ac0b20071c60fef39ee" name="ad51347a7c8621ac0b20071c60fef39ee"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad51347a7c8621ac0b20071c60fef39ee">&#9670;&#160;</a></span>lock_timeout_ms_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">size_t sqlcc::BufferPool::lock_timeout_ms_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8h_source.html#l00404">404</a> of file <a class="el" href="buffer__pool_8h_source.html">buffer_pool.h</a>.</p>

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l00015">BufferPool()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00184">FlushPage()</a>, and <a class="el" href="buffer__pool_8cpp_source.html#l00466">ReplacePage()</a>.</p>

</div>
</div>
<a id="a1aa80be20bb1b29ae3a8045fef1efb54" name="a1aa80be20bb1b29ae3a8045fef1efb54"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1aa80be20bb1b29ae3a8045fef1efb54">&#9670;&#160;</a></span>lru_list_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">std::list&lt; int32_t &gt; sqlcc::BufferPool::lru_list_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8h_source.html#l00335">335</a> of file <a class="el" href="buffer__pool_8h_source.html">buffer_pool.h</a>.</p>

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l00745">BatchFetchPages()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00063">FetchPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01140">GetStats()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00612">MoveToHead()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00652">NewPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01022">PrefetchPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01223">RemoveFromLRUList()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00466">ReplacePage()</a>, and <a class="el" href="buffer__pool_8cpp_source.html#l01259">ReplacePageInternal()</a>.</p>

</div>
</div>
<a id="ac6cc45a3a4a4ceabc7c0b57155fedd0b" name="ac6cc45a3a4a4ceabc7c0b57155fedd0b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac6cc45a3a4a4ceabc7c0b57155fedd0b">&#9670;&#160;</a></span>lru_map_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">std::unordered_map&lt; int32_t, std::list&lt; int32_t &gt;::iterator &gt; sqlcc::BufferPool::lru_map_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8h_source.html#l00341">341</a> of file <a class="el" href="buffer__pool_8h_source.html">buffer_pool.h</a>.</p>

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l00745">BatchFetchPages()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00063">FetchPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00612">MoveToHead()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00652">NewPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01022">PrefetchPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01223">RemoveFromLRUList()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00466">ReplacePage()</a>, and <a class="el" href="buffer__pool_8cpp_source.html#l01259">ReplacePageInternal()</a>.</p>

</div>
</div>
<a id="aeb20d8120bd8b322067b9337bca45bdb" name="aeb20d8120bd8b322067b9337bca45bdb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aeb20d8120bd8b322067b9337bca45bdb">&#9670;&#160;</a></span>metrics_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="structsqlcc_1_1BufferPool_1_1Metrics.html">Metrics</a> sqlcc::BufferPool::metrics_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">mutable</span><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool__new_8h_source.html#l00100">100</a> of file <a class="el" href="buffer__pool__new_8h_source.html">buffer_pool_new.h</a>.</p>

</div>
</div>
<a id="ad5caecdc03c1393603275e080c052bd4" name="ad5caecdc03c1393603275e080c052bd4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad5caecdc03c1393603275e080c052bd4">&#9670;&#160;</a></span>page_refs_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">std::unordered_map&lt; int32_t, int &gt; sqlcc::BufferPool::page_refs_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8h_source.html#l00366">366</a> of file <a class="el" href="buffer__pool_8h_source.html">buffer_pool.h</a>.</p>

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l00745">BatchFetchPages()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00279">DeletePage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00063">FetchPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01140">GetStats()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00652">NewPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01022">PrefetchPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00466">ReplacePage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01259">ReplacePageInternal()</a>, and <a class="el" href="buffer__pool_8cpp_source.html#l00406">UnpinPage()</a>.</p>

</div>
</div>
<a id="a6558e895d89c28c3a7a52d6c1e534309" name="a6558e895d89c28c3a7a52d6c1e534309"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6558e895d89c28c3a7a52d6c1e534309">&#9670;&#160;</a></span>page_table_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">std::unordered_map&lt; int32_t, <a class="el" href="classsqlcc_1_1Page.html">Page</a> * &gt; sqlcc::BufferPool::page_table_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8h_source.html#l00329">329</a> of file <a class="el" href="buffer__pool_8h_source.html">buffer_pool.h</a>.</p>

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l01333">AdjustBufferPoolSize()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00745">BatchFetchPages()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00930">BatchPrefetchPages()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00279">DeletePage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00063">FetchPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00869">FlushAllPages()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00184">FlushPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01140">GetStats()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01244">IsPageInBuffer()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00652">NewPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01022">PrefetchPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00466">ReplacePage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01259">ReplacePageInternal()</a>, and <a class="el" href="buffer__pool_8cpp_source.html#l00406">UnpinPage()</a>.</p>

</div>
</div>
<a id="ab824ca05f9fc912a0d2def90f30412fa" name="ab824ca05f9fc912a0d2def90f30412fa"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab824ca05f9fc912a0d2def90f30412fa">&#9670;&#160;</a></span>pool_size_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">size_t sqlcc::BufferPool::pool_size_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8h_source.html#l00323">323</a> of file <a class="el" href="buffer__pool_8h_source.html">buffer_pool.h</a>.</p>

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l01333">AdjustBufferPoolSize()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00745">BatchFetchPages()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00015">BufferPool()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00063">FetchPage()</a>, <a class="el" href="buffer__pool__new_8h_source.html#l00072">GetPoolSize()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01140">GetStats()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00652">NewPage()</a>, and <a class="el" href="buffer__pool_8cpp_source.html#l01022">PrefetchPage()</a>.</p>

</div>
</div>
<a id="af1b9545a6884861a6d10237e0131fee5" name="af1b9545a6884861a6d10237e0131fee5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af1b9545a6884861a6d10237e0131fee5">&#9670;&#160;</a></span>prefetch_queue_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">std::deque&lt;int32_t&gt; sqlcc::BufferPool::prefetch_queue_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8h_source.html#l00378">378</a> of file <a class="el" href="buffer__pool_8h_source.html">buffer_pool.h</a>.</p>

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l00930">BatchPrefetchPages()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l01140">GetStats()</a>, and <a class="el" href="buffer__pool_8cpp_source.html#l01022">PrefetchPage()</a>.</p>

</div>
</div>
<a id="abe6985900d8804e2c0fe37299133eb08" name="abe6985900d8804e2c0fe37299133eb08"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abe6985900d8804e2c0fe37299133eb08">&#9670;&#160;</a></span>read_lock_timeout_ms_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">size_t sqlcc::BufferPool::read_lock_timeout_ms_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8h_source.html#l00402">402</a> of file <a class="el" href="buffer__pool_8h_source.html">buffer_pool.h</a>.</p>

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l00930">BatchPrefetchPages()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00015">BufferPool()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00063">FetchPage()</a>, and <a class="el" href="buffer__pool_8cpp_source.html#l01022">PrefetchPage()</a>.</p>

</div>
</div>
<a id="a6a1ad43771d8cae7413806fbb7db31dd" name="a6a1ad43771d8cae7413806fbb7db31dd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6a1ad43771d8cae7413806fbb7db31dd">&#9670;&#160;</a></span>simulate_flush_failure_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">bool sqlcc::BufferPool::simulate_flush_failure_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8h_source.html#l00396">396</a> of file <a class="el" href="buffer__pool_8h_source.html">buffer_pool.h</a>.</p>

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l00184">FlushPage()</a>, and <a class="el" href="buffer__pool_8h_source.html#l00238">SetSimulateFlushFailure()</a>.</p>

</div>
</div>
<a id="a4f10df0f06c12c12ab49e0a4db686de4" name="a4f10df0f06c12c12ab49e0a4db686de4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4f10df0f06c12c12ab49e0a4db686de4">&#9670;&#160;</a></span>stats_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structsqlcc_1_1BufferPool_1_1Stats.html">sqlcc::BufferPool::Stats</a> sqlcc::BufferPool::stats_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l01022">PrefetchPage()</a>.</p>

</div>
</div>
<a id="a6f94e56229b9887a9c10b6305825cf31" name="a6f94e56229b9887a9c10b6305825cf31"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6f94e56229b9887a9c10b6305825cf31">&#9670;&#160;</a></span>write_lock_timeout_ms_</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">size_t sqlcc::BufferPool::write_lock_timeout_ms_</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="buffer__pool_8h_source.html#l00403">403</a> of file <a class="el" href="buffer__pool_8h_source.html">buffer_pool.h</a>.</p>

<p class="reference">Referenced by <a class="el" href="buffer__pool_8cpp_source.html#l00015">BufferPool()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00279">DeletePage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00869">FlushAllPages()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00184">FlushPage()</a>, <a class="el" href="buffer__pool_8cpp_source.html#l00652">NewPage()</a>, and <a class="el" href="buffer__pool_8cpp_source.html#l00406">UnpinPage()</a>.</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>include/<a class="el" href="buffer__pool_8h_source.html">buffer_pool.h</a></li>
<li>include/<a class="el" href="buffer__pool__new_8h_source.html">buffer_pool_new.h</a></li>
<li>src/storage_engine/<a class="el" href="buffer__pool_8cpp_source.html">buffer_pool.cpp</a></li>
<li>src/storage_engine/<a class="el" href="buffer__pool__new_8cpp_source.html">buffer_pool_new.cpp</a></li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacesqlcc.html">sqlcc</a></li><li class="navelem"><a class="el" href="classsqlcc_1_1BufferPool.html">BufferPool</a></li>
    <li class="footer">Generated on Wed Nov 26 2025 00:11:12 for SQLCC by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
