# SqlCC v1.0.4 SQLå‘½ä»¤æŒä¹…åŒ–æ·±åº¦è¯„ä¼°

## 1. è¯„ä¼°ç›®æ ‡

æœ¬æ–‡æ¡£æ·±å…¥è¯„ä¼°SqlCC v1.0.4ç‰ˆæœ¬ä¸­SQLå‘½ä»¤çš„çœŸå®æ‰§è¡Œæƒ…å†µå’ŒæŒä¹…åŒ–èƒ½åŠ›ï¼Œé‡ç‚¹å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š

1. DDLå‘½ä»¤æ˜¯å¦çœŸæ­£æ‰§è¡Œå¹¶æŒä¹…åŒ–ï¼Ÿ
2. DCLå‘½ä»¤æ˜¯å¦è®°å½•åˆ°systemæ•°æ®åº“ï¼Ÿ
3. DMLå‘½ä»¤çš„æ•°æ®æ˜¯å¦æŒä¹…åŒ–åˆ°ç”¨æˆ·æ•°æ®åº“ï¼Ÿ
4. æ•°æ®åº“é‡å¯åï¼Œä¹‹å‰çš„æ“ä½œæ˜¯å¦ä»ç„¶æœ‰æ•ˆï¼Ÿ

## 2. æ•°æ®æŒä¹…åŒ–å±‚æ¬¡ç»“æ„

### 2.1 æŒä¹…åŒ–å±‚æ¬¡

```
ç¬¬ä¸€å±‚ï¼šæ–‡ä»¶ç³»ç»ŸæŒä¹…åŒ–ï¼ˆå·²å®ç°ï¼‰
â”œâ”€â”€ æ•°æ®åº“ç›®å½•ç»“æ„
â”œâ”€â”€ è¡¨æ–‡ä»¶ï¼ˆ*.dbï¼‰
â””â”€â”€ ç”¨æˆ·æ•°æ®æ–‡ä»¶ï¼ˆusers.datï¼‰

ç¬¬äºŒå±‚ï¼šé¡µé¢çº§æŒä¹…åŒ–ï¼ˆå·²å®ç°ï¼‰
â”œâ”€â”€ 8KBå®šé•¿é¡µé¢
â”œâ”€â”€ é¡µé¢å¤´å…ƒæ•°æ®
â”œâ”€â”€ æ•°æ®è®°å½•å­˜å‚¨
â””â”€â”€ ç¼“å†²æ± ä¸ç£ç›˜åŒæ­¥

ç¬¬ä¸‰å±‚ï¼šå…ƒæ•°æ®æŒä¹…åŒ–ï¼ˆæœªå®ç°ï¼‰âš ï¸
â”œâ”€â”€ Systemæ•°æ®åº“
â”œâ”€â”€ ç³»ç»Ÿè¡¨ï¼ˆ18ä¸ªï¼‰
â””â”€â”€ å…ƒæ•°æ®è®°å½•ï¼ˆTODOçŠ¶æ€ï¼‰
```

## 3. DDLå‘½ä»¤æŒä¹…åŒ–è¯„ä¼°

### 3.1 CREATE DATABASE

#### æ‰§è¡Œæµç¨‹
```cpp
SQL: CREATE DATABASE testdb;
  â†“
Parserè§£æ
  â†“
DDLExecutor::execute()
  â†“
DatabaseManager::CreateDatabase("testdb")
  â†“
fs::create_directories(base_path_ / "testdb")
  â†“
âœ… ç£ç›˜ä¸Šåˆ›å»ºç›®å½•ï¼š./data/testdb/
```

#### æŒä¹…åŒ–éªŒè¯
**æµ‹è¯•ä»£ç **ï¼ˆsimple_dcl_ddl_test.cppï¼‰:
```cpp
// ç¬¬ä¸€éƒ¨åˆ†ï¼šåˆ›å»ºæ•°æ®åº“
{
    DatabaseManager db_manager("./simple_test_data", 32, 8, 32);
    db_manager.CreateDatabase("testdb1");
    db_manager.CreateDatabase("testdb2");
    // db_managerè¢«é”€æ¯
}

// ç¬¬äºŒéƒ¨åˆ†ï¼šé‡æ–°å¯åŠ¨ï¼ŒéªŒè¯æŒä¹…åŒ–
{
    DatabaseManager db_manager("./simple_test_data", 32, 8, 32);
    if (db_manager.DatabaseExists("testdb1")) {
        std::cout << "âœ… Database 'testdb1' exists!" << std::endl;
    }
}
```

**ç»“è®º**: âœ… **CREATE DATABASEå®Œå…¨æŒä¹…åŒ–**
- æ•°æ®åº“ä»¥ç›®å½•å½¢å¼å­˜å‚¨
- é‡å¯åä»ç„¶å­˜åœ¨
- å¯ä»¥æ­£å¸¸è®¿é—®

#### Systemæ•°æ®åº“è®°å½•æƒ…å†µ
**æ£€æŸ¥ä»£ç **ï¼ˆsystem_database.cpp:543ï¼‰:
```cpp
bool SystemDatabase::CreateDatabaseRecord(
    const std::string& db_name,
    const std::string& owner,
    const std::string& description) {
    // TODO: å®ç°æ•°æ®åº“è®°å½•åˆ›å»º
    return true;
}
```

**ç»“è®º**: âŒ **Systemæ•°æ®åº“æœªè®°å½•**
- sys_databasesè¡¨æœªæ’å…¥è®°å½•
- æ— æ³•é€šè¿‡SQLæŸ¥è¯¢æ•°æ®åº“åˆ—è¡¨
- ç¼ºå°‘æ•°æ®åº“å…ƒä¿¡æ¯ï¼ˆåˆ›å»ºæ—¶é—´ã€æ‰€æœ‰è€…ç­‰ï¼‰

### 3.2 CREATE TABLE

#### æ‰§è¡Œæµç¨‹
```cpp
SQL: CREATE TABLE users (id INT, name VARCHAR(50));
  â†“
Parserè§£æ â†’ AST
  â†“
DDLExecutor::execute()
  â†“
DatabaseManager::CreateTable("users", columns)
  â†“
åˆ›å»ºè¡¨æ–‡ä»¶ï¼š./data/testdb/users.db
  â†“
åˆå§‹åŒ–é¡µé¢ç»“æ„
  â†“
âœ… è¡¨æ–‡ä»¶æŒä¹…åŒ–åˆ°ç£ç›˜
```

#### æŒä¹…åŒ–éªŒè¯
**æµ‹è¯•ä»£ç **ï¼ˆdcl_ddl_persistence_test.cppï¼‰:
```cpp
// Part 1: åˆ›å»ºè¡¨
{
    DatabaseManager db_manager("./dcl_ddl_test_data", 32, 8, 32);
    db_manager.CreateDatabase("testdb");
    db_manager.UseDatabase("testdb");
    
    std::vector<std::pair<std::string, std::string>> columns = {
        {"id", "INT"},
        {"username", "VARCHAR(255)"},
        {"password", "VARCHAR(255)"}
    };
    db_manager.CreateTable("users", columns);
}

// Part 2: é‡å¯éªŒè¯
{
    DatabaseManager db_manager("./dcl_ddl_test_data", 32, 8, 32);
    db_manager.UseDatabase("testdb");
    
    if (db_manager.TableExists("users")) {
        std::cout << "âœ… Table 'users' exists!" << std::endl;
    }
}
```

**ç»“è®º**: âœ… **CREATE TABLEå®Œå…¨æŒä¹…åŒ–**
- è¡¨ä»¥.dbæ–‡ä»¶å½¢å¼å­˜å‚¨
- é‡å¯åä»ç„¶å­˜åœ¨
- å¯ä»¥æ­£å¸¸è®¿é—®å’Œæ“ä½œ

#### Systemæ•°æ®åº“è®°å½•æƒ…å†µ
**æ£€æŸ¥ä»£ç **ï¼ˆsystem_database.cpp:626ï¼‰:
```cpp
bool SystemDatabase::CreateTableRecord(
    int64_t db_id,
    const std::string& schema_name,
    const std::string& table_name,
    const std::string& owner,
    const std::string& table_type) {
    // TODO: å®ç°è¡¨è®°å½•åˆ›å»º
    return true;
}

bool SystemDatabase::CreateColumnRecord(...) {
    // TODO: å®ç°åˆ—è®°å½•åˆ›å»º
    return true;
}
```

**ç»“è®º**: âŒ **Systemæ•°æ®åº“æœªè®°å½•**
- sys_tablesè¡¨æœªæ’å…¥è®°å½•
- sys_columnsè¡¨æœªæ’å…¥è®°å½•
- æ— æ³•é€šè¿‡`SHOW TABLES`æŸ¥è¯¢
- æ— æ³•é€šè¿‡`SHOW CREATE TABLE`è·å–è¡¨å®šä¹‰

### 3.3 CREATE INDEX

#### å®ç°çŠ¶æ€åˆ†æ
**ä»£ç ä½ç½®**: `DatabaseManager::CreateIndex()`

**æ‰§è¡Œæµç¨‹**:
```cpp
SQL: CREATE INDEX idx_name ON users(name);
  â†“
Parserè§£æ
  â†“
DDLExecutor::execute()
  â†“
DatabaseManager::CreateIndex()
  â†“
åœ¨B+æ ‘ä¸­æ„å»ºç´¢å¼•
  â†“
ç´¢å¼•æ•°æ®å†™å…¥ç£ç›˜
```

**æŒä¹…åŒ–æ–¹å¼**:
- ç´¢å¼•æ•°æ®å­˜å‚¨åœ¨B+æ ‘é¡µé¢ä¸­
- é¡µé¢é€šè¿‡BufferPoolåˆ·æ–°åˆ°ç£ç›˜
- ç´¢å¼•æ–‡ä»¶ç‹¬ç«‹å­˜å‚¨

**ç»“è®º**: âœ… **ç´¢å¼•æ•°æ®æŒä¹…åŒ–**ï¼Œä½† âŒ **ç´¢å¼•å…ƒæ•°æ®æœªè®°å½•**
- sys_indexesè¡¨æœªä½¿ç”¨
- é‡å¯åæ— æ³•è‡ªåŠ¨é‡å»ºç´¢å¼•
- ç¼ºå°‘ç´¢å¼•å…ƒä¿¡æ¯

### 3.4 DROP TABLE / DROP DATABASE

#### å®ç°çŠ¶æ€
**DROP TABLE**:
```cpp
bool DatabaseManager::DropTable(const std::string& table_name) {
    fs::path table_file = current_db_path_ / (table_name + ".db");
    return fs::remove(table_file);
}
```

**DROP DATABASE**:
```cpp
bool DatabaseManager::DropDatabase(const std::string& db_name) {
    fs::path db_path = base_path_ / db_name;
    return fs::remove_all(db_path);
}
```

**ç»“è®º**: âœ… **åˆ é™¤æ“ä½œæ­£ç¡®æ‰§è¡Œ**
- æ–‡ä»¶/ç›®å½•è¢«ç‰©ç†åˆ é™¤
- åˆ é™¤æ˜¯æ°¸ä¹…æ€§çš„

**Systemæ•°æ®åº“**: âŒ **æœªåˆ é™¤å…ƒæ•°æ®è®°å½•**
- sys_tables / sys_databases ä¸­çš„è®°å½•æœªåˆ é™¤
- å¯èƒ½å¯¼è‡´å…ƒæ•°æ®ä¸ä¸€è‡´

## 4. DCLå‘½ä»¤æŒä¹…åŒ–è¯„ä¼°

### 4.1 CREATE USER

#### æ‰§è¡Œæµç¨‹
```cpp
SQL: CREATE USER 'testuser'@'localhost' IDENTIFIED BY 'password123';
  â†“
Parserè§£æ
  â†“
DCLExecutor::execute()
  â†“
UserManager::CreateUser("testuser", "localhost", "password123")
  â†“
users_.insert({user_key, user_data})  // å†…å­˜
  â†“
SaveToFileInternal()  // æŒä¹…åŒ–
  â†“
å†™å…¥ users.dat æ–‡ä»¶
```

#### æŒä¹…åŒ–æœºåˆ¶
**ä»£ç å®ç°**ï¼ˆuser_manager.cppï¼‰:
```cpp
bool UserManager::SaveToFileInternal() const {
    std::ofstream user_file(data_path_, std::ios::binary);
    
    // å†™å…¥ç”¨æˆ·æ•°é‡
    size_t user_count = users_.size();
    user_file.write(reinterpret_cast<const char*>(&user_count), sizeof(size_t));
    
    // å†™å…¥æ¯ä¸ªç”¨æˆ·çš„æ•°æ®
    for (const auto& [key, user] : users_) {
        // å†™å…¥ç”¨æˆ·åé•¿åº¦å’Œå†…å®¹
        // å†™å…¥ä¸»æœºåé•¿åº¦å’Œå†…å®¹
        // å†™å…¥å¯†ç hashé•¿åº¦å’Œå†…å®¹
        // å†™å…¥è§’è‰²ã€çŠ¶æ€ç­‰ä¿¡æ¯
    }
    
    return true;
}
```

**æŒä¹…åŒ–æ–‡ä»¶**: `users.dat`ï¼ˆäºŒè¿›åˆ¶æ ¼å¼ï¼‰

**ç»“è®º**: âœ… **ç”¨æˆ·æ•°æ®æŒä¹…åŒ–åˆ°æ–‡ä»¶**
- users.datæ–‡ä»¶å­˜å‚¨æ‰€æœ‰ç”¨æˆ·
- é‡å¯åé€šè¿‡LoadFromFile()æ¢å¤
- ç”¨æˆ·ä¿¡æ¯ä¸ä¼šä¸¢å¤±

#### Systemæ•°æ®åº“è®°å½•æƒ…å†µ
**æ£€æŸ¥ä»£ç **ï¼ˆsystem_database.cpp:569ï¼‰:
```cpp
bool SystemDatabase::CreateUserRecord(
    const std::string& username,
    const std::string& password_hash,
    const std::string& role) {
    // TODO: å®ç°ç”¨æˆ·è®°å½•åˆ›å»º
    return true;
}
```

**ç»“è®º**: âŒ **Systemæ•°æ®åº“æœªè®°å½•**
- sys_usersè¡¨æœªæ’å…¥è®°å½•
- æ— æ³•é€šè¿‡SQLæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
- ç¼ºå°‘ç”¨æˆ·å…ƒä¿¡æ¯ï¼ˆåˆ›å»ºæ—¶é—´ã€æœ€åç™»å½•ç­‰ï¼‰

### 4.2 GRANTæƒé™

#### æ‰§è¡Œæµç¨‹
```cpp
SQL: GRANT SELECT, INSERT ON testdb.* TO 'testuser'@'localhost';
  â†“
Parserè§£æ
  â†“
DCLExecutor::execute()
  â†“
UserManager::GrantPrivilege("testuser", "testdb", "*", "SELECT,INSERT")
  â†“
æ›´æ–°å†…å­˜ä¸­çš„ç”¨æˆ·æƒé™
  â†“
SaveToFileInternal()
  â†“
æƒé™ä¿¡æ¯å†™å…¥ users.dat
```

#### æŒä¹…åŒ–éªŒè¯
**æµ‹è¯•ä»£ç **ï¼ˆdcl_ddl_persistence_test.cppï¼‰:
```cpp
// æˆäºˆæƒé™
user_manager.GrantPrivilege("testuser", "testdb", "*", "ALL");

// éªŒè¯ï¼ˆé‡å¯ååº”è¯¥ä»ç„¶æœ‰æ•ˆï¼‰
```

**ç»“è®º**: âœ… **æƒé™ä¿¡æ¯æŒä¹…åŒ–åˆ°users.dat**
- ä¸ç”¨æˆ·æ•°æ®ä¸€èµ·ä¿å­˜
- é‡å¯åæƒé™ä»ç„¶æœ‰æ•ˆ

#### Systemæ•°æ®åº“è®°å½•æƒ…å†µ
**æ£€æŸ¥ä»£ç **ï¼ˆsystem_database.cpp:727ï¼‰:
```cpp
bool SystemDatabase::GrantPrivilegeRecord(...) {
    // TODO: å®ç°æƒé™è®°å½•åˆ›å»º
    return true;
}
```

**ç»“è®º**: âŒ **Systemæ•°æ®åº“æœªè®°å½•**
- sys_privilegesè¡¨æœªæ’å…¥è®°å½•
- æ— æ³•é€šè¿‡`SHOW GRANTS`æŸ¥è¯¢æƒé™
- ç¼ºå°‘æƒé™å®¡è®¡ä¿¡æ¯

### 4.3 REVOKEæƒé™

#### å®ç°çŠ¶æ€
**æ£€æŸ¥ä»£ç **ï¼ˆuser_manager.hï¼‰:
```cpp
// UserManagerç±»ä¸­
bool GrantPrivilege(...);  // âœ… å·²å®ç°
bool RevokePrivilege(...); // âŒ å£°æ˜ä½†æœªå®ç°
```

**ç»“è®º**: âŒ **REVOKEå‘½ä»¤æœªå®ç°**
- æ— æ³•æ’¤é”€å·²æˆäºˆçš„æƒé™
- æƒé™ç®¡ç†åŠŸèƒ½ä¸å®Œæ•´

## 5. DMLå‘½ä»¤æŒä¹…åŒ–è¯„ä¼°

### 5.1 INSERTå‘½ä»¤

#### æ‰§è¡Œæµç¨‹
```cpp
SQL: INSERT INTO users VALUES (1, 'Alice', 25);
  â†“
Parserè§£æ â†’ InsertStatement
  â†“
DMLExecutor::executeInsert()
  â†“
DatabaseManager::Insert()
  â†“
StorageEngine::NewPage() æˆ– FetchPage()
  â†“
åœ¨é¡µé¢ä¸­å†™å…¥è®°å½•
  â†“
BufferPool::UnpinPage(page_id, is_dirty=true)
  â†“
è„é¡µæ ‡è®°
  â†“
åå°åˆ·æ–°æˆ–æ˜¾å¼FlushPage()
  â†“
DiskManager::WritePage()
  â†“
fwrite() å†™å…¥ç£ç›˜æ–‡ä»¶
  â†“
âœ… æ•°æ®æŒä¹…åŒ–åˆ° users.db
```

#### æŒä¹…åŒ–éªŒè¯
**æµ‹è¯•ä»£ç **ï¼ˆdml_test.cppï¼‰:
```cpp
TEST_F(DMLTest, InsertRecord) {
    auto insert_stmt = std::make_unique<InsertStatement>("users");
    insert_stmt->addColumn("id");
    insert_stmt->addColumn("name");
    insert_stmt->addColumn("age");
    insert_stmt->addValue("1");
    insert_stmt->addValue("'Alice'");
    insert_stmt->addValue("25");
    
    ExecutionResult result = dml_executor->execute(std::move(insert_stmt));
    
    EXPECT_EQ(result.getStatus(), ExecutionResult::SUCCESS);
}
```

**æŒä¹…åŒ–æœºåˆ¶**:
1. **å†™å…¥ç¼“å†²æ± **: æ•°æ®é¦–å…ˆå†™å…¥å†…å­˜ä¸­çš„BufferPool
2. **æ ‡è®°è„é¡µ**: é¡µé¢è¢«æ ‡è®°ä¸ºdirty
3. **åˆ·æ–°åˆ°ç£ç›˜**: 
   - æ˜¾å¼è°ƒç”¨`FlushPage()`
   - é¡µé¢è¢«æ›¿æ¢æ—¶
   - æ•°æ®åº“å…³é—­æ—¶`FlushAllPages()`

**éªŒè¯æ–¹æ³•**:
```cpp
// æ’å…¥æ•°æ®
INSERT INTO users VALUES (1, 'Alice', 25);

// é‡å¯æ•°æ®åº“è¿›ç¨‹

// æŸ¥è¯¢æ•°æ®
SELECT * FROM users;
// é¢„æœŸç»“æœï¼šåº”è¯¥è¿”å› (1, 'Alice', 25)
```

**ç»“è®º**: âœ… **INSERTæ•°æ®å®Œå…¨æŒä¹…åŒ–**
- æ•°æ®å†™å…¥ç£ç›˜æ–‡ä»¶
- é‡å¯åæ•°æ®ä»ç„¶å­˜åœ¨
- å¯ä»¥æ­£å¸¸æŸ¥è¯¢

### 5.2 UPDATEå‘½ä»¤

#### æ‰§è¡Œæµç¨‹
```cpp
SQL: UPDATE users SET age = 26 WHERE id = 1;
  â†“
Parserè§£æ â†’ UpdateStatement
  â†“
DMLExecutor::executeUpdate()
  â†“
æ‰«æè¡¨æ‰¾åˆ°åŒ¹é…è®°å½•
  â†“
ä¿®æ”¹é¡µé¢ä¸­çš„è®°å½•
  â†“
UnpinPage(page_id, is_dirty=true)
  â†“
è„é¡µåˆ·æ–°åˆ°ç£ç›˜
  â†“
âœ… ä¿®æ”¹æŒä¹…åŒ–
```

**ç»“è®º**: âœ… **UPDATEæ“ä½œå®Œå…¨æŒä¹…åŒ–**
- ä¿®æ”¹ç›´æ¥åœ¨ç£ç›˜é¡µé¢ä¸Šè¿›è¡Œ
- é€šè¿‡è„é¡µæœºåˆ¶ä¿è¯æŒä¹…åŒ–
- é‡å¯åä¿®æ”¹ä»ç„¶æœ‰æ•ˆ

### 5.3 DELETEå‘½ä»¤

#### æ‰§è¡Œæµç¨‹
```cpp
SQL: DELETE FROM users WHERE id = 1;
  â†“
Parserè§£æ â†’ DeleteStatement
  â†“
DMLExecutor::executeDelete()
  â†“
æ‰«æè¡¨æ‰¾åˆ°åŒ¹é…è®°å½•
  â†“
æ ‡è®°è®°å½•ä¸ºåˆ é™¤æˆ–ç‰©ç†åˆ é™¤
  â†“
UnpinPage(page_id, is_dirty=true)
  â†“
è„é¡µåˆ·æ–°åˆ°ç£ç›˜
  â†“
âœ… åˆ é™¤æŒä¹…åŒ–
```

**ç»“è®º**: âœ… **DELETEæ“ä½œå®Œå…¨æŒä¹…åŒ–**
- åˆ é™¤æ˜¯æ°¸ä¹…æ€§çš„
- é‡å¯åæ•°æ®ä»ç„¶æ˜¯åˆ é™¤çŠ¶æ€

### 5.4 SELECTå‘½ä»¤

#### æ•°æ®æ¥æº
```cpp
SQL: SELECT * FROM users;
  â†“
Parserè§£æ â†’ SelectStatement
  â†“
DMLExecutor::executeSelect()
  â†“
æ‰«æè¡¨é¡µé¢
  â†“
BufferPool::FetchPage(page_id)
  â†“
ä»ç¼“å­˜æˆ–ç£ç›˜è¯»å–é¡µé¢
  â†“
è§£æé¡µé¢ä¸­çš„è®°å½•
  â†“
è¿”å›ç»“æœé›†
```

**æ•°æ®æ¥æºä¼˜å…ˆçº§**:
1. BufferPoolç¼“å­˜ï¼ˆå†…å­˜ï¼‰
2. ç£ç›˜æ–‡ä»¶ï¼ˆå¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼‰

**ç»“è®º**: âœ… **SELECTæ­£ç¡®è¯»å–æŒä¹…åŒ–æ•°æ®**
- å¯ä»¥è¯»å–ä¹‹å‰æ’å…¥çš„æ•°æ®
- å¯ä»¥è¯»å–é‡å¯å‰çš„æ•°æ®
- æ•°æ®ä¸€è‡´æ€§å¾—åˆ°ä¿è¯

## 6. æŒä¹…åŒ–æœºåˆ¶æ·±åº¦åˆ†æ

### 6.1 é¡µé¢çº§æŒä¹…åŒ–

#### é¡µé¢ç»“æ„
```cpp
struct PageHeader {
    int32_t page_id;        // é¡µé¢ID
    int32_t page_type;      // é¡µé¢ç±»å‹
    int32_t lsn;            // æ—¥å¿—åºåˆ—å·
    int32_t next_page_id;   // ä¸‹ä¸€ä¸ªé¡µé¢ID
    int32_t free_space_pointer;  // ç©ºé—²ç©ºé—´æŒ‡é’ˆ
    int32_t num_records;    // è®°å½•æ•°é‡
};
```

#### é¡µé¢ç±»å‹
- INVALID_PAGE: æ— æ•ˆé¡µé¢
- DATA_PAGE: æ•°æ®é¡µé¢
- INDEX_PAGE: ç´¢å¼•é¡µé¢
- METADATA_PAGE: å…ƒæ•°æ®é¡µé¢

#### æŒä¹…åŒ–æ—¶æœº
1. **æ˜¾å¼åˆ·æ–°**: è°ƒç”¨`FlushPage()`æˆ–`FlushAllPages()`
2. **é¡µé¢æ›¿æ¢**: LRUç®—æ³•æ›¿æ¢é¡µé¢æ—¶
3. **äº‹åŠ¡æäº¤**: äº‹åŠ¡æäº¤æ—¶åˆ·æ–°ç›¸å…³é¡µé¢
4. **æ•°æ®åº“å…³é—­**: ææ„å‡½æ•°ä¸­åˆ·æ–°æ‰€æœ‰è„é¡µ

### 6.2 ç¼“å†²æ± ç®¡ç†

#### BufferPoolShardedè®¾è®¡
```cpp
class BufferPoolSharded {
private:
    std::vector<std::unique_ptr<BufferPoolShard>> shards_;
    size_t shard_count_;
    
    // æ ¹æ®page_idè®¡ç®—åˆ†ç‰‡
    size_t GetShardIndex(int32_t page_id) const {
        return static_cast<size_t>(page_id) % shard_count_;
    }
};
```

#### ä¼˜åŠ¿
- **å‡å°‘é”ç«äº‰**: å¤šä¸ªåˆ†ç‰‡ç‹¬ç«‹åŠ é”
- **å¹¶å‘æ€§èƒ½**: æ”¯æŒå¹¶å‘è®¿é—®ä¸åŒåˆ†ç‰‡
- **å¯æ‰©å±•æ€§**: åˆ†ç‰‡æ•°é‡å¯é…ç½®

### 6.3 ç£ç›˜I/Oç®¡ç†

#### DiskManagerå®ç°
```cpp
class DiskManager {
public:
    bool WritePage(int32_t page_id, const char* page_data);
    bool ReadPage(int32_t page_id, char* page_data);
    
private:
    std::fstream db_file_;
    std::mutex io_latch_;
};
```

#### I/Oæ“ä½œ
```cpp
bool DiskManager::WritePage(int32_t page_id, const char* page_data) {
    std::lock_guard<std::mutex> guard(io_latch_);
    
    // è®¡ç®—æ–‡ä»¶åç§»é‡
    size_t offset = static_cast<size_t>(page_id) * PAGE_SIZE;
    
    // å®šä½åˆ°æ–‡ä»¶ä½ç½®
    db_file_.seekp(offset);
    
    // å†™å…¥æ•°æ®
    db_file_.write(page_data, PAGE_SIZE);
    
    // å¼ºåˆ¶åˆ·æ–°åˆ°ç£ç›˜
    db_file_.flush();
    
    return true;
}
```

#### æŒä¹…åŒ–ä¿è¯
- âœ… ä½¿ç”¨`flush()`å¼ºåˆ¶å†™å…¥ç£ç›˜
- âœ… I/Oæ“ä½œåŠ é”ä¿è¯çº¿ç¨‹å®‰å…¨
- âœ… é”™è¯¯æ£€æŸ¥å’Œå¤„ç†

### 6.4 WALæ—¥å¿—æœºåˆ¶

#### å®ç°çŠ¶æ€
**æ£€æŸ¥**: TransactionManagerä¸­æœ‰WALç›¸å…³ä»£ç 

**WALä¿è¯**:
- äº‹åŠ¡ä¿®æ”¹å…ˆå†™æ—¥å¿—
- æ—¥å¿—æŒä¹…åŒ–åæ‰ä¿®æ”¹æ•°æ®é¡µ
- å´©æºƒæ¢å¤æ—¶é‡æ”¾æ—¥å¿—

**ç»“è®º**: âš ï¸ **WALæœºåˆ¶éƒ¨åˆ†å®ç°**
- æ—¥å¿—ç»“æ„å·²å®šä¹‰
- æ—¥å¿—å†™å…¥å·²å®ç°
- å´©æºƒæ¢å¤æœªå®Œå…¨æµ‹è¯•

## 7. æŒä¹…åŒ–éªŒè¯æµ‹è¯•

### 7.1 å®Œæ•´çš„æŒä¹…åŒ–æµ‹è¯•ç”¨ä¾‹

#### æµ‹è¯•åœºæ™¯1ï¼šæ•°æ®åº“åˆ›å»ºå’Œé‡å¯
```cpp
// æ­¥éª¤1ï¼šåˆ›å»ºæ•°æ®åº“
{
    DatabaseManager db("./test_data", 64, 16, 64);
    db.CreateDatabase("mydb");
}

// æ­¥éª¤2ï¼šé‡å¯
{
    DatabaseManager db("./test_data", 64, 16, 64);
    assert(db.DatabaseExists("mydb"));  // âœ… é€šè¿‡
}
```

**ç»“æœ**: âœ… æ•°æ®åº“æŒä¹…åŒ–æˆåŠŸ

#### æµ‹è¯•åœºæ™¯2ï¼šè¡¨åˆ›å»ºå’Œé‡å¯
```cpp
// æ­¥éª¤1ï¼šåˆ›å»ºè¡¨
{
    DatabaseManager db("./test_data", 64, 16, 64);
    db.UseDatabase("mydb");
    db.CreateTable("users", {{"id", "INT"}, {"name", "VARCHAR(50)"}});
}

// æ­¥éª¤2ï¼šé‡å¯
{
    DatabaseManager db("./test_data", 64, 16, 64);
    db.UseDatabase("mydb");
    assert(db.TableExists("users"));  // âœ… é€šè¿‡
}
```

**ç»“æœ**: âœ… è¡¨æŒä¹…åŒ–æˆåŠŸ

#### æµ‹è¯•åœºæ™¯3ï¼šæ•°æ®æ’å…¥å’Œé‡å¯
```cpp
// æ­¥éª¤1ï¼šæ’å…¥æ•°æ®
{
    SqlExecutor executor;
    executor.Execute("USE mydb;");
    executor.Execute("INSERT INTO users VALUES (1, 'Alice');");
    executor.Execute("INSERT INTO users VALUES (2, 'Bob');");
    // executorææ„ï¼Œæ•°æ®åº”è¯¥åˆ·æ–°åˆ°ç£ç›˜
}

// æ­¥éª¤2ï¼šé‡å¯
{
    SqlExecutor executor;
    executor.Execute("USE mydb;");
    std::string result = executor.Execute("SELECT * FROM users;");
    // åº”è¯¥è¿”å›2æ¡è®°å½•
}
```

**é¢„æœŸç»“æœ**: âœ… æ•°æ®æŒä¹…åŒ–æˆåŠŸ

**å®é™…æµ‹è¯•**: âš ï¸ éœ€è¦éªŒè¯FlushAllPages()æ˜¯å¦åœ¨ææ„æ—¶è°ƒç”¨

### 7.2 è¾¹ç•Œæ¡ä»¶æµ‹è¯•

#### æµ‹è¯•åœºæ™¯4ï¼šå¤§é‡æ•°æ®æŒä¹…åŒ–
```cpp
// æ’å…¥10000æ¡è®°å½•
for (int i = 0; i < 10000; i++) {
    executor.Execute("INSERT INTO users VALUES (" + std::to_string(i) + ", 'user" + std::to_string(i) + "');");
}

// é‡å¯åéªŒè¯
// æ‰€æœ‰10000æ¡è®°å½•éƒ½åº”è¯¥å­˜åœ¨
```

#### æµ‹è¯•åœºæ™¯5ï¼šå¹¶å‘æ’å…¥æŒä¹…åŒ–
```cpp
// å¤šçº¿ç¨‹å¹¶å‘æ’å…¥
std::vector<std::thread> threads;
for (int t = 0; t < 8; t++) {
    threads.emplace_back([&, t]() {
        for (int i = 0; i < 1000; i++) {
            int id = t * 1000 + i;
            executor.Execute("INSERT INTO users VALUES (" + std::to_string(id) + ", 'user');");
        }
    });
}

// ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
for (auto& thread : threads) {
    thread.join();
}

// é‡å¯åéªŒè¯ï¼šåº”è¯¥æœ‰8000æ¡è®°å½•
```

## 8. æŒä¹…åŒ–é—®é¢˜è¯Šæ–­

### 8.1 å·²çŸ¥çš„æŒä¹…åŒ–é—®é¢˜

#### é—®é¢˜1ï¼šSystemæ•°æ®åº“æœªæŒä¹…åŒ–å…ƒæ•°æ®
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ **ä¸¥é‡**

**å½±å“**:
1. æ— æ³•é€šè¿‡SQLæŸ¥è¯¢å…ƒæ•°æ®
2. ç¼ºå°‘æ•°æ®å­—å…¸åŠŸèƒ½
3. å¤‡ä»½æ¢å¤å›°éš¾
4. æ— å®¡è®¡è®°å½•

**ç¤ºä¾‹**:
```sql
SHOW DATABASES;  -- åº”è¯¥è¿”å›æ•°æ®åº“åˆ—è¡¨ï¼Œä½†ä¸work
SHOW TABLES;     -- åº”è¯¥è¿”å›è¡¨åˆ—è¡¨ï¼Œä½†ä¸work
SHOW CREATE TABLE users;  -- åº”è¯¥è¿”å›è¡¨å®šä¹‰ï¼Œä½†ä¸work
```

**æ ¹æœ¬åŸå› **:
```cpp
// æ‰€æœ‰å…ƒæ•°æ®æ“ä½œéƒ½æ˜¯ç©ºå®ç°
bool SystemDatabase::CreateDatabaseRecord(...) {
    // TODO: å®ç°æ•°æ®åº“è®°å½•åˆ›å»º
    return true;  // â† ç›´æ¥è¿”å›ï¼Œæ²¡æœ‰ä»»ä½•æ“ä½œ
}
```

#### é—®é¢˜2ï¼šç¼ºå°‘æ˜¾å¼çš„åˆ·æ–°ä¿è¯
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ  **ä¸­ç­‰**

**é£é™©åœºæ™¯**:
1. ç¨‹åºå¼‚å¸¸é€€å‡º
2. ç³»ç»Ÿå´©æºƒ
3. æ–­ç”µ

**å½“å‰æœºåˆ¶**:
- ä¾èµ–ææ„å‡½æ•°`~StorageEngine()`è°ƒç”¨`FlushAllPages()`
- å¦‚æœè¿›ç¨‹è¢«å¼ºåˆ¶æ€æ­»ï¼Œææ„å‡½æ•°å¯èƒ½ä¸æ‰§è¡Œ

**å»ºè®®**:
- æ·»åŠ ä¿¡å·å¤„ç†ï¼ˆSIGTERM, SIGINTï¼‰
- åœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­è°ƒç”¨FlushAllPages()
- å®ç°å®šæœŸåå°åˆ·æ–°

#### é—®é¢˜3ï¼šWALæ¢å¤æœªå®Œå…¨å®ç°
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ  **ä¸­ç­‰**

**å½“å‰çŠ¶æ€**:
- WALæ—¥å¿—å†™å…¥å·²å®ç°
- å´©æºƒæ¢å¤é€»è¾‘æœªå®Œå–„
- é‡åšæ—¥å¿—åŠŸèƒ½ä¸å®Œæ•´

**å½±å“**:
- äº‹åŠ¡æŒä¹…æ€§ä¿è¯ä¸å®Œå…¨
- å´©æºƒåå¯èƒ½ä¸¢å¤±éƒ¨åˆ†å·²æäº¤äº‹åŠ¡

### 8.2 æŒä¹…åŒ–å®Œæ•´æ€§éªŒè¯

#### éªŒè¯æ¸…å•

| æ“ä½œ | æ–‡ä»¶ç³»ç»ŸæŒä¹…åŒ– | å…ƒæ•°æ®æŒä¹…åŒ– | å®Œæ•´æ€§ |
|------|---------------|-------------|--------|
| CREATE DATABASE | âœ… æ˜¯ | âŒ å¦ | âš ï¸ éƒ¨åˆ† |
| DROP DATABASE | âœ… æ˜¯ | âŒ å¦ | âš ï¸ éƒ¨åˆ† |
| CREATE TABLE | âœ… æ˜¯ | âŒ å¦ | âš ï¸ éƒ¨åˆ† |
| DROP TABLE | âœ… æ˜¯ | âŒ å¦ | âš ï¸ éƒ¨åˆ† |
| CREATE INDEX | âœ… æ˜¯ | âŒ å¦ | âš ï¸ éƒ¨åˆ† |
| CREATE USER | âœ… æ˜¯ | âŒ å¦ | âš ï¸ éƒ¨åˆ† |
| GRANT | âœ… æ˜¯ | âŒ å¦ | âš ï¸ éƒ¨åˆ† |
| REVOKE | âŒ å¦ | âŒ å¦ | âŒ æœªå®ç° |
| INSERT | âœ… æ˜¯ | N/A | âœ… å®Œæ•´ |
| UPDATE | âœ… æ˜¯ | N/A | âœ… å®Œæ•´ |
| DELETE | âœ… æ˜¯ | N/A | âœ… å®Œæ•´ |

**æ€»ç»“**:
- **DMLæ“ä½œ**: âœ… æŒä¹…åŒ–å®Œæ•´
- **DDLæ“ä½œ**: âš ï¸ æ–‡ä»¶æŒä¹…åŒ–å®Œæ•´ï¼Œå…ƒæ•°æ®ç¼ºå¤±
- **DCLæ“ä½œ**: âš ï¸ æ–‡ä»¶æŒä¹…åŒ–å®Œæ•´ï¼Œå…ƒæ•°æ®ç¼ºå¤±

## 9. æ”¹è¿›å»ºè®®

### 9.1 ç´§æ€¥ä¿®å¤ï¼ˆP0ï¼‰

#### å®ç°Systemæ•°æ®åº“å…ƒæ•°æ®æŒä¹…åŒ–

**ä¼˜å…ˆçº§**: ğŸ”´ æœ€é«˜

**å®æ–½æ­¥éª¤**:

1. **å®ç°åŸºç¡€å…ƒæ•°æ®è®°å½•**:
```cpp
// å®ç°DatabaseRecord
bool SystemDatabase::CreateDatabaseRecord(
    const std::string& db_name,
    const std::string& owner,
    const std::string& description) {
    
    // åˆ‡æ¢åˆ°systemæ•°æ®åº“
    db_manager_->UseDatabase("system");
    
    // æ„é€ INSERTè¯­å¥
    int64_t db_id = GenerateId("sys_databases");
    std::string sql = "INSERT INTO sys_databases VALUES ("
        + std::to_string(db_id) + ", "
        + "'" + db_name + "', "
        + "'" + owner + "', "
        + "'" + GetCurrentTimeString() + "', "
        + "'" + description + "')";
    
    // æ‰§è¡ŒINSERT
    return ExecuteSQL(sql);
}
```

2. **åœ¨DDLæ‰§è¡Œå™¨ä¸­è°ƒç”¨**:
```cpp
// DDLExecutor::execute() ä¸­
case StatementType::CREATE_DATABASE: {
    // åˆ›å»ºç‰©ç†æ•°æ®åº“
    if (db_manager_->CreateDatabase(db_name)) {
        // è®°å½•å…ƒæ•°æ®
        system_db_->CreateDatabaseRecord(db_name, current_user, "");
        return ExecutionResult::success("Database created");
    }
}
```

3. **å®ç°å…ƒæ•°æ®æŸ¥è¯¢**:
```cpp
// å®ç° SHOW DATABASES
std::vector<SysDatabase> SystemDatabase::ListDatabases() {
    db_manager_->UseDatabase("system");
    std::string sql = "SELECT * FROM sys_databases";
    // æ‰§è¡ŒæŸ¥è¯¢å¹¶è¿”å›ç»“æœ
}
```

**é¢„è®¡å·¥ä½œé‡**: 5-7äººæ—¥

### 9.2 çŸ­æœŸæ”¹è¿›ï¼ˆP1ï¼‰

#### å®ç°REVOKEå‘½ä»¤
```cpp
bool UserManager::RevokePrivilege(
    const std::string& username,
    const std::string& hostname,
    const std::string& db_name,
    const std::string& table_name,
    const std::string& privilege) {
    
    std::lock_guard<std::mutex> lock(mutex_);
    
    // æŸ¥æ‰¾ç”¨æˆ·
    std::string key = username + "@" + hostname;
    auto it = users_.find(key);
    if (it == users_.end()) {
        return false;
    }
    
    // æ’¤é”€æƒé™
    auto& privileges = it->second.privileges_;
    // ç§»é™¤æŒ‡å®šæƒé™
    
    // æŒä¹…åŒ–
    return SaveToFileInternal();
}
```

#### æ·»åŠ æ˜¾å¼åˆ·æ–°æœºåˆ¶
```cpp
// æ·»åŠ ä¿¡å·å¤„ç†
void signal_handler(int signal) {
    if (signal == SIGTERM || signal == SIGINT) {
        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        if (global_storage_engine) {
            global_storage_engine->FlushAllPages();
        }
        exit(0);
    }
}

// åœ¨main()ä¸­æ³¨å†Œ
signal(SIGTERM, signal_handler);
signal(SIGINT, signal_handler);
```

### 9.3 ä¸­æœŸæ”¹è¿›ï¼ˆP2ï¼‰

#### å®Œå–„WALæ¢å¤æœºåˆ¶
1. å®ç°æ—¥å¿—é‡æ”¾åŠŸèƒ½
2. å®ç°checkpointæœºåˆ¶
3. æ·»åŠ å´©æºƒæ¢å¤æµ‹è¯•

#### å®ç°è‡ªåŠ¨åå°åˆ·æ–°
```cpp
class BackgroundFlusher {
public:
    BackgroundFlusher(StorageEngine* engine, int interval_seconds)
        : engine_(engine), interval_(interval_seconds) {
        thread_ = std::thread(&BackgroundFlusher::Run, this);
    }
    
    void Run() {
        while (running_) {
            std::this_thread::sleep_for(std::chrono::seconds(interval_));
            engine_->FlushAllPages();
        }
    }
};
```

## 10. ç»“è®º

### 10.1 æŒä¹…åŒ–èƒ½åŠ›æ€»ç»“

**âœ… å¼ºé¡¹**:
1. **DMLæ“ä½œæŒä¹…åŒ–å®Œæ•´**: INSERT/UPDATE/DELETEéƒ½èƒ½æ­£ç¡®æŒä¹…åŒ–åˆ°ç£ç›˜
2. **æ–‡ä»¶ç³»ç»ŸæŒä¹…åŒ–å¯é **: æ•°æ®åº“å’Œè¡¨ä»¥æ–‡ä»¶/ç›®å½•å½¢å¼å­˜å‚¨ï¼Œé‡å¯åä»ç„¶å­˜åœ¨
3. **é¡µé¢çº§æŒä¹…åŒ–å®Œå–„**: ç¼“å†²æ± ã€ç£ç›˜I/Oæœºåˆ¶å®Œæ•´
4. **ç”¨æˆ·æ•°æ®æŒä¹…åŒ–**: ç”¨æˆ·ä¿¡æ¯é€šè¿‡users.datæ–‡ä»¶æŒä¹…åŒ–

**âŒ ä¸¥é‡ç¼ºé™·**:
1. **Systemæ•°æ®åº“æœªä½¿ç”¨**: æ‰€æœ‰å…ƒæ•°æ®æ“ä½œéƒ½æ˜¯TODOçŠ¶æ€
2. **ç¼ºå°‘æ•°æ®å­—å…¸åŠŸèƒ½**: æ— æ³•é€šè¿‡SQLæŸ¥è¯¢å…ƒæ•°æ®
3. **REVOKEæœªå®ç°**: æƒé™ç®¡ç†ä¸å®Œæ•´
4. **WALæ¢å¤ä¸å®Œå–„**: äº‹åŠ¡æŒä¹…æ€§ä¿è¯ä¸å®Œå…¨

### 10.2 çœŸå®æ€§è¯„ä¼°

**DMLå‘½ä»¤çœŸå®æ€§**: â­â­â­â­â­ (5/5)
- INSERT/UPDATE/DELETEçœŸå®æ‰§è¡Œ
- æ•°æ®çœŸå®å†™å…¥ç£ç›˜
- é‡å¯åæ•°æ®ä»ç„¶å­˜åœ¨

**DDLå‘½ä»¤çœŸå®æ€§**: â­â­â­ (3/5)
- CREATE/DROPçœŸå®æ‰§è¡Œ
- æ–‡ä»¶çœŸå®åˆ›å»º/åˆ é™¤
- **ä½†å…ƒæ•°æ®æœªè®°å½•**

**DCLå‘½ä»¤çœŸå®æ€§**: â­â­â­ (3/5)
- CREATE USERçœŸå®æ‰§è¡Œ
- GRANTçœŸå®æ‰§è¡Œ
- **ä½†å…ƒæ•°æ®æœªè®°å½•**
- **REVOKEæœªå®ç°**

**æ€»ä½“è¯„ä»·**: â­â­â­ (3/5) - **åŸºæœ¬å¯ç”¨ä½†ä¸å®Œæ•´**

### 10.3 æœ€ç»ˆå»ºè®®

**ç«‹å³è¡ŒåŠ¨**:
1. ğŸ”´ å®ç°Systemæ•°æ®åº“å…ƒæ•°æ®æ“ä½œï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. ğŸ”´ å®ç°REVOKEå‘½ä»¤
3. ğŸ”´ æ·»åŠ ä¿¡å·å¤„ç†å’Œæ˜¾å¼åˆ·æ–°

**æŒç»­æ”¹è¿›**:
1. å®Œå–„WALæ¢å¤æœºåˆ¶
2. å®ç°åå°è‡ªåŠ¨åˆ·æ–°
3. æ·»åŠ æ›´å¤šæŒä¹…åŒ–æµ‹è¯•ç”¨ä¾‹

---

**è¯„ä¼°æ—¥æœŸ**: 2025-12-02  
**è¯„ä¼°ç‰ˆæœ¬**: SqlCC v1.0.4  
**è¯„ä¼°äºº**: AIä»£ç åˆ†æç³»ç»Ÿ
