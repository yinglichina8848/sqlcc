# SQLCC数据库管理系统 - 部署和配置指南

## 1. 系统概述

### 1.1 部署架构

SQLCC采用客户端-服务器架构，部署时需要考虑以下组件：

1. **SQLCC服务器** - 核心数据库服务，负责处理客户端请求
2. **客户端工具** - 用于连接和管理数据库的命令行工具
3. **配置文件** - 用于配置服务器参数
4. **日志文件** - 记录系统运行情况和错误信息
5. **数据文件** - 存储数据库实际数据

### 1.2 部署模式

SQLCC支持以下部署模式：

- **单机部署** - 适用于开发、测试和小规模生产环境
- **集群部署** - 适用于大规模生产环境，提供高可用性和负载均衡

## 2. 环境准备

### 2.1 硬件要求

| 部署规模 | CPU | 内存 | 磁盘空间 | 网络 |
|----------|-----|------|----------|------|
| 开发环境 | 2核 | 2GB | 100GB | 1Gbps |
| 测试环境 | 4核 | 4GB | 500GB | 1Gbps |
| 生产环境 | 8核+ | 16GB+ | 1TB+ | 10Gbps+ |

### 2.2 软件要求

| 软件 | 版本要求 | 用途 |
|------|----------|------|
| 操作系统 | Linux (Ubuntu 18.04+, CentOS 7+), macOS 10.15+, Windows 10+ | 运行SQLCC |
| 编译器 | GCC 7+, Clang 5+, MSVC 2017+ | 编译SQLCC |
| CMake | 3.10+ | 构建系统 |
| Git | 2.0+ | 版本控制 |
| Doxygen | 1.8+ | 生成API文档 |

### 2.3 网络要求

- 服务器端口：默认3306，需要开放给客户端访问
- 防火墙：需要允许客户端访问服务器端口
- 网络延迟：生产环境建议网络延迟低于1ms

## 3. 编译安装

### 3.1 源码编译

1. **克隆代码仓库**

```bash
git clone https://github.com/yourusername/sqlcc.git
cd sqlcc
```

2. **创建构建目录**

```bash
mkdir build
cd build
```

3. **配置CMake**

```bash
# 基本配置
cmake ..

# 带调试信息的配置
cmake .. -DCMAKE_BUILD_TYPE=Debug

# 带优化的发布配置
cmake .. -DCMAKE_BUILD_TYPE=Release
```

4. **编译**

```bash
# 使用4个线程编译
make -j4
```

5. **安装**

```bash
sudo make install
```

### 3.2 安装验证

```bash
# 检查SQLCC版本
sqlcc-server --version

# 检查客户端版本
sqlcc-client --version
```

## 4. 配置文件

### 4.1 配置文件结构

SQLCC的配置文件采用INI格式，主要包含以下部分：

- **[server]** - 服务器基本配置
- **[storage]** - 存储引擎配置
- **[transaction]** - 事务管理器配置
- **[network]** - 网络模块配置
- **[logging]** - 日志配置
- **[performance]** - 性能相关配置

### 4.2 核心配置参数

#### 4.2.1 服务器配置

```ini
[server]
# 服务器端口
port = 3306

# 最大连接数
max_connections = 100

# 工作线程数
worker_threads = 4

# 服务器运行模式：development, testing, production
mode = development
```

#### 4.2.2 存储引擎配置

```ini
[storage]
# 数据目录
data_dir = data/

# 页面大小（字节）
page_size = 4096

# 缓冲池大小（页面数）
buffer_pool_size = 1000

# B+树阶数
btree_order = 50

# 日志文件大小（MB）
log_file_size = 100

# 日志文件数量
log_file_count = 10
```

#### 4.2.3 事务管理器配置

```ini
[transaction]
# 默认事务隔离级别：READ_UNCOMMITTED, READ_COMMITTED, REPEATABLE_READ, SERIALIZABLE
default_isolation_level = REPEATABLE_READ

# 死锁检测间隔（毫秒）
deadlock_detection_interval = 1000

# 事务超时时间（秒）
transaction_timeout = 30
```

#### 4.2.4 网络配置

```ini
[network]
# 监听地址：0.0.0.0表示监听所有地址
listen_address = 0.0.0.0

# 连接超时时间（秒）
connect_timeout = 10

# 读取超时时间（秒）
read_timeout = 30

# 写入超时时间（秒）
write_timeout = 30
```

#### 4.2.5 日志配置

```ini
[logging]
# 日志级别：DEBUG, INFO, WARN, ERROR, FATAL
log_level = INFO

# 日志文件目录
log_dir = logs/

# 日志文件大小（MB）
log_file_size = 100

# 日志文件数量
log_file_count = 10

# 是否输出到控制台
console_output = YES
```

#### 4.2.6 性能配置

```ini
[performance]
# 是否启用性能监控
enable_performance_monitor = YES

# 性能数据收集间隔（秒）
performance_monitor_interval = 60

# 性能数据保存时间（小时）
performance_data_retention = 24
```

### 4.3 配置文件位置

- 默认配置文件：`config.ini`（位于当前工作目录）
- 自定义配置文件：可以通过`--config`参数指定

## 5. 服务器部署

### 5.1 单机部署

1. **创建数据目录**

```bash
mkdir -p data logs
```

2. **创建配置文件**

```bash
# 复制示例配置文件
cp config.ini.example config.ini

# 编辑配置文件
nano config.ini
```

3. **启动服务器**

```bash
# 前台启动（用于测试）
sqlcc-server --config config.ini

# 后台启动（用于生产环境）
sqlcc-server --config config.ini --daemon
```

4. **验证服务器运行状态**

```bash
# 检查进程是否运行
ps aux | grep sqlcc-server

# 检查日志文件
tail -f logs/sqlcc.log

# 使用客户端连接
sqlcc-client --host localhost --port 3306
```

### 5.2 集群部署

SQLCC的集群部署需要考虑以下组件：

1. **主节点** - 处理写请求，负责数据同步
2. **从节点** - 处理读请求，从主节点同步数据
3. **负载均衡器** - 分发客户端请求到不同节点
4. **监控系统** - 监控集群状态和性能

#### 5.2.1 主节点配置

```ini
[server]
mode = production

[storage]
# 启用二进制日志
enable_binlog = YES

# 二进制日志格式：ROW, STATEMENT, MIXED
binlog_format = ROW

# 二进制日志目录
binlog_dir = binlog/
```

#### 5.2.2 从节点配置

```ini
[server]
mode = production

[replication]
# 启用复制
enable_replication = YES

# 主节点地址
master_host = 192.168.1.100

# 主节点端口
master_port = 3306

# 复制用户
replication_user = repl

# 复制密码
replication_password = repl_password

# 复制延迟阈值（秒）
replication_delay_threshold = 30
```

#### 5.2.3 启动集群

1. **启动主节点**

```bash
sqlcc-server --config master_config.ini --daemon
```

2. **启动从节点**

```bash
sqlcc-server --config slave_config.ini --daemon
```

3. **配置负载均衡器**

以Nginx为例：

```nginx
upstream sqlcc_cluster {
    server 192.168.1.100:3306 weight=1;
    server 192.168.1.101:3306 weight=1;
    server 192.168.1.102:3306 weight=1;
}

server {
    listen 3306;
    proxy_pass sqlcc_cluster;
    proxy_connect_timeout 10s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
}
```

## 6. 客户端部署

### 6.1 命令行客户端

#### 6.1.1 安装客户端

客户端工具会在安装服务器时自动安装，也可以单独安装：

```bash
# 单独安装客户端
sudo make install-client
```

#### 6.1.2 连接服务器

```bash
# 基本连接
sqlcc-client --host localhost --port 3306 --user root --password

# 连接指定数据库
sqlcc-client --host localhost --port 3306 --user root --password --database test_db

# 使用配置文件连接
sqlcc-client --config client_config.ini
```

#### 6.1.3 客户端配置文件

```ini
[client]
# 服务器地址
host = localhost

# 服务器端口
port = 3306

# 用户名
user = root

# 密码（不建议明文存储）
password = your_password

# 默认数据库
database = test_db

# 连接超时时间（秒）
connect_timeout = 10
```

### 6.2 编程接口

SQLCC提供了C++编程接口，便于开发者集成到自己的应用程序中。

#### 6.2.1 安装开发库

```bash
sudo make install-dev
```

#### 6.2.2 示例代码

```cpp
#include "client/client.h"

int main() {
    // 创建客户端
    Client client;
    
    // 连接到服务器
    if (client.connect("localhost", 3306, "root", "password", "test_db")) {
        // 执行SQL语句
        ResultSet result = client.execute("SELECT * FROM users");
        
        // 处理结果
        while (result.next()) {
            int id = result.getInt("id");
            std::string name = result.getString("name");
            std::cout << "id: " << id << ", name: " << name << std::endl;
        }
        
        // 关闭连接
        client.disconnect();
    }
    
    return 0;
}
```

## 7. 安全配置

### 7.1 访问控制

#### 7.1.1 用户管理

```sql
-- 创建用户
CREATE USER 'admin'@'localhost' IDENTIFIED BY 'strong_password';

-- 授权
GRANT ALL PRIVILEGES ON *.* TO 'admin'@'localhost' WITH GRANT OPTION;

-- 撤销授权
REVOKE ALL PRIVILEGES ON *.* FROM 'admin'@'localhost';

-- 删除用户
DROP USER 'admin'@'localhost';
```

#### 7.1.2 主机访问控制

```sql
-- 允许特定IP访问
CREATE USER 'user'@'192.168.1.100' IDENTIFIED BY 'password';
GRANT SELECT, INSERT, UPDATE, DELETE ON test_db.* TO 'user'@'192.168.1.100';

-- 允许所有IP访问
CREATE USER 'user'@'%' IDENTIFIED BY 'password';
GRANT SELECT ON test_db.* TO 'user'@'%';
```

### 7.2 加密传输

SQLCC支持SSL/TLS加密传输，配置步骤如下：

1. **生成SSL证书**

```bash
# 生成私钥
openssl genrsa -out server.key 2048

# 生成证书签名请求
openssl req -new -key server.key -out server.csr

# 生成自签名证书
openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt
```

2. **配置SSL**

```ini
[network]
# 启用SSL
enable_ssl = YES

# SSL证书文件
ssl_cert = server.crt

# SSL私钥文件
ssl_key = server.key

# SSL CA证书文件（可选）
ssl_ca = ca.crt
```

3. **使用SSL连接**

```bash
sqlcc-client --host localhost --port 3306 --ssl
```

### 7.3 审计日志

启用审计日志可以记录所有用户操作，便于安全审计：

```ini
[logging]
# 启用审计日志
enable_audit_log = YES

# 审计日志文件
audit_log_file = logs/audit.log

# 审计日志级别：all, ddl, dml, dcl, admin
audit_log_level = all
```

## 8. 监控和维护

### 8.1 日志监控

SQLCC的日志文件位于`logs/`目录下，主要包括：

- `sqlcc.log` - 主日志文件
- `audit.log` - 审计日志文件（如果启用）
- `error.log` - 错误日志文件

### 8.2 性能监控

#### 8.2.1 内置监控命令

```sql
-- 查看服务器状态
SHOW STATUS;

-- 查看变量配置
SHOW VARIABLES;

-- 查看进程列表
SHOW PROCESSLIST;

-- 查看连接统计
SHOW STATUS LIKE 'Connections%';

-- 查看查询统计
SHOW STATUS LIKE 'Queries%';
```

#### 8.2.2 外部监控工具

可以使用以下外部工具监控SQLCC：

- **Prometheus** - 监控系统和时间序列数据库
- **Grafana** - 可视化监控数据
- **Zabbix** - 企业级监控解决方案
- **Nagios** - 网络监控和警报系统

### 8.3 定期维护

#### 8.3.1 数据备份

```bash
# 物理备份（停止服务器）
cp -r data/ data_backup_$(date +%Y%m%d)/

# 逻辑备份（使用客户端工具）
sqlcc-client --host localhost --port 3306 --user root --password --database test_db > test_db_backup.sql
```

#### 8.3.2 数据恢复

```bash
# 物理恢复
cp -r data_backup_$(date +%Y%m%d)/ data/

# 逻辑恢复
sqlcc-client --host localhost --port 3306 --user root --password --database test_db < test_db_backup.sql
```

#### 8.3.3 索引优化

```sql
-- 重建索引
ALTER TABLE users REBUILD INDEX idx_users_name;

-- 优化表
OPTIMIZE TABLE users;
```

#### 8.3.4 日志清理

```bash
# 清理旧日志
find logs/ -name "*.log" -mtime +7 -delete

# 清理二进制日志
PURGE BINARY LOGS BEFORE '2025-11-01 00:00:00';
```

## 9. 故障排除

### 9.1 常见问题及解决方案

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 服务器无法启动 | 端口被占用、配置文件错误、数据目录权限问题 | 检查端口占用情况、验证配置文件、检查数据目录权限 |
| 客户端无法连接 | 服务器未运行、防火墙阻止、网络问题 | 检查服务器状态、配置防火墙规则、检查网络连接 |
| 性能下降 | 索引设计不合理、查询语句优化不足、资源不足 | 优化索引、优化查询语句、增加资源 |
| 数据丢失 | 未启用日志、备份不及时、硬件故障 | 启用二进制日志、定期备份、使用RAID存储 |
| 死锁 | 事务设计不合理、并发度过高 | 优化事务设计、降低并发度、增加死锁检测频率 |

### 9.2 日志分析

```bash
# 查看错误日志
grep -i error logs/sqlcc.log

# 查看慢查询
grep -i slow logs/sqlcc.log

# 查看连接错误
grep -i connection logs/sqlcc.log
```

## 10. 升级和迁移

### 10.1 版本升级

1. **备份数据**

```bash
# 备份数据目录
cp -r data/ data_backup_$(date +%Y%m%d)/

# 备份配置文件
cp config.ini config_backup_$(date +%Y%m%d).ini
```

2. **停止服务器**

```bash
# 查找进程ID
PID=$(ps aux | grep sqlcc-server | grep -v grep | awk '{print $2}')

# 停止进程
kill $PID
```

3. **升级软件**

```bash
# 拉取最新代码
git pull origin main

# 重新编译安装
cd build
cmake ..
make -j4
sudo make install
```

4. **启动服务器**

```bash
sqlcc-server --config config.ini --daemon
```

5. **验证升级**

```bash
# 检查版本
sqlcc-server --version

# 运行测试
sqlcc-client --host localhost --port 3306 -e "SELECT 1;"
```

### 10.2 数据迁移

#### 10.2.1 从其他数据库迁移

可以使用以下工具从其他数据库迁移数据到SQLCC：

- **mysqldump** - 从MySQL迁移数据
- **pg_dump** - 从PostgreSQL迁移数据
- **Oracle Data Pump** - 从Oracle迁移数据

#### 10.2.2 示例：从MySQL迁移

```bash
# 从MySQL导出数据
mysqldump -h mysql_host -P 3306 -u mysql_user -p mysql_db > mysql_backup.sql

# 转换SQL语法（如果需要）
# ...

# 导入到SQLCC
sqlcc-client --host localhost --port 3306 -u root -p test_db < mysql_backup.sql
```

## 11. 最佳实践

### 11.1 配置最佳实践

- 根据部署环境调整配置参数
- 生产环境建议使用专用的配置文件
- 定期备份配置文件
- 使用版本控制管理配置文件

### 11.2 性能最佳实践

- 为频繁查询的列创建索引
- 优化查询语句，避免全表扫描
- 合理设置缓冲池大小
- 定期清理无用数据
- 监控系统性能，及时调整配置

### 11.3 安全最佳实践

- 使用强密码
- 限制用户访问权限
- 启用SSL/TLS加密传输
- 启用审计日志
- 定期更新软件版本

### 11.4 高可用最佳实践

- 部署集群环境
- 启用复制和备份
- 配置自动故障转移
- 定期测试故障恢复流程
- 监控系统状态，及时发现问题

## 12. 附录

### 12.1 配置文件示例

完整的配置文件示例可以参考`config.ini.example`文件。

### 12.2 命令行参数

#### 12.2.1 服务器命令行参数

| 参数 | 描述 | 默认值 |
|------|------|--------|
| --config | 指定配置文件 | config.ini |
| --daemon | 后台运行 | 否 |
| --version | 显示版本信息 | 否 |
| --help | 显示帮助信息 | 否 |

#### 12.2.2 客户端命令行参数

| 参数 | 描述 | 默认值 |
|------|------|--------|
| --host | 服务器地址 | localhost |
| --port | 服务器端口 | 3306 |
| --user | 用户名 | root |
| --password | 密码 | 空 |
| --database | 数据库名称 | 无 |
| --ssl | 启用SSL连接 | 否 |
| --version | 显示版本信息 | 否 |
| --help | 显示帮助信息 | 否 |

### 12.3 端口占用检查

```bash
# 检查端口是否被占用
netstat -tuln | grep 3306

# 或使用lsof
lsof -i :3306
```

### 12.4 常见错误代码

| 错误代码 | 描述 | 解决方案 |
|----------|------|----------|
| 1001 | 端口被占用 | 更换端口或停止占用端口的进程 |
| 1002 | 数据目录不存在 | 创建数据目录 |
| 1003 | 配置文件错误 | 检查配置文件语法 |
| 2001 | 无法连接到服务器 | 检查服务器是否运行 |
| 2002 | 访问被拒绝 | 检查用户名和密码 |
| 3001 | 事务死锁 | 重试事务 |
| 4001 | 表不存在 | 检查表名是否正确 |
| 4002 | 列不存在 | 检查列名是否正确 |

通过本部署和配置指南，您应该能够成功部署和配置SQLCC数据库管理系统。如果您有任何问题或建议，请随时联系我们。