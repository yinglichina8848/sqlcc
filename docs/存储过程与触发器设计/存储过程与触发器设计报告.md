# SQLCC存储过程与触发器设计报告

## 1. 概述

本报告详细设计了为SQLCC数据库系统添加存储过程和触发器功能的方案。存储过程和触发器是数据库系统的重要组成部分，它们可以提高数据库操作的性能、安全性和可维护性。

## 2. 需求分析

### 2.1 存储过程需求
- 支持创建、删除、修改和执行存储过程
- 支持参数传递（输入参数、输出参数、输入输出参数）
- 支持变量声明和使用
- 支持流程控制语句（IF-ELSE、WHILE、LOOP等）
- 支持异常处理
- 支持递归调用

### 2.2 触发器需求
- 支持创建、删除和修改触发器
- 支持DML触发器（INSERT、UPDATE、DELETE）
- 支持BEFORE和AFTER触发时机
- 支持行级和语句级触发
- 支持触发条件
- 支持NEW和OLD伪记录

## 3. 架构改进

### 3.1 总体架构调整

需要对SQLCC的总体架构进行以下调整：

1. **SQL解析器扩展**：
   - 添加存储过程和触发器的语法解析
   - 扩展Token类型系统，支持相关关键字
   - 扩展AST节点，支持存储过程和触发器的语法结构

2. **SQL执行引擎扩展**：
   - 添加存储过程执行器
   - 添加触发器管理器
   - 扩展执行上下文，支持存储过程变量和参数

3. **系统数据库扩展**：
   - 完善sys_procedures表，存储存储过程元数据
   - 完善sys_triggers表，存储触发器元数据
   - 添加存储过程代码存储表

4. **事务管理器扩展**：
   - 支持存储过程中的事务控制
   - 确保触发器执行的原子性

### 3.2 核心组件设计

#### 3.2.1 存储过程管理组件

```
+------------------+
| ProcedureManager |
+------------------+
| - createProcedure() |
| - dropProcedure() |
| - alterProcedure() |
| - executeProcedure() |
| - getProcedureMetadata() |
+------------------+
```

#### 3.2.2 触发器管理组件

```
+------------------+
| TriggerManager   |
+------------------+
| - createTrigger() |
| - dropTrigger() |
| - alterTrigger() |
| - fireTriggers() |
| - getTriggersForEvent() |
+------------------+
```

#### 3.2.3 存储过程执行上下文

```
+------------------+
| ProcedureContext |
+------------------+
| - variables      |
| - parameters     |
| - returnValue    |
| - executionStack |
+------------------+
```

## 4. 详细设计

### 4.1 SQL语法扩展

#### 4.1.1 存储过程语法

```sql
-- 创建存储过程
CREATE PROCEDURE proc_name(IN param1 type1, OUT param2 type2) AS
BEGIN
    -- 存储过程体
    DECLARE var1 type3;
    SET var1 = param1 * 2;
    SET param2 = var1 + 1;
    
    IF var1 > 10 THEN
        SELECT * FROM table1 WHERE column1 = var1;
    ELSE
        INSERT INTO table2 VALUES (var1, 'value');
    END IF;
END;

-- 执行存储过程
CALL proc_name(5, @result);
SELECT @result;
```

#### 4.1.2 触发器语法

```sql
-- 创建触发器
CREATE TRIGGER trigger_name
BEFORE INSERT ON table_name
FOR EACH ROW
BEGIN
    IF NEW.column1 < 0 THEN
        SET NEW.column1 = 0;
    END IF;
END;

-- 禁用触发器
ALTER TRIGGER trigger_name DISABLE;

-- 启用触发器
ALTER TRIGGER trigger_name ENABLE;
```

### 4.2 AST节点扩展

#### 4.2.1 存储过程AST节点

```cpp
// 存储过程定义节点
class ProcedureDefinitionNode : public ASTNode {
public:
    std::string name;
    std::vector<ProcedureParameter> parameters;
    std::vector<StatementNode*> body;
    // 方法...
};

// 存储过程调用节点
class ProcedureCallNode : public ASTNode {
public:
    std::string name;
    std::vector<ExpressionNode*> arguments;
    // 方法...
};

// 变量声明节点
class VariableDeclarationNode : public ASTNode {
public:
    std::string name;
    std::string type;
    ExpressionNode* defaultValue;
    // 方法...
};

// 流程控制节点
class IfStatementNode : public ASTNode {
public:
    ExpressionNode* condition;
    std::vector<StatementNode*> thenBranch;
    std::vector<StatementNode*> elseBranch;
    // 方法...
};
```

#### 4.2.2 触发器AST节点

```cpp
// 触发器定义节点
class TriggerDefinitionNode : public ASTNode {
public:
    std::string name;
    TriggerTiming timing; // BEFORE, AFTER
    TriggerEvent event;   // INSERT, UPDATE, DELETE
    TriggerLevel level;   // ROW, STATEMENT
    std::string tableName;
    ExpressionNode* condition;
    std::vector<StatementNode*> body;
    // 方法...
};
```

### 4.3 执行引擎扩展

#### 4.3.1 存储过程执行器

```cpp
class ProcedureExecutor {
public:
    ExecutionResult execute(ProcedureDefinitionNode* proc, 
                           const std::vector<Value>& arguments,
                           ProcedureContext& context);
    
private:
    void executeStatement(StatementNode* stmt, ProcedureContext& context);
    void executeIfStatement(IfStatementNode* ifStmt, ProcedureContext& context);
    void executeWhileStatement(WhileStatementNode* whileStmt, ProcedureContext& context);
    // 其他执行方法...
};
```

#### 4.3.2 触发器管理器

```cpp
class TriggerManager {
public:
    void registerTrigger(TriggerDefinitionNode* trigger);
    void unregisterTrigger(const std::string& name);
    void fireTriggers(TriggerEvent event, const Table& table,
                     const std::vector<Row>& oldRows,
                     const std::vector<Row>& newRows);
    
private:
    std::vector<TriggerDefinitionNode*> getTriggersForEvent(TriggerEvent event, 
                                                           const std::string& tableName);
    void executeTrigger(TriggerDefinitionNode* trigger, 
                       const Row* oldRow, const Row* newRow);
};
```

### 4.4 系统表设计

#### 4.4.1 存储过程相关表

**sys_procedures表**
| 列名 | 类型 | 描述 |
|------|------|------|
| procedure_id | INT | 存储过程ID |
| name | VARCHAR(128) | 存储过程名称 |
| schema_id | INT | 所属模式ID |
| definition | TEXT | 存储过程定义 |
| created_at | TIMESTAMP | 创建时间 |
| modified_at | TIMESTAMP | 修改时间 |
| definer | VARCHAR(64) | 定义者 |
| security_type | VARCHAR(16) | 安全类型（DEFINER, INVOKER） |

**sys_procedure_parameters表**
| 列名 | 类型 | 描述 |
|------|------|------|
| parameter_id | INT | 参数ID |
| procedure_id | INT | 所属存储过程ID |
| name | VARCHAR(128) | 参数名称 |
| type | VARCHAR(64) | 参数类型 |
| mode | VARCHAR(8) | 参数模式（IN, OUT, INOUT） |
| position | INT | 参数位置 |

#### 4.4.2 触发器相关表

**sys_triggers表**
| 列名 | 类型 | 描述 |
|------|------|------|
| trigger_id | INT | 触发器ID |
| name | VARCHAR(128) | 触发器名称 |
| table_id | INT | 所属表ID |
| timing | VARCHAR(8) | 触发时机（BEFORE, AFTER） |
| event | VARCHAR(16) | 触发事件（INSERT, UPDATE, DELETE） |
| level | VARCHAR(16) | 触发级别（ROW, STATEMENT） |
| condition | TEXT | 触发条件 |
| definition | TEXT | 触发器定义 |
| created_at | TIMESTAMP | 创建时间 |
| modified_at | TIMESTAMP | 修改时间 |
| definer | VARCHAR(64) | 定义者 |
| status | VARCHAR(16) | 状态（ENABLED, DISABLED） |

## 5. 实现路线图

### 5.1 第一阶段：基础框架
1. 扩展SQL解析器，支持存储过程和触发器的语法解析
2. 扩展AST节点，支持存储过程和触发器的语法结构
3. 完善系统表，存储存储过程和触发器元数据

### 5.2 第二阶段：核心功能
1. 实现存储过程的创建、删除和修改功能
2. 实现存储过程的执行功能
3. 实现触发器的创建、删除和修改功能
4. 实现触发器的触发机制

### 5.3 第三阶段：高级功能
1. 支持存储过程参数传递
2. 支持变量声明和使用
3. 支持流程控制语句
4. 支持异常处理
5. 支持递归调用

### 5.4 第四阶段：优化和测试
1. 优化存储过程和触发器的执行性能
2. 完善错误处理机制
3. 进行全面的测试和验证

## 6. 测试策略

### 6.1 单元测试
- 测试存储过程和触发器的语法解析
- 测试存储过程和触发器的元数据管理
- 测试存储过程的执行逻辑
- 测试触发器的触发机制

### 6.2 集成测试
- 测试存储过程在事务中的行为
- 测试触发器与事务的交互
- 测试存储过程和触发器的组合使用

### 6.3 性能测试
- 测试存储过程的执行性能
- 测试触发器对DML操作的性能影响
- 测试高并发下的表现

### 6.4 边界测试
- 测试递归存储过程的最大深度
- 测试触发器的嵌套调用
- 测试存储过程的参数传递边界情况

## 7. 总结

本设计方案详细说明了如何为SQLCC数据库系统添加存储过程和触发器功能。通过扩展SQL解析器、执行引擎和系统表，可以实现完整的存储过程和触发器支持。该方案具有良好的可扩展性和可维护性，能够满足教学和实验需求。