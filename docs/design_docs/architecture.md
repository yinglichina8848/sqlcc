# SQLCC 架构设计文档

## 1. 系统概述

SQLCC 是一个教学用的微型数据库系统，旨在帮助学生从零开始理解数据库系统的原理和实现。该系统包含了数据库管理系统的核心组件，包括SQL解析器、执行引擎、存储引擎、事务管理器等。

## 2. 架构概览

```
+---------------------------------------------------------------+
|                        应用层                                  |
|  +------------------+  +------------------+  +----------------+ |
|  |   CLI客户端      |  +   网络客户端     |  |   应用程序      | |
|  +------------------+  +------------------+  +----------------+ |
+-----------+----------------------------------------+----------+
            |                                        |
+-----------v----------------------------------------v----------+
|                       接口层                                   |
|  +------------------+  +------------------+  +----------------+ |
|  |   SQL解析器      |  |   SQL执行引擎     |  |   系统数据库    | |
|  +------------------+  +------------------+  +----------------+ |
+-----------+-------------------+--------------------+----------+
            |                   |                    |
+-----------v-------------------v--------------------v----------+
|                       核心层                                   |
|  +------------------+  +------------------+  +----------------+ |
|  |   存储引擎       |  |   事务管理器      |  |   配置管理器    | |
|  +------------------+  +------------------+  +----------------+ |
+-----------+-------------------+--------------------+----------+
            |                   |                    |
+-----------v-------------------v--------------------v----------+
|                       基础设施层                                |
|  +------------------+  +------------------+  +----------------+ |
|  |   日志系统       |  |   网络通信        |  |   工具库        | |
|  +------------------+  +------------------+  +----------------+ |
+---------------------------------------------------------------+
```

## 3. 模块详解

### 3.1 SQL解析器(SQL Parser)

SQL解析器负责将SQL文本解析成抽象语法树(AST)，包括词法分析和语法分析两个阶段。

#### 3.1.1 组件
- **词法分析器(Lexer)**: 将SQL文本分解为标记(Token)流
- **语法分析器(Parser)**: 将Token流构建成抽象语法树(AST)
- **抽象语法树(AST)**: SQL语句的结构化表示

#### 3.1.2 支持的SQL语句
- DDL: CREATE DATABASE/TABLE/INDEX, ALTER, DROP等
- DML: INSERT, UPDATE, DELETE
- DQL: SELECT (支持JOIN, WHERE, GROUP BY, ORDER BY等)
- DCL: CREATE USER, DROP USER, GRANT, REVOKE

### 3.2 SQL执行引擎(SQL Executor)

SQL执行引擎负责将抽象语法树转换为实际的数据库操作，是整个系统的调度中心。

#### 3.2.1 组件
- **语句执行器**: 执行各种类型的SQL语句
- **约束执行器**: 执行各种约束检查
- **元数据管理器**: 管理表结构和其他元数据
- **系统数据库接口**: 与系统数据库交互，管理所有元数据

#### 3.2.2 功能
- 协调各种SQL语句的执行
- 管理表元数据
- 执行约束验证
- 与存储引擎和事务管理器交互

### 3.3 系统数据库(System Database)

系统数据库是SQLCC的元数据管理中心，负责存储和管理所有数据库对象的信息。

#### 3.3.1 组件
- **系统表管理器**: 管理所有系统表的创建和维护
- **元数据操作接口**: 提供元数据的增删改查接口
- **初始化模块**: 负责系统数据库的初始化

#### 3.3.2 系统表
- sys_databases: 数据库元数据
- sys_users: 用户元数据
- sys_roles: 角色元数据
- sys_tables: 表元数据
- sys_columns: 列元数据
- sys_indexes: 索引元数据
- sys_constraints: 约束元数据
- sys_views: 视图元数据
- sys_procedures: 存储过程元数据
- sys_triggers: 触发器元数据
- sys_privileges: 权限元数据
- sys_audit_logs: 审计日志元数据
- sys_audit_policies: 审计策略元数据
- sys_transactions: 事务元数据
- sys_savepoints: 保存点元数据
- sys_cluster_nodes: 集群节点元数据
- sys_distributed_transactions: 分布式事务元数据
- sys_distributed_objects: 分布式对象元数据
- sys_temporal_tables: 时态表元数据

#### 3.3.3 特点
- 自包含: 所有元数据都存储在数据库表中
- 持久化: 元数据在系统重启后不会丢失
- 一致性: 所有元数据操作都通过标准SQL执行
- 可查询: 可以通过标准SQL查询系统信息

#### 3.3.4 SQL标准兼容性
系统数据库设计充分考虑了SQL标准的发展历程，从SQL-92到SQL:2019，确保系统具备良好的标准兼容性：
- **SQL-92兼容性**: 支持基本的元数据管理、用户权限管理等核心功能
- **SQL:1999兼容性**: 为用户定义类型和对象关系特性预留扩展空间
- **SQL:2003兼容性**: 支持事务管理、保存点等高级事务特性
- **SQL:2011兼容性**: 为时态数据库支持做好准备
- **SQL:2016/2019兼容性**: 支持JSON/XML数据类型和分区管理

### 3.4 存储引擎(Storage Engine)

存储引擎负责数据的物理存储和检索，是数据库系统的底层支撑。

#### 3.4.1 组件
- **缓冲池(Buffer Pool)**: 管理内存中的页面缓存
- **磁盘管理器(Disk Manager)**: 管理磁盘上的文件和页面
- **页面管理(Page Manager)**: 管理页面的格式和操作
- **记录管理器(Record Manager)**: 管理记录的存储和检索

#### 3.4.2 特性
- 8KB定长页式文件管理
- 支持空间管理和定/变长记录处理
- LRU页面替换算法
- 支持并发访问

### 3.5 事务管理器(Transaction Manager)

事务管理器负责维护数据库的ACID属性，确保数据的一致性和可靠性。

#### 3.5.1 组件
- **事务管理(Transaction Management)**: 管理事务的生命周期
- **锁管理器(Lock Manager)**: 管理并发控制和锁定
- **日志管理器(Log Manager)**: 管理事务日志(WAL)

#### 3.5.2 特性
- ACID属性保证
- WAL预写日志
- 两阶段锁协议(2PL)
- 死锁检测与预防

### 3.6 配置管理器(Config Manager)

配置管理器负责管理系统的配置信息。

#### 3.6.1 组件
- **配置加载器**: 从配置文件加载配置
- **配置观察者**: 监听配置变化并通知相关组件

#### 3.6.2 特性
- 支持配置热更新
- 观察者模式实现配置变更通知

## 4. 数据流

### 4.1 查询处理流程

```
1. 应用层提交SQL语句
2. SQL解析器解析SQL文本为AST
3. SQL执行引擎接收AST并进行语义分析
4. 执行引擎通过系统数据库获取元数据
5. 执行引擎协调存储引擎和事务管理器执行操作
6. 存储引擎进行实际的数据读写操作
7. 事务管理器保证操作的ACID属性
8. 结果返回给应用层
```

### 4.2 元数据管理流程

```
1. 系统启动时初始化系统数据库
2. DDL操作通过SQL执行引擎修改元数据
3. 元数据变更通过系统数据库持久化到系统表
4. 其他操作通过系统数据库查询所需元数据
```

## 5. 并发控制

### 5.1 多线程安全
- 核心组件设计为线程安全
- 使用互斥锁保护共享资源
- 事务管理器实现两阶段锁协议

### 5.2 死锁处理
- 实现死锁检测机制
- 支持死锁预防策略
- 提供死锁超时机制

## 6. 容错与恢复

### 6.1 日志系统
- 实现WAL(Write-Ahead Logging)机制
- 支持事务回滚和系统恢复
- 提供检查点机制

### 6.2 异常处理
- 完善的异常处理机制
- 详细的错误信息记录
- 支持优雅降级

## 7. 性能优化

### 7.1 存储优化
- 页面缓存机制
- LRU页面替换算法
- 批量操作支持

### 7.2 查询优化
- 索引支持(B+树)
- 查询计划优化(待实现)
- 连接算法优化(待实现)

## 8. 安全性

### 8.1 用户认证
- 用户账户管理
- 密码哈希存储
- 登录验证机制

### 8.2 权限控制
- 基于角色的访问控制(RBAC)
- 细粒度权限管理
- 权限继承机制

### 8.3 审计功能
- 操作日志记录
- 审计策略管理
- 合规性支持

## 9. 扩展性设计

### 9.1 模块化设计
- 各组件之间松耦合
- 明确的接口定义
- 支持插件化扩展

### 9.2 可扩展组件
- 存储引擎支持多种实现
- 索引支持多种数据结构
- 查询优化器可替换

## 10. SQL标准兼容性发展路线

### 10.1 当前状态（SQL-92级别）
- 基本的元数据管理功能
- 用户和权限管理
- 表、列、索引、约束管理

### 10.2 近期目标（SQL:1999/2003级别）
- 增强审计功能
- 完善事务管理
- 支持保存点

### 10.3 中期目标（SQL:2008/2011级别）
- 支持时态数据库
- 增强分布式支持

### 10.4 长期目标（SQL:2016/2019级别）
- 支持JSON/XML数据类型
- 完善分区管理
- 支持高级分析功能

## 11. 分布式支持规划

### 11.1 架构设计
- 支持集群部署
- 节点间通信机制
- 分布式事务处理

### 11.2 数据分片
- 水平分片策略
- 数据复制机制
- 一致性保障

### 11.3 故障恢复
- 节点故障检测
- 自动故障转移
- 数据恢复机制

## 12. 未来发展方向

### 12.1 功能增强
- 更复杂的SQL语句支持
- 存储过程和触发器
- 视图和物化视图
- 分区表支持

### 12.2 性能优化
- 查询优化器
- 并行查询处理
- 分布式架构支持

### 12.3 系统增强
- 更完善的监控和诊断工具
- 备份和恢复机制
- 高可用性支持