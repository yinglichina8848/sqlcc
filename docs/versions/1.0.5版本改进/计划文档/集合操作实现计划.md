# 集合操作实现计划

## 版本概述
- **项目版本**: v1.0.5
- **计划版本**: v1.0.6
- **功能模块**: SQL查询引擎 - 集合操作支持
- **优先级**: 高

## 当前状态分析

### 现有功能
1. **基础SQL支持**: SELECT、INSERT、UPDATE、DELETE等基础DML操作
2. **查询功能**: WHERE、GROUP BY、ORDER BY等基本查询子句
3. **表约束**: PRIMARY KEY、FOREIGN KEY、UNIQUE、CHECK约束
4. **DDL支持**: CREATE、DROP、ALTER等数据定义语句

### 缺失功能
1. **集合操作**: UNION、INTERSECT、EXCEPT操作符
2. **复杂查询**: 子查询、多表连接等高级查询功能

### 技术架构现状
- SQL解析器：基于自定义词法分析器和语法解析器
- AST结构：已定义基础语句节点，但缺少集合操作节点
- 执行引擎：支持基础查询执行，但缺少集合操作执行逻辑

## 改进目标

### 主要目标
1. 实现UNION、UNION ALL、INTERSECT、EXCEPT集合操作
2. 支持集合操作的语法解析和AST构建
3. 实现集合操作的查询执行引擎
4. 提供完整的测试用例和性能优化

### 次要目标
1. 支持集合操作与现有查询功能的组合使用
2. 提供错误处理和数据验证机制
3. 优化集合操作的执行效率

## 阶段划分

### 第一阶段：语法扩展和AST设计（预计2周）
- 扩展SQL解析器支持集合操作语法
- 设计集合操作相关的AST节点结构
- 实现语法解析和AST构建逻辑

### 第二阶段：执行引擎实现（预计3周）
- 设计集合操作执行策略
- 实现UNION/UNION ALL操作执行器
- 实现INTERSECT/EXCEPT操作执行器
- 集成到现有执行引擎

### 第三阶段：测试和优化（预计2周）
- 编写单元测试和集成测试
- 性能测试和优化
- 错误处理和边界条件测试

### 第四阶段：文档和集成（预计1周）
- 更新API文档和用户手册
- 集成到主分支
- 发布版本更新

## 技术方案设计

### AST节点扩展
```cpp
class SetOperationStatement : public Statement {
public:
    enum OperationType {
        UNION,
        UNION_ALL,
        INTERSECT,
        EXCEPT
    };
    
    SetOperationStatement(OperationType op, 
                         std::unique_ptr<SelectStatement> left,
                         std::unique_ptr<SelectStatement> right);
    // ... 其他方法
};
```

### 执行策略
1. **UNION/UNION ALL**: 合并结果集，去除重复（UNION）或保留重复（UNION ALL）
2. **INTERSECT**: 求两个结果集的交集
3. **EXCEPT**: 求第一个结果集减去第二个结果集的差集

### 数据兼容性处理
- 列类型匹配和转换
- 列名统一处理
- NULL值处理

## 风险评估

### 技术风险
1. **性能问题**: 集合操作可能涉及大量数据，需要优化执行策略
2. **内存消耗**: 大结果集的内存管理需要谨慎处理
3. **兼容性问题**: 与现有功能的集成可能产生冲突

### 缓解措施
1. 分阶段实现，逐步验证
2. 使用迭代器模式减少内存占用
3. 充分测试与现有功能的兼容性

## 成功标准

### 功能标准
1. ✅ 支持所有四种集合操作语法
2. ✅ 正确解析和执行集合操作查询
3. ✅ 与现有查询功能无缝集成
4. ✅ 提供完整的错误处理

### 性能标准
1. ✅ 小数据集（<1000行）执行时间 < 100ms
2. ✅ 中等数据集（1000-10000行）执行时间 < 1s
3. ✅ 大数据集（>10000行）执行时间可接受

### 质量标准
1. ✅ 代码覆盖率 > 80%
2. ✅ 单元测试通过率 100%
3. ✅ 集成测试通过率 100%

## 迭代开发流程

### 每个阶段遵循以下流程：
1. **计划制定**: 明确阶段目标和任务分解
2. **技术设计**: 设计具体实现方案
3. **代码实现**: 编写和测试代码
4. **测试验证**: 执行测试用例，验证功能
5. **问题修正**: 修复发现的问题
6. **评估决策**: 评估是否达到阶段目标，决定是否进入下一阶段

### 文档要求
- 每个阶段需提供：计划文档、设计文档、测试报告、综合报告
- 所有文档保存在对应子目录中
- 使用标准化模板确保一致性

## 下一步行动

1. **立即开始**: 第一阶段 - 语法扩展和AST设计
2. **资源分配**: 分配开发人员负责不同模块
3. **时间安排**: 制定详细的时间表和里程碑
4. **沟通机制**: 建立定期进度汇报机制

---

**文档版本**: 1.0  
**创建日期**: 2024-01-20  
**最后更新**: 2024-01-20  
**负责人**: SQLCC开发团队