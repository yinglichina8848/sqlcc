name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake doxygen lcov

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Debug -DBUILD_TESTS=ON -DENABLE_COVERAGE=ON

    - name: Build
      run: cmake --build build

    - name: Run tests with coverage
      run: |
        cd build
        ctest --output-on-failure
        lcov --capture --directory . --output-file coverage.info
        lcov --remove coverage.info '/usr/*' '*/test/*' '*/tests/*' --output-file coverage.info
        genhtml coverage.info --output-directory coverage_report

    - name: Generate Doxygen documentation
      run: doxygen Doxyfile

    - name: Deploy documentation and coverage
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/doxygen/html
        publish_branch: gh-pages
        destination_dir: docs
        keep_files: false

    - name: Deploy coverage report
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./build/coverage_report
        publish_branch: gh-pages
        destination_dir: coverage
        keep_files: true
